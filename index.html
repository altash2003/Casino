<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASINO</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color:white; }
        .view-section { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; }
        .view-section.active { display: flex; }
        .global-back { position: fixed; top: 10px; left: 10px; z-index: 9000; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-weight: bold; display: none; }

        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: #111; border: 1px solid #333; padding: 40px; border-radius: 12px; text-align: center; width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; user-select: text; cursor: text; }
        .auth-btn { width: 100%; padding: 12px; background: #FFD700; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* ROULETTE STYLES */
        :root { --bg-felt: #01431E; --grid-gold: #F3C620; }
        #view-roulette { background-color: #05140a; background-image: radial-gradient(circle at 50% 50%, #012b13 0%, #000000 100%); flex-direction: column; overflow:hidden; }
        .r-main-area { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: filter 0.5s; }
        .r-main-area.blurred { filter: blur(5px) brightness(0.5); pointer-events: none; }

        .r-table-scaler { transform-origin: center center; display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; }
        .r-hud-container { width: 730px; display: flex; justify-content: space-between; margin-bottom: 10px; }
        .r-hud-box { background: #000; border-radius: 8px; padding: 10px 20px; width: 180px; text-align: center; }
        .hud-time { border: 2px solid #FFD700; transition: 0.2s; }
        .hud-time.urgent { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; background:#300; transform: scale(1.05); }
        .r-lbl { font-size: 10px; color: #888; font-weight: bold; letter-spacing: 1px; }
        .r-val { font-size: 28px; color: #fff; font-weight: 800; font-family: 'Oswald', sans-serif; }
        .urgent-text { color:#ff3d00; font-size:18px; letter-spacing:2px; font-weight:bold; }

        .r-table-wrapper { position: relative; background-color: var(--bg-felt); padding: 15px; border-radius: 20px; border: 10px solid #002b12; box-shadow: 0 0 0 5px #F3C620, 0 20px 50px black; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 730px; }
        .r-history { width: 622px; height: 30px; background: rgba(0,0,0,0.3); border-radius: 4px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; margin-bottom: 5px; box-sizing: border-box; }
        .hist-ball { width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 9px; box-shadow: 0 2px 4px black; flex-shrink: 0; }
        .hist-red { background: #d32f2f; } .hist-black { background: #222; } .hist-green { background: #016D29; } 
        .hist-empty { background: transparent; }
        .hist-blank-circle { width:100%; height:100%; border-radius:50%; opacity:0.3; }

        .r-grid { display: grid; grid-template-columns: 50px repeat(12, 42px) 34px; grid-template-rows: repeat(3, 42px) 42px 42px; gap: 2px; padding: 5px; border: 2px solid var(--grid-gold); border-radius: 8px; background: rgba(0,0,0,0.2); position: relative; }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; cursor: pointer; border: 2px solid var(--grid-gold); position: relative; z-index:5; }
        .red-cell { background-color: #d32f2f; } .black-cell { background-color: #222; }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; border-radius: 10px 0 0 10px; }
        .zone-2to1 { grid-column: 14; writing-mode: vertical-rl; color: #F3C620; font-size: 9px; }
        .label-cell { font-size: 10px; text-transform: uppercase; }
        .zone-dozen { grid-row: 4; } .doz-1 { grid-column: 2 / 6; } .doz-2 { grid-column: 6 / 10; } .doz-3 { grid-column: 10 / 14; }
        .zone-bottom { grid-row: 5; } .low { grid-column: 2 / 4; } .even { grid-column: 4 / 6; } .odd { grid-column: 10 / 12; } .high { grid-column: 12 / 14; }
        .diamond-cell { grid-column: 6 / 8; grid-row: 5; display:flex; justify-content:center; align-items:center; } .diamond-cell.blk { grid-column: 8 / 10; }
        .diamond { width: 18px; height: 18px; transform: rotate(45deg); } .diamond.red { background: #d32f2f; } .diamond.black { background: #111; }

        .ghost-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .hotspot { position: absolute; z-index: 60; cursor: pointer; pointer-events: auto; background: transparent; }
        
        /* CHIPS */
        .chips-bar { display: flex; gap: 8px; padding: 6px 15px; background: rgba(0,0,0,0.4); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); align-items:center; width: fit-content; margin: 0 auto; }
        .chip { width: 34px; height: 34px; border-radius: 50%; position: relative; cursor: pointer; transition: transform 0.15s; box-shadow: 0 4px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .chip:hover { transform: scale(1.1); }
        .chip.active { transform: scale(1.15) translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.6); }
        .chip::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: repeating-conic-gradient(var(--c1) 0deg 15deg, var(--c2) 15deg 30deg, var(--c1) 30deg 45deg, var(--c3) 45deg 60deg); z-index: 1; }
        .chip::after { content: ''; position: absolute; inset: 4px; border-radius: 50%; background: var(--c1); border: 1px solid rgba(0,0,0,0.2); z-index: 2; }
        .chip-label { position: relative; z-index: 10; width: 18px; height: 18px; background: #fdfbf7; border-radius: 50%; border: 1px solid #d4d4d4; display: flex; justify-content: center; align-items: center; font-size: 8px; font-weight: 800; color: #333; }
        
        .chip-50 { --c1: #e0dfd5; --c2: #fff; --c3: #b0b0a8; }
        .chip-200 { --c1: #6b1818; --c2: #a32e2e; --c3: #3b0505; }
        .chip-1k { --c1: #1e4d2b; --c2: #367a48; --c3: #0d2613; }
        .chip-10k { --c1: #142850; --c2: #2c4d87; --c3: #050e21; }
        .chip-100k { --c1: #262626; --c2: #444; --c3: #000; }
        
        /* BOARD CHIP */
        .chip.chip-board { width: 32px; height: 32px; box-shadow: 0 3px 6px rgba(0,0,0,0.8); pointer-events: none; z-index: 200; }
        .chip.chip-board::after { inset: 4px; }
        .chip.chip-board .chip-label { width: 16px; height: 16px; font-size: 8px; border: 0.5px solid #ccc; }

        /* WINNING ANIMATION STAGE */
        #winner-stage { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 6000; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; opacity:0; transition:opacity 0.3s; backdrop-filter: blur(5px); }
        #winner-stage.active { display:flex; opacity:1; }
        
        .flying-cell { position: absolute; width: auto; min-width: 60px; padding: 0 10px; height: 60px; background: #222; border: 2px solid #FFD700; color: white; font-weight: bold; font-family: 'Oswald'; display: flex; justify-content: center; align-items: center; border-radius: 8px; box-shadow: 0 0 30px #FFD700; z-index: 6001; transition: all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size:20px; white-space:nowrap; }
        .flying-cell.red { background: #d32f2f; } .flying-cell.black { background: #222; } .flying-cell.green { background: #016D29; }
        
        .win-label { position:absolute; top:-35px; left:50%; transform:translateX(-50%); color:#00E5FF; font-weight:900; font-size:18px; text-shadow:0 1px 2px black; white-space:nowrap; opacity:0; animation: fadeUp 0.5s forwards 1s; }
        @keyframes fadeUp { to { top:-45px; opacity:1; } }

        .mario-coin { position:absolute; width:40px; height:40px; background:url('https://cdn-icons-png.flaticon.com/512/1292/1292744.png') center/cover; z-index:6002; display:none; }

        /* WHEEL */
        #wheel-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: 500px; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; transition: opacity 0.5s ease; }
        #wheel-overlay.show { display: flex; animation: fadeIn 0.3s; opacity: 1; }
        canvas { border-radius: 50%; width: 100%; height: 100%; object-fit: contain; }
        .pointer { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 36px solid #f0e6d2; z-index: 5005; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); }

        /* CONTROLS */
        .table-controls { display: flex; gap: 10px; margin-bottom: 5px; width: 100%; justify-content: center; }
        .t-btn { background: #111; border: 1px solid #444; color: #aaa; padding: 5px 12px; font-size: 10px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .t-btn:hover { background: #333; color: white; border-color: #FFD700; }
    </style>
</head>
<body>
    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:#FFD700;">CASINO LOGIN</h1>
            <input id="user" class="auth-input" placeholder="USERNAME">
            <input id="pass" class="auth-input" type="password" placeholder="PASSWORD">
            <button onclick="login()" class="auth-btn">ENTER</button>
            <button onclick="register()" class="auth-btn" style="background:transparent; border:1px solid #555; color:#aaa; font-size:12px;">REGISTER</button>
        </div>
    </div>

    <div id="view-roulette" class="view-section active">
        <div id="wheel-overlay"><div style="position:relative; width:400px; height:400px;"><div class="pointer"></div><canvas id="wheelCanvas" width="800" height="800"></canvas></div></div>
        <div id="winner-stage"></div>

        <div class="r-main-area">
            <div class="r-table-scaler" id="rWrapper">
                <div class="r-hud-container">
                    <div class="r-hud-box hud-bal"><div class="r-lbl">BALANCE</div><div class="r-val" id="r-balance">0</div></div>
                    <div class="r-hud-box hud-time" id="rTimerBox"><div class="r-lbl">TIMER</div><div class="r-val" id="r-timer">--</div></div>
                    <div class="r-hud-box hud-bet"><div class="r-lbl">BET</div><div class="r-val" id="r-bet-display">0</div></div>
                </div>

                <div class="r-table-wrapper">
                    <div class="r-history" id="rHistory"></div>
                    <div class="r-grid" id="grid">
                        <div class="ghost-overlay" id="ghostOverlay"></div>
                        <div style="position:absolute; inset:0; z-index:50; pointer-events:none;" id="rOverlay"></div>
                        <div class="cell zone-0" id="cell-0">0</div>
                        <div class="cell zone-2to1" style="grid-row:1" id="btn-row1">2to1</div>
                        <div class="cell zone-2to1" style="grid-row:2" id="btn-row2">2to1</div>
                        <div class="cell zone-2to1" style="grid-row:3" id="btn-row3">2to1</div>
                        <div class="cell label-cell zone-dozen doz-1" id="btn-doz1">1st 12</div>
                        <div class="cell label-cell zone-dozen doz-2" id="btn-doz2">2nd 12</div>
                        <div class="cell label-cell zone-dozen doz-3" id="btn-doz3">3rd 12</div>
                        <div class="cell label-cell zone-bottom low" id="btn-low">1-18</div>
                        <div class="cell label-cell zone-bottom even" id="btn-even">EVEN</div>
                        <div class="cell label-cell diamond-cell" id="btn-red"><div class="diamond red"></div></div>
                        <div class="cell label-cell diamond-cell blk" id="btn-black"><div class="diamond black"></div></div>
                        <div class="cell label-cell zone-bottom odd" id="btn-odd">ODD</div>
                        <div class="cell label-cell zone-bottom high" id="btn-high">19-36</div>
                    </div>
                    
                    <div class="table-controls">
                        <div class="t-btn" onclick="sendUndo()">UNDO</div>
                        <div class="t-btn" onclick="sendClear()">CLEAR</div>
                        <div class="t-btn" onclick="sendRebet()">REBET</div>
                        <div class="t-btn" onclick="sendX2()">x2</div>
                    </div>

                    <div class="chips-bar">
                        <div class="chip chip-50 active" onclick="setRChip(50, this)"><div class="chip-label">50</div></div>
                        <div class="chip chip-200" onclick="setRChip(200, this)"><div class="chip-label">200</div></div>
                        <div class="chip chip-1k" onclick="setRChip(1000, this)"><div class="chip-label">1K</div></div>
                        <div class="chip chip-10k" onclick="setRChip(10000, this)"><div class="chip-label">10K</div></div>
                        <div class="chip chip-100k" onclick="setRChip(100000, this)"><div class="chip-label">100K</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUser="Guest", myBal=0, rChip=50, isBettingLocked=false, currentTableScale=1;
        let lastRoundBets=[], currentRoundBets=[], rBetTotal=0;
        const tickSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
        const coinSound = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_2492742969.mp3");

        function login() { let u=document.getElementById('user').value, p=document.getElementById('pass').value; if(u&&p) socket.emit('login', {username:u, password:p}); }
        function register() { let u=document.getElementById('user').value, p=document.getElementById('pass').value; if(u&&p) socket.emit('register', {username:u, password:p}); }
        
        socket.on('login_success', (d) => { localStorage.setItem('u',d.username); document.getElementById('authOverlay').style.display='none'; myUser=d.username; myBal=d.balance; updateDisplay(); });
        socket.on('login_error', (m) => alert(m));
        if(localStorage.getItem('u')) document.getElementById('user').value = localStorage.getItem('u');

        socket.on('update_balance', (b) => { myBal = b; if(!document.querySelector('.mario-coin')) updateDisplay(); });
        function updateDisplay() { document.getElementById('r-balance').innerText = myBal; document.getElementById('r-bet-display').innerText = rBetTotal; }

        function setRChip(v, el) { rChip = v; document.querySelectorAll('.chips-bar .chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
        
        // --- GAME LOGIC ---
        const REDS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        function initRoulette() {
            let grid = document.getElementById('grid');
            if(document.getElementById('cell-1')) return;
            for(let i=1; i<=36; i++) {
                let d = document.createElement('div');
                d.className = `cell ${REDS.includes(i)?'red-cell':'black-cell'}`; d.innerText=i; d.id=`cell-${i}`;
                let row = (i%3===0)?1:(i%3===2?2:3); let col = Math.floor((i-1)/3)+2;
                d.style.gridRow=row; d.style.gridColumn=col; grid.appendChild(d);
            }
            initHistory(); buildHotspots(); drawWheel(0); scaleRoulette();
            window.addEventListener('resize', scaleRoulette);
        }
        function initHistory() {
            let h = document.getElementById('rHistory'); h.innerHTML='';
            for(let i=0; i<23; i++) {
                let b = document.createElement('div'); b.className='hist-ball hist-empty';
                let inner = document.createElement('div'); let rc = Math.floor(Math.random()*37);
                inner.className = `hist-blank-circle ${rc===0?'hist-green':(REDS.includes(rc)?'hist-red':'hist-black')}`;
                b.appendChild(inner); h.appendChild(b);
            }
        }
        function buildHotspots() {
            const overlay = document.getElementById('ghostOverlay'); overlay.innerHTML='';
            const CW=42, CH=42, GAP=2, OFFX=50+5+GAP, OFFY=5; 
            function addZone(x,y,w,h,n) {
                let el = document.createElement('div'); el.className='hotspot';
                el.style.left=x+'px'; el.style.top=y+'px'; el.style.width=w+'px'; el.style.height=h+'px';
                el.onclick = () => placeBet(x+w/2, y+h/2, n);
                overlay.appendChild(el);
            }
            for(let c=0; c<12; c++) {
                let x = OFFX+(c*(CW+GAP)); let nT=c*3+3, nM=c*3+2, nB=c*3+1;
                addZone(x+8, OFFY+8, CW-16, CH-16, [nT]); addZone(x+8, OFFY+CH+GAP+8, CW-16, CH-16, [nM]); addZone(x+8, OFFY+(CH+GAP)*2+8, CW-16, CH-16, [nB]);
                addZone(x, OFFY+CH-6, CW, 12, [nT, nM]); addZone(x, OFFY+(CH*2)+GAP-6, CW, 12, [nM, nB]); addZone(x, OFFY-10, CW, 15, [nB, nM, nT]);
                if(c<11) {
                    let bX = x+CW-6;
                    addZone(bX, OFFY, 12, CH, [nT, nT+3]); addZone(bX, OFFY+CH+GAP, 12, CH, [nM, nM+3]); addZone(bX, OFFY+(CH+GAP)*2, 12, CH, [nB, nB+3]);
                    addZone(bX, OFFY+CH-6, 12, 12, [nT, nM, nT+3, nM+3]); addZone(bX, OFFY+(CH*2)+GAP-6, 12, 12, [nM, nB, nM+3, nB+3]);
                    addZone(bX, OFFY-10, 12, 15, [nB, nM, nT, nB+3, nM+3, nT+3]);
                }
            }
            addZone(5, 5, 50, (CH+GAP)*3, [0]);
            bindBtn('btn-red', REDS); bindBtn('btn-black', range(1,36).filter(x=>!REDS.includes(x)));
            bindBtn('btn-even', range(1,36).filter(x=>x%2===0)); bindBtn('btn-odd', range(1,36).filter(x=>x%2!==0));
            bindBtn('btn-low', range(1,18)); bindBtn('btn-high', range(19,36));
            bindBtn('btn-doz1', range(1,12)); bindBtn('btn-doz2', range(13,24)); bindBtn('btn-doz3', range(25,36));
            bindBtn('btn-row1', range(1,36).filter(x=>x%3===0)); bindBtn('btn-row2', range(1,36).filter(x=>x%3===2)); bindBtn('btn-row3', range(1,36).filter(x=>x%3===1));
        }
        function bindBtn(id, nums) { let el=document.getElementById(id); if(el) el.onclick = () => placeBet(el.offsetLeft+el.offsetWidth/2, el.offsetTop+el.offsetHeight/2, nums); }
        function range(s,e) { return Array.from({length:e-s+1},(_,i)=>s+i); }

        function placeBet(x,y,nums) {
            if(isBettingLocked || myBal < rChip) return;
            myBal -= rChip; rBetTotal += rChip; updateDisplay();
            currentRoundBets.push({ nums: nums, amount: rChip, x: x, y: y });
            let sty = 'chip-50'; if(rChip===200) sty='chip-200'; if(rChip===1000) sty='chip-1k'; if(rChip===10000) sty='chip-10k'; if(rChip===100000) sty='chip-100k';
            let mk = document.createElement('div'); mk.className=`chip chip-board ${sty}`;
            mk.innerHTML=`<div class="chip-label">${fmt(rChip)}</div>`;
            mk.style.left=x+'px'; mk.style.top=y+'px'; mk.style.transform='translate(-50%,-50%)';
            document.getElementById('rOverlay').appendChild(mk);
            socket.emit('place_bet_roulette', { numbers: nums, amount: rChip });
        }
        function fmt(v){ return v>=1000 ? (v/1000)+'k' : v; }
        
        function sendUndo() { if(!isBettingLocked) socket.emit('roulette_undo'); }
        function sendClear() { if(!isBettingLocked) socket.emit('roulette_clear'); }
        function sendRebet() { if(!isBettingLocked && lastRoundBets.length) lastRoundBets.forEach(b => setTimeout(()=>placeBet(b.x,b.y,b.nums),50)); }
        function sendX2() { if(!isBettingLocked) { let d=[...currentRoundBets]; d.forEach(b=>placeBet(b.x,b.y,b.nums)); } }

        socket.on('bets_cleared', () => { currentRoundBets=[]; document.getElementById('rOverlay').innerHTML=''; rBetTotal=0; updateDisplay(); });
        socket.on('bet_undone', () => { 
            let c=document.getElementById('rOverlay'); if(c.lastChild) c.lastChild.remove(); 
            let p=currentRoundBets.pop(); if(p){ rBetTotal-=p.amount; updateDisplay(); } 
        });

        // STATE SYNC
        socket.on('roulette_state_update', (d) => {
            let tb = document.getElementById('rTimerBox');
            if(d.phase === 'BETTING') {
                isBettingLocked = false;
                document.getElementById('r-timer').innerText = d.time;
                document.getElementById('r-timer').style.display='block';
                document.querySelector('.urgent-text')?.remove();
                document.querySelector('.r-main-area').classList.remove('blurred');
                
                if(d.time <= 3) { tb.classList.add('urgent'); tickSound.play().catch(e=>{}); } 
                else { tb.classList.remove('urgent'); }
            } else {
                isBettingLocked = true;
                tb.classList.remove('urgent');
                tb.innerHTML = '<div class="r-lbl">STATUS</div><div class="r-val urgent-text">SPINNING</div>';
            }
        });

        socket.on('roulette_spin_start', (n) => {
            document.querySelector('.r-main-area').classList.add('blurred');
            document.getElementById('wheel-overlay').classList.add('show');
            spinWheel(n);
        });

        socket.on('roulette_win_data', (d) => {
            document.getElementById('wheel-overlay').classList.remove('show');
            document.querySelector('.r-main-area').classList.remove('blurred');
            
            // DELAY 1.5s to see table, then GATHER
            setTimeout(() => {
                triggerWinAnim(d.number, d.amount, d.balance);
            }, 1500);
        });

        socket.on('roulette_history', (hist) => {
            let h = document.getElementById('rHistory');
            // Only update real numbers
            if(hist.length === 0) return;
            // Clear blanks first time
            if(h.querySelector('.hist-empty')) h.innerHTML = '';
            
            // Just prepend new ones logic
            // Simple rebuild for robustness
            h.innerHTML = '';
            hist.forEach(n => {
                let b = document.createElement('div');
                b.className = `hist-ball ${n===0?'hist-green':(REDS.includes(n)?'hist-red':'hist-black')}`;
                b.innerText = n;
                h.appendChild(b);
            });
        });

        socket.on('roulette_reset', () => {
            if(currentRoundBets.length) lastRoundBets = [...currentRoundBets];
            currentRoundBets=[]; rBetTotal=0; document.getElementById('rOverlay').innerHTML='';
            updateDisplay();
            document.getElementById('winner-stage').classList.remove('active');
            document.querySelector('.r-main-area').classList.remove('blurred');
        });

        function triggerWinAnim(winnerNum, totalWin, finalBal) {
            const stage = document.getElementById('winner-stage');
            stage.classList.add('active'); stage.innerHTML='';
            document.querySelector('.r-main-area').classList.add('blurred');

            let winningIds = [`cell-${winnerNum}`];
            if(winnerNum !== 0) {
                if(REDS.includes(winnerNum)) winningIds.push('btn-red'); else winningIds.push('btn-black');
                if(winnerNum%2===0) winningIds.push('btn-even'); else winningIds.push('btn-odd');
                if(winnerNum<=18) winningIds.push('btn-low'); else winningIds.push('btn-high');
                if(winnerNum<=12) winningIds.push('btn-doz1'); else if(winnerNum<=24) winningIds.push('btn-doz2'); else winningIds.push('btn-doz3');
                if(winnerNum%3===1) winningIds.push('btn-row3'); else if(winnerNum%3===2) winningIds.push('btn-row2'); else winningIds.push('btn-row1');
            }

            // GATHER
            let gap = 15; let w = 60; let totalW = winningIds.length * (w+gap);
            let startX = (window.innerWidth - totalW) / 2;

            winningIds.forEach((id, i) => {
                let el = document.getElementById(id);
                if(el) {
                    let rect = el.getBoundingClientRect();
                    let clone = el.cloneNode(true);
                    clone.className = 'flying-cell';
                    if(id.includes('red') || (id.includes('cell') && REDS.includes(winnerNum))) clone.classList.add('red');
                    else if(id.includes('black') || (id.includes('cell') && !REDS.includes(winnerNum) && winnerNum!==0)) clone.classList.add('black');
                    else if(winnerNum===0) clone.classList.add('green');
                    
                    clone.style.left=rect.left+'px'; clone.style.top=rect.top+'px'; 
                    clone.style.width=rect.width+'px'; clone.style.height=rect.height+'px';
                    stage.appendChild(clone);

                    if(id === `cell-${winnerNum}` && totalWin > 0) {
                        let lbl = document.createElement('div'); lbl.className='win-label'; lbl.innerText=`+${totalWin}`;
                        clone.appendChild(lbl);
                    }

                    setTimeout(() => {
                        clone.style.left = (startX + (i*(w+gap))) + 'px';
                        clone.style.top = (window.innerHeight/2 - 30) + 'px';
                        clone.style.width = '60px'; clone.style.minWidth='60px'; clone.style.height='60px';
                    }, 100);
                }
            });

            // COIN (After 2s)
            setTimeout(() => {
                let coin = document.createElement('div'); coin.className='mario-coin';
                coin.style.left = (window.innerWidth/2 - 20)+'px'; coin.style.top = (window.innerHeight/2 - 20)+'px';
                coin.style.display = 'block'; stage.appendChild(coin);
                let dest = document.getElementById('r-balance').getBoundingClientRect();
                coin.style.transition = 'all 0.8s ease-in-out';
                setTimeout(() => {
                    coin.style.left = (dest.left+20)+'px'; coin.style.top = (dest.top+10)+'px'; coin.style.opacity='0';
                    playSfx(coinSound); myBal = finalBal; updateDisplay();
                }, 50);
            }, 2000);

            // END
            setTimeout(() => { 
                stage.classList.remove('active'); stage.innerHTML=''; 
                document.querySelector('.r-main-area').classList.remove('blurred');
            }, 3500);
        }

        function scaleRoulette() {
            let h = window.innerHeight; let w = window.innerWidth;
            let scale = Math.min((h-20)/500, (w-20)/760) * 0.95;
            if(scale < 0.5) scale=0.5; if(scale > 1.8) scale=1.8;
            currentTableScale=scale; document.getElementById('rWrapper').style.transform=`scale(${scale})`;
        }

        // --- WHEEL ---
        const cvs = document.getElementById('wheelCanvas'); const ctx = cvs.getContext('2d');
        const WHEEL = ["0","32","15","19","4","21","2","25","17","34","6","27","13","36","11","30","8","23","10","5","24","16","33","1","20","14","31","9","22","18","29","7","28","12","35","3","26"];
        function getLabelColor(lbl) { if(lbl==="0") return "#165b33"; return REDS.includes(parseInt(lbl)) ? "#c03a35" : "#111"; }
        function drawWheel(angle = 0) {
            ctx.clearRect(0,0,800,800);
            let grad = ctx.createRadialGradient(400, 400, 330, 400, 400, 380); grad.addColorStop(0, "#3a1f12"); grad.addColorStop(1, "#000");
            ctx.beginPath(); ctx.arc(400, 400, 380, 0, Math.PI*2); ctx.fillStyle = grad; ctx.fill();
            ctx.beginPath(); ctx.arc(400, 400, 330, 0, Math.PI*2); ctx.fillStyle = "#0a2118"; ctx.fill();
            ctx.save(); ctx.translate(400, 400); ctx.rotate(angle);
            WHEEL.forEach((lbl, i) => {
                const ang = i * ((Math.PI*2)/37); const slice = (Math.PI*2)/37;
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0, 320, ang, ang+slice); ctx.closePath();
                ctx.fillStyle = getLabelColor(lbl); ctx.fill();
                ctx.save(); ctx.rotate(ang + slice/2); ctx.translate(260, 0); ctx.rotate(Math.PI/2);
                ctx.fillStyle = "#fff"; ctx.font = "bold 24px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(lbl, 0, 0); ctx.restore();
            });
            ctx.beginPath(); ctx.arc(0,0, 90, 0, Math.PI*2); ctx.fillStyle="#222"; ctx.fill(); ctx.restore();
        }
        function spinWheel(targetNum) {
            let idx = WHEEL.indexOf(targetNum.toString());
            let slice = (Math.PI*2)/37;
            let targetAngle = (Math.PI*1.5) - (idx*slice) - (slice/2);
            let final = targetAngle + (Math.PI*2 * 5);
            let start = null;
            function winAnim(ts) { if(!start) start=ts; let el = ts-start; drawWheel(final); if(el < 1500) requestAnimationFrame(winAnim); }
            function anim(ts) {
                if(!start) start=ts; let p=(ts-start)/4000;
                if(p>1) p=1; let ease = 1 - Math.pow(1-p, 3);
                drawWheel(final*ease);
                if(p<1) requestAnimationFrame(anim);
                else { start=null; requestAnimationFrame(winAnim); }
            }
            requestAnimationFrame(anim);
        }

        window.onload = () => { initRoulette(); }
    </script>
</body>
</html>
