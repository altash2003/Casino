<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GRAND CASINO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- YOUR ORIGINAL CSS RESTORED --- */
        :root { --gold: #FFD700; --cyan: #00E5FF; --red: #d32f2f; }
        body { margin: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color:white; }
        
        .view-section { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; flex-direction:column; }
        .view-section.active { display: flex; }
        
        /* ROULETTE SPECIFIC (FROM YOUR FILE) */
        #view-roulette { background-color: #05140a; background-image: radial-gradient(circle at 50% 50%, #012b13 0%, #000000 100%); }
        .r-wrapper { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; }
        
        /* SCALED UP TABLE */
        .r-scaler { transform: scale(1.25); } 
        
        .r-table-wrapper { position: relative; background-color: #01431E; padding: 15px; border-radius: 20px; border: 10px solid #002b12; box-shadow: 0 0 0 5px var(--gold), 0 20px 50px black; }
        
        /* YOUR EXACT GRID */
        .r-grid { display: grid; grid-template-columns: 50px repeat(12, 42px) 34px; grid-template-rows: repeat(3, 42px) 42px 42px; gap: 2px; border: 2px solid var(--gold); padding: 5px; border-radius: 8px; background: rgba(0,0,0,0.2); }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; cursor: pointer; border: 2px solid var(--gold); color:white; position: relative; }
        .red-cell { background-color: #d32f2f; } .black-cell { background-color: #222; }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; border-radius: 6px 0 0 6px; }

        /* YOUR EXACT CHIPS */
        .chips-bar { display: flex; gap: 10px; background: rgba(0,0,0,0.5); padding: 8px 20px; border-radius: 50px; margin: 15px auto 0; width: fit-content; border: 1px solid rgba(255,255,255,0.1); pointer-events: auto; }
        .chip { width: 40px; height: 40px; border-radius: 50%; position: relative; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .chip.active { transform: scale(1.2) translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.7); z-index: 10; border: 2px solid white; }
        .chip::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: repeating-conic-gradient(var(--c1) 0deg 15deg, var(--c2) 15deg 30deg, var(--c1) 30deg 45deg, var(--c3) 45deg 60deg); }
        .chip::after { content: ''; position: absolute; inset: 5px; border-radius: 50%; background: var(--c1); border: 1px solid rgba(0,0,0,0.3); }
        .chip-label { position: relative; z-index: 2; font-size: 10px; font-weight: 900; color: #333; background: #fff; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; border: 1px solid #aaa; }
        
        .chip-50 { --c1: #ddd; --c2: #fff; --c3: #bbb; }
        .chip-200 { --c1: #800; --c2: #a00; --c3: #500; }
        .chip-1k { --c1: #060; --c2: #080; --c3: #040; }
        .chip-10k { --c1: #008; --c2: #00a; --c3: #004; }
        .chip-100k { --c1: #111; --c2: #333; --c3: #000; }

        /* Visual Chip on Board */
        .board-chip { position: absolute; width: 20px; height: 20px; border-radius: 50%; pointer-events: none; z-index: 50; box-shadow: 0 2px 4px black; }

        /* --- NEW PANELS (STYLED TO MATCH) --- */
        .side-panel { position: fixed; background: rgba(0,0,0,0.85); border: 1px solid #444; color: white; display: none; flex-direction: column; z-index: 8000; backdrop-filter: blur(5px); }
        .side-panel.active { display: flex; }
        
        #playerPanel { top: 60px; left: 10px; width: 200px; max-height: 50vh; border-left: 2px solid var(--cyan); }
        #betPanel { top: 60px; right: 10px; width: 200px; border-right: 2px solid var(--gold); }
        #chatPanel { bottom: 80px; right: 10px; width: 300px; height: 350px; border: 1px solid #555; }
        
        .panel-head { padding: 8px; font-weight: bold; background: rgba(255,255,255,0.05); font-size: 12px; display: flex; justify-content: space-between; }
        .panel-list { overflow-y: auto; padding: 5px; flex: 1; font-size: 12px; }
        .panel-item { display: flex; justify-content: space-between; padding: 4px; border-bottom: 1px solid #222; }
        
        /* Chat Tabs */
        .chat-tabs { display: flex; background: #111; }
        .c-tab { flex: 1; padding: 8px; text-align: center; font-size: 10px; cursor: pointer; color: #666; font-weight: bold; }
        .c-tab.active { color: white; background: #222; border-bottom: 2px solid var(--gold); }
        .msg-support { color: var(--cyan); }

        /* Voice Bar */
        .voice-bar { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: none; gap: 5px; background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 30px; border: 1px solid #444; z-index: 9000; }
        .vb-btn { font-size: 10px; padding: 5px 10px; border-radius: 15px; cursor: pointer; border: 1px solid #555; color: #aaa; background: #222; }
        .vb-btn.active { color: var(--gold); border-color: var(--gold); }
        .vb-btn.talking { background: var(--gold); color: black; }

        /* Wheel Pop */
        #wheel-overlay { position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center; pointer-events: none; }
        #wheel-overlay.show { display: flex; }
        .wheelPanel { filter: drop-shadow(0 20px 50px rgba(0,0,0,0.8)); }

        .disabled { filter: grayscale(1); pointer-events: none; opacity: 0.5; }
    </style>
</head>
<body>

    <div id="authOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; display:flex; justify-content:center; align-items:center;">
        <div style="background:#111; padding:40px; border:1px solid #333; text-align:center;">
            <h1 style="color:var(--gold)">GRAND CASINO</h1>
            <input id="u" placeholder="User (5-12 chars)" style="padding:10px; width:200px; display:block; margin:10px auto; background:#222; border:1px solid #444; color:white;">
            <input id="p" type="password" placeholder="Pass (5-12 chars)" style="padding:10px; width:200px; display:block; margin:10px auto; background:#222; border:1px solid #444; color:white;">
            <button onclick="auth('login')" style="padding:10px 20px; background:var(--gold); border:none; font-weight:bold; cursor:pointer;">LOGIN</button>
            <button onclick="auth('register')" style="padding:10px 20px; background:transparent; border:1px solid #444; color:white; font-weight:bold; cursor:pointer;">REGISTER</button>
            <div id="authMsg" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div id="playerPanel" class="side-panel"><div class="panel-head">PLAYERS</div><div class="panel-list" id="pList"></div></div>
    <div id="betPanel" class="side-panel"><div class="panel-head">CURRENT BETS</div><div class="panel-list" id="bList"></div><div style="padding:5px; text-align:right; font-size:10px;">TOTAL: <span id="bTotal" style="color:var(--gold)">0</span></div></div>
    
    <div id="chatPanel" class="side-panel">
        <div class="panel-head">CHAT <span onclick="toggleChat()" style="cursor:pointer">&times;</span></div>
        <div class="chat-tabs">
            <div class="c-tab active" onclick="setChatTab('public')" id="tab-public">PUBLIC</div>
            <div class="c-tab" onclick="setChatTab('support')" id="tab-support">SUPPORT</div>
        </div>
        <div class="panel-list" id="cBox"></div>
        <div style="padding:5px; border-top:1px solid #333; display:flex;">
            <input id="cInput" style="flex:1; background:#222; border:none; color:white; padding:5px; font-size:12px;" placeholder="Type...">
            <button onclick="sendChat()" style="background:var(--gold); border:none; font-weight:bold;">></button>
        </div>
    </div>

    <div class="voice-bar" id="voiceBar">
        <div class="vb-btn" id="v-off" onclick="setVoice('off')">OFF</div>
        <div class="vb-btn" id="v-ptt" onclick="setVoice('ptt')">PTT</div>
        <div class="vb-btn" id="v-auto" onclick="setVoice('auto')">AUTO</div>
    </div>

    <button onclick="lobby()" id="backBtn" style="position:fixed; top:10px; left:10px; display:none; z-index:9000; background:#333; color:white; border:1px solid #555; padding:5px;">BACK</button>

    <div id="view-lobby" class="view-section active" style="background:url('background.jpg') center/cover; justify-content:center; align-items:center;">
        <h1 style="font-size:80px; color:var(--gold); text-shadow:0 0 20px black; margin:0;">CASINO</h1>
        <div style="margin-bottom:20px;">User: <span id="myName"></span> | Bal: <span id="myBal" style="color:var(--cyan)"></span></div>
        <div style="display:flex; gap:30px;">
            <div onclick="enter('colorgame')" style="width:200px; height:300px; background:rgba(0,0,0,0.8); border:2px solid #333; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; border-radius:10px;">
                <div style="font-size:50px">ðŸŽ¨</div><h2>COLOR</h2>
            </div>
            <div onclick="enter('roulette')" style="width:200px; height:300px; background:rgba(0,0,0,0.8); border:2px solid #333; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; border-radius:10px;">
                <div style="font-size:50px">ðŸŽ¡</div><h2>ROULETTE</h2>
            </div>
        </div>
    </div>

    <div id="view-colorgame" class="view-section" style="background:url('background.jpg') center/cover;">
        <div style="text-align:center; margin-top:20px;"><h2 style="color:var(--gold)">COLOR GAME</h2><span id="cg-status">BETTING</span> <span id="cg-timer">20</span></div>
        <div style="display:flex; justify-content:center; gap:20px; margin:40px;">
            <div id="d1" class="die" style="font-size:40px; width:80px; height:80px; background:#333; display:flex; justify-content:center; align-items:center; border-radius:10px;">?</div>
            <div id="d2" class="die" style="font-size:40px; width:80px; height:80px; background:#333; display:flex; justify-content:center; align-items:center; border-radius:10px;">?</div>
            <div id="d3" class="die" style="font-size:40px; width:80px; height:80px; background:#333; display:flex; justify-content:center; align-items:center; border-radius:10px;">?</div>
        </div>
        <div id="cg-btns" style="display:flex; justify-content:center; gap:10px;"></div>
        </div>

    <div id="view-roulette" class="view-section">
        <div id="wheel-overlay"><div class="wheelPanel" style="position:relative;"><div style="position:absolute; top:20px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:20px solid transparent; border-right:20px solid transparent; border-top:40px solid var(--gold); z-index:10;"></div><canvas id="wheelCanvas" width="600" height="600" style="width:500px; height:500px; border-radius:50%;"></canvas></div></div>

        <div class="r-wrapper">
            <div style="text-align:center; margin-bottom:10px;">
                <span id="r-status" style="font-weight:bold; color:var(--gold)">BETTING</span> <span id="r-timer" style="font-size:20px;">40</span> | Bal: <span id="r-bal" style="color:var(--cyan)">0</span>
            </div>

            <div class="r-scaler">
                <div class="r-table-wrapper">
                    <div class="r-grid" id="rGrid">
                        <div class="cell zone-0" id="cell-0" onclick="betR([0], '0', event)">0</div>
                        <div class="cell" style="grid-column:14; grid-row:1; writing-mode:vertical-rl; font-size:10px;" onclick="betR(getArr('row1'), 'Row 1', event)">2 to 1</div>
                        <div class="cell" style="grid-column:14; grid-row:2; writing-mode:vertical-rl; font-size:10px;" onclick="betR(getArr('row2'), 'Row 2', event)">2 to 1</div>
                        <div class="cell" style="grid-column:14; grid-row:3; writing-mode:vertical-rl; font-size:10px;" onclick="betR(getArr('row3'), 'Row 3', event)">2 to 1</div>
                        <div class="cell" style="grid-row:4; grid-column:2/6; font-size:10px;" onclick="betR(getArr('1st12'), '1st 12', event)">1st 12</div>
                        <div class="cell" style="grid-row:4; grid-column:6/10; font-size:10px;" onclick="betR(getArr('2nd12'), '2nd 12', event)">2nd 12</div>
                        <div class="cell" style="grid-row:4; grid-column:10/14; font-size:10px;" onclick="betR(getArr('3rd12'), '3rd 12', event)">3rd 12</div>
                        <div class="cell" style="grid-row:5; grid-column:2/4; font-size:10px;" onclick="betR(getArr('1-18'), '1-18', event)">1-18</div>
                        <div class="cell" style="grid-row:5; grid-column:4/6; font-size:10px;" onclick="betR(getArr('even'), 'EVEN', event)">EVEN</div>
                        <div class="cell" style="grid-row:5; grid-column:6/8;" onclick="betR(getArr('red'), 'RED', event)"><div style="width:15px; height:15px; background:#d32f2f; transform:rotate(45deg);"></div></div>
                        <div class="cell" style="grid-row:5; grid-column:8/10;" onclick="betR(getArr('black'), 'BLACK', event)"><div style="width:15px; height:15px; background:#111; transform:rotate(45deg);"></div></div>
                        <div class="cell" style="grid-row:5; grid-column:10/12; font-size:10px;" onclick="betR(getArr('odd'), 'ODD', event)">ODD</div>
                        <div class="cell" style="grid-row:5; grid-column:12/14; font-size:10px;" onclick="betR(getArr('19-36'), '19-36', event)">19-36</div>
                    </div>
                    <div id="chipLayer" style="position:absolute; inset:0; pointer-events:none;"></div>
                </div>
            </div>

            <div class="chips-bar" id="chipsBar">
                <div class="chip chip-50 active" onclick="setChip(50, this)"><div class="chip-label">50</div></div>
                <div class="chip chip-200" onclick="setChip(200, this)"><div class="chip-label">200</div></div>
                <div class="chip chip-1k" onclick="setChip(1000, this)"><div class="chip-label">1K</div></div>
                <div class="chip chip-10k" onclick="setChip(10000, this)"><div class="chip-label">10K</div></div>
                <div class="chip chip-100k" onclick="setChip(100000, this)"><div class="chip-label">100K</div></div>
            </div>
            
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="toggleChat()" style="background:#222; border:1px solid #555; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-comment"></i></button>
                <button onclick="clearRBets()" style="background:#333; color:white; border:1px solid #555; padding:0 20px; font-weight:bold; cursor:pointer;">CLEAR</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let me="", bal=0, room="lobby", chip=50;
        let isRolling=false, bets=[];
        
        // --- AUTH ---
        function auth(act) { socket.emit(act, {username:document.getElementById('u').value, password:document.getElementById('p').value}); }
        socket.on('login_success', d=>{ me=d.username; bal=d.balance; document.getElementById('authOverlay').style.display='none'; upd(); });
        socket.on('login_error', m=>document.getElementById('authMsg').innerText=m);
        socket.on('update_balance', b=>{ bal=b; upd(); });
        function upd() { ['myBal','r-bal'].forEach(i=>document.getElementById(i).innerText=bal); document.getElementById('myName').innerText=me; }

        // --- NAVIGATION ---
        function enter(r) { 
            room=r; socket.emit('switch_room', r);
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+r).classList.add('active');
            ['playerPanel','betPanel','voiceBar','backBtn'].forEach(i=>document.getElementById(i).style.display='flex');
            document.getElementById('chipsBar').style.display = (r==='roulette') ? 'flex' : 'none';
            if(r==='roulette') initR();
            initAudio();
        }
        function lobby() {
            room='lobby'; socket.emit('switch_room', 'lobby');
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-lobby').classList.add('active');
            ['playerPanel','betPanel','voiceBar','backBtn','chatPanel'].forEach(i=>document.getElementById(i).style.display='none');
        }

        // --- ROULETTE GENERATION ---
        const REDS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        function initR() {
            if(document.getElementById('cell-1')) return;
            let h='';
            for(let i=1; i<=36; i++) {
                let r = (i%3===0)?1:(i%3===2?2:3);
                let c = Math.floor((i-1)/3)+2;
                let cls = REDS.includes(i)?'red-cell':'black-cell';
                h+=`<div class="cell ${cls}" id="cell-${i}" style="grid-row:${r}; grid-column:${c};" onclick="betR([${i}], '${i}', event)">${i}</div>`;
            }
            // Inject after cell-0
            document.getElementById('cell-0').insertAdjacentHTML('afterend', h);
            drawWheel(0);
        }

        function getArr(t) {
            let a=[]; 
            for(let i=1;i<=36;i++) {
                if(t=='row1' && i%3==0) a.push(i);
                if(t=='row2' && i%3==2) a.push(i);
                if(t=='row3' && i%3==1) a.push(i);
                if(t=='1st12' && i<=12) a.push(i);
                if(t=='2nd12' && i>12 && i<=24) a.push(i);
                if(t=='3rd12' && i>24) a.push(i);
                if(t=='1-18' && i<=18) a.push(i);
                if(t=='19-36' && i>=19) a.push(i);
                if(t=='even' && i%2==0) a.push(i);
                if(t=='odd' && i%2!=0) a.push(i);
                if(t=='red' && REDS.includes(i)) a.push(i);
                if(t=='black' && !REDS.includes(i)) a.push(i);
            }
            return a;
        }

        function betR(nums, desc, e) {
            if(isRolling) return alert("WAIT");
            if(bal<chip) return alert("Funds");
            socket.emit('place_bet_roulette', {numbers:nums, amount:chip});
            
            let rect = document.querySelector('.r-table-wrapper').getBoundingClientRect();
            let d = document.createElement('div');
            // Recreating the chip look for the board
            d.className = `board-chip ${chip==50?'chip-50':(chip==200?'chip-200':(chip==1000?'chip-1k':(chip==10000?'chip-10k':'chip-100k')))}`;
            // Re-use the conic gradient logic or simple color for small board chip? 
            // File implies "chip" class. Let's use simplified small version.
            d.style.background = chip==50?'white':(chip==200?'#a00':(chip==1000?'#080':(chip==10000?'#00a':'#111')));
            d.style.left = (e.clientX - rect.left - 10) + 'px';
            d.style.top = (e.clientY - rect.top - 10) + 'px';
            document.getElementById('chipLayer').appendChild(d);
            
            bets.push({d:desc, a:chip}); renderBetLog();
        }
        
        function clearRBets() { socket.emit('roulette_clear'); }
        socket.on('bets_cleared', ()=>{ document.getElementById('chipLayer').innerHTML=''; bets=[]; renderBetLog(); });
        socket.on('roulette_timer', t=> document.getElementById('r-timer').innerText=t);
        socket.on('roulette_spin_start', n=> { isRolling=true; document.getElementById('r-status').innerText="SPINNING"; document.getElementById('wheel-overlay').classList.add('show'); spinWheel(n); });
        socket.on('roulette_new_round', ()=>{ isRolling=false; bets=[]; renderBetLog(); document.getElementById('chipLayer').innerHTML=''; document.getElementById('r-status').innerText="BETTING"; });
        socket.on('roulette_win', d=> alert(`WINNER: ${d.number} | WON: ${d.amount}`));

        // --- WHEEL ---
        const WHEEL = ["0","32","15","19","4","21","2","25","17","34","6","27","13","36","11","30","8","23","10","5","24","16","33","1","20","14","31","9","22","18","29","7","28","12","35","3","26"];
        function drawWheel(ang) {
            let ctx = document.getElementById('wheelCanvas').getContext('2d');
            ctx.clearRect(0,0,600,600); ctx.save(); ctx.translate(300,300); ctx.rotate(ang);
            let s = (Math.PI*2)/37;
            WHEEL.forEach((n,i) => {
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,280, i*s, (i+1)*s);
                ctx.fillStyle=n=="0"?'#060':(REDS.includes(parseInt(n))?'#b00':'#111'); ctx.fill(); ctx.stroke();
                ctx.save(); ctx.rotate(i*s+s/2); ctx.fillStyle="white"; ctx.font="bold 24px Arial"; ctx.fillText(n, 220, 10); ctx.restore();
            });
            ctx.restore();
        }
        function spinWheel(t) {
            let idx = WHEEL.indexOf(t.toString());
            let dest = (Math.PI*2*5) - (idx*((Math.PI*2)/37)) - (((Math.PI*2)/37)/2);
            let s; function anim(ts) { if(!s)s=ts; let p=(ts-s)/5000; if(p>1)p=1; drawWheel(dest*(1-Math.pow(1-p,3))); if(p<1)requestAnimationFrame(anim); else setTimeout(()=>document.getElementById('wheel-overlay').classList.remove('show'),2000); }
            requestAnimationFrame(anim);
        }

        // --- CHIPS ---
        function setChip(v, el) { chip=v; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
        
        // --- COLOR GAME ---
        const CG_C = ['RED','GREEN','BLUE','YELLOW','PINK','WHITE'];
        const CG_H = {'RED':'#d32f2f','GREEN':'#388e3c','BLUE':'#1976d2','YELLOW':'#fbc02d','PINK':'#e91e63','WHITE':'#eee'};
        let ch = ''; CG_C.forEach(c => { ch+=`<div onclick="betCg('${c}')" style="background:${CG_H[c]}; width:80px; height:80px; border-radius:10px; cursor:pointer; border:2px solid #555; display:flex; flex-direction:column; align-items:center; justify-content:center; color:black; font-weight:bold;">${c}<span id="b-${c}" style="background:rgba(255,255,255,0.7); padding:2px; margin-top:5px; border-radius:3px;">0</span></div>`; });
        document.getElementById('cg-btns').innerHTML=ch;
        function betCg(c) { if(isRolling)return; if(bal<chip)return; socket.emit('place_bet',{color:c, amount:chip}); document.getElementById('b-'+c).innerText=parseInt(document.getElementById('b-'+c).innerText)+chip; }
        socket.on('game_rolling', ()=>{ isRolling=true; document.getElementById('cg-status').innerText="ROLLING"; });
        socket.on('game_result', r=>{ isRolling=false; ['d1','d2','d3'].forEach((d,i)=>{ document.getElementById(d).innerText=""; document.getElementById(d).style.backgroundColor=CG_H[r[i]]; }); document.getElementById('cg-status').innerText="RESULT"; });
        socket.on('game_reset', ()=>{ isRolling=false; document.getElementById('cg-status').innerHTML=`BETTING <span id="cg-timer">20</span>`; CG_C.forEach(c=>document.getElementById('b-'+c).innerText='0'); });
        socket.on('timer_update', t=> { if(document.getElementById('cg-timer')) document.getElementById('cg-timer').innerText=t; });

        // --- PANELS, CHAT, VOICE ---
        let chatType='public', vMode='off';
        function renderBetLog() { let h=''; let t=0; bets.forEach(b=>{ h+=`<div class="panel-item"><span>${b.d}</span><span style="color:var(--gold)">${b.a}</span></div>`; t+=b.a; }); document.getElementById('bList').innerHTML=h; document.getElementById('bTotal').innerText=t; }
        function toggleChat() { let p=document.getElementById('chatPanel'); p.classList.toggle('active'); }
        function setChatTab(t) { chatType=t; document.querySelectorAll('.c-tab').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.getElementById('cBox').innerHTML=''; }
        function sendChat() { let i=document.getElementById('cInput'); if(i.value) socket.emit('chat_msg',{msg:i.value, room:room, type:chatType}); i.value=''; }
        socket.on('chat_broadcast', d=>{ if(d.type==chatType) { let b=document.getElementById('cBox'); b.innerHTML+=`<div><b style="color:${d.type=='support'?'var(--cyan)':'var(--gold)'}">${d.user}:</b> ${d.msg}</div>`; } });
        socket.on('room_users_update', l=>{ document.getElementById('pList').innerHTML=l.map(u=>`<div class="panel-item" id="u-${u.id}"><i class="fas fa-user"></i> ${u.username}</div>`).join(''); });
        
        let audioCtx, mediaStream;
        function setVoice(m) { vMode=m; document.querySelectorAll('.vb-btn').forEach(b=>b.classList.remove('active')); document.getElementById('v-'+m).classList.add('active'); if(m!='off') initAudio(); }
        function initAudio() {
            if(mediaStream) return;
            navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
                mediaStream=s; audioCtx=new AudioContext();
                let src=audioCtx.createMediaStreamSource(s); let p=audioCtx.createScriptProcessor(4096,1,1);
                src.connect(p); p.connect(audioCtx.destination);
                p.onaudioprocess=e=>{
                    if(vMode=='off') return;
                    let d=e.inputBuffer.getChannelData(0); let sum=0; for(let i=0;i<d.length;i++)sum+=d[i]*d[i];
                    let vol=Math.sqrt(sum/d.length);
                    let speak=(vMode=='auto'&&vol>0.02)||(vMode=='ptt'&&spaceDown);
                    if(speak) { socket.emit('voice_status',true); } else socket.emit('voice_status',false);
                };
            });
        }
        let spaceDown=false; window.onkeydown=e=>{if(e.code=='Space')spaceDown=true;}; window.onkeyup=e=>{if(e.code=='Space')spaceDown=false;};
        socket.on('player_voice_update', d=>{ let el=document.getElementById('u-'+d.id); if(el) d.talking?el.style.color='var(--gold)':el.style.color='white'; });
    </script>
</body>
</html>
