<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRAND CASINO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- GLOBAL RESET --- */
        :root { --gold: #FFD700; --cyan: #00E5FF; --red: #d32f2f; }
        body { margin: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color:white; }
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input { -webkit-user-select: auto; user-select: auto; }

        .view-section { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; flex-direction:column; }
        .view-section.active { display: flex; }
        .global-back { position: fixed; top: 10px; left: 10px; z-index: 9000; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-weight: bold; display: none; }

        /* --- YOUR ORIGINAL PANELS (Right Side) --- */
        .panel-position { position: fixed; bottom: 100px; right: 20px; width: 280px; background: rgba(20,20,20,0.95); border: 1px solid #444; border-radius: 12px; display: none; flex-direction: column; z-index: 8000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .panel-position.active { display: flex; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-panel { height: 350px; }
        .chat-header { padding: 8px; text-align: center; font-weight: bold; background: #111; color: #888; font-size: 11px; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center; border-radius: 12px 12px 0 0; }
        .chat-content { flex: 1; overflow-y: scroll; padding: 10px; scrollbar-width: thin; }
        .chat-input-area { padding: 8px; border-top: 1px solid #333; display: flex; background: #1a1a1a; border-radius: 0 0 12px 12px; }
        .chat-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 6px; font-size: 12px; outline:none; }
        
        /* Music Panel (Original Style) */
        .music-player { height: auto; padding: 10px; }
        .mp-controls { display: flex; gap: 5px; margin-bottom: 5px; }
        .mp-btn { background: #333; border: 1px solid #555; color: white; flex: 1; cursor: pointer; font-size: 10px; padding: 5px; }
        .mp-input { width: 100%; background: #222; border: 1px solid #444; color: #aaa; padding: 4px; box-sizing: border-box; font-size: 10px; margin-bottom: 5px; }

        /* --- LEFT PLAYER PANEL (New Feature) --- */
        .player-panel { position: fixed; top: 60px; left: 10px; width: 200px; max-height: 50vh; background: rgba(0,0,0,0.7); border-left: 3px solid var(--cyan); border-radius: 0 8px 8px 0; z-index: 7000; display: none; flex-direction: column; backdrop-filter: blur(5px); transition:0.3s; }
        .player-panel.active { display: flex; }
        .pp-head { padding: 8px; font-size: 10px; color: var(--cyan); font-weight: bold; background: rgba(0,255,255,0.1); }
        .pp-list { overflow-y: auto; padding: 5px; }
        .pp-item { display: flex; align-items: center; gap: 5px; padding: 4px; font-size: 12px; border-bottom: 1px solid #333; }
        .pp-item.talking { color: var(--gold); font-weight: bold; }
        .pp-item.talking i { color: var(--gold); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* --- CURRENT BET PANEL (New Feature) --- */
        .bet-panel { position: fixed; top: 60px; right: 10px; width: 200px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); border-radius: 8px; padding: 10px; display: none; z-index: 7000; color: white; font-size: 12px; }
        .bet-panel.active { display: block; }
        .bp-head { border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 5px; color: var(--gold); font-weight: bold; }
        .bp-list { max-height: 200px; overflow-y: auto; }
        .bp-item { display: flex; justify-content: space-between; margin-bottom: 2px; }

        /* --- CHIPS (Restored Exact Values) --- */
        .chips-bar { display: flex; gap: 8px; padding: 6px 15px; background: rgba(0,0,0,0.4); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); width: fit-content; margin: 10px auto; pointer-events: auto; }
        .chip { width: 34px; height: 34px; border-radius: 50%; position: relative; cursor: pointer; transition: transform 0.15s; box-shadow: 0 4px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .chip:hover { transform: scale(1.1); }
        .chip.active { transform: scale(1.15) translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.6); border: 2px solid white; }
        .chip::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: repeating-conic-gradient(var(--c1) 0deg 15deg, var(--c2) 15deg 30deg, var(--c1) 30deg 45deg, var(--c3) 45deg 60deg); }
        .chip::after { content: ''; position: absolute; inset: 4px; border-radius: 50%; background: var(--c1); border: 1px solid rgba(0,0,0,0.2); }
        .chip-label { position: relative; z-index: 10; width: 18px; height: 18px; background: #fdfbf7; border-radius: 50%; border: 1px solid #d4d4d4; display: flex; justify-content: center; align-items: center; font-size: 8px; font-weight: 800; color: #333; }
        
        /* Specific Colors */
        .chip-50 { --c1: #e0dfd5; --c2: #fff; --c3: #b0b0a8; }
        .chip-200 { --c1: #6b1818; --c2: #a32e2e; --c3: #3b0505; } /* Red */
        .chip-1k { --c1: #1e4d2b; --c2: #367a48; --c3: #0d2613; } /* Green */
        .chip-10k { --c1: #142850; --c2: #2c4d87; --c3: #050e21; } /* Blue */
        .chip-100k { --c1: #262626; --c2: #444; --c3: #000; } /* Black */

        /* --- AUTH --- */
        #authOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: #111; border: 1px solid #333; padding: 40px; text-align: center; width: 300px; }
        .auth-inp { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; }
        
        /* --- LOBBY --- */
        #view-lobby { background: url('background.jpg') center/cover; justify-content: center; align-items: center; gap: 30px; }
        .game-card { width: 260px; height: 360px; background: rgba(0,0,0,0.85); border: 2px solid #333; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        
        /* --- DICE GAME --- */
        #view-colorgame { background: url('background.jpg') center/cover; flex-direction: column; }
        .cg-stats { display: flex; justify-content: center; gap: 40px; margin-top: 20px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 30px; width: fit-content; margin: 20px auto; }
        .cg-dice-row { display: flex; gap: 20px; justify-content: center; margin: 40px 0; }
        .die { width: 90px; height: 90px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid rgba(255,255,255,0.2); background: #222; }
        .die.red { background: #d32f2f; } .die.green { background: #388e3c; } .die.blue { background: #1976d2; }
        .die.pink { background: #e91e63; } .die.white { background: #eee; color:black; } .die.yellow { background: #fbc02d; color:black; }
        
        .cg-bet-panel { background: rgba(0,0,0,0.5); padding: 20px; width: 80%; max-width: 600px; margin: 0 auto; border-radius: 10px; }
        .cg-bet-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .cg-btn { height: 80px; border: 1px solid #555; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; opacity: 0.9; transition: 0.2s; }
        .cg-btn:hover { opacity: 1; transform: scale(1.05); }
        .cg-btn.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); } /* Disabled style */

        /* --- ROULETTE --- */
        #view-roulette { background-color: #05140a; background-image: radial-gradient(circle at 50% 50%, #012b13 0%, #000000 100%); }
        .r-wrapper { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; }
        .r-grid { display: grid; grid-template-columns: 50px repeat(12, 42px) 34px; grid-template-rows: repeat(3, 42px) 42px 42px; gap: 2px; padding: 5px; border: 2px solid var(--gold); background: rgba(0,0,0,0.2); border-radius: 8px; position: relative; }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; cursor: pointer; border: 1px solid var(--gold); color:white; }
        .cell.disabled { opacity: 0.5; pointer-events: none; }
        .red-cell { background-color: var(--red); } .black-cell { background-color: #111; }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; border-radius: 6px 0 0 6px; }

        /* Pop Up Wheel */
        #wheel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #wheel-overlay.show { display: flex; animation: fadeIn 0.3s; opacity: 1; pointer-events: auto; }
        .wheelPanel { filter: drop-shadow(0 20px 50px rgba(0,0,0,0.8)); }
        .pointer { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid var(--gold); z-index: 5005; }

        /* Floating Icons */
        .icon-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 15px; z-index: 5000; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; background: #222; border: 1px solid #555; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 18px; }
        
        /* Voice PTT */
        .ptt-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #555; color: #888; padding: 10px 20px; border-radius: 30px; cursor: pointer; display: none; z-index: 9000; }
        .ptt-btn.talking { border-color: var(--gold); color: var(--gold); background: rgba(255,215,0,0.2); }
    </style>
</head>
<body>

    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
        }
    </script>

    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:var(--gold); margin-bottom:20px;">GRAND CASINO</h1>
            <input id="user" class="auth-inp" placeholder="USERNAME">
            <input id="pass" class="auth-inp" type="password" placeholder="PASSWORD">
            <button onclick="login()" style="width:100%; padding:10px; background:var(--gold); border:none; font-weight:bold; cursor:pointer;">ENTER</button>
            <div id="loginErr" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div class="player-panel" id="playerListPanel">
        <div class="pp-head">PLAYERS IN ROOM</div>
        <div class="pp-list" id="plList"></div>
    </div>

    <div class="bet-panel" id="betPanel">
        <div class="bp-head">CURRENT BETS</div>
        <div class="bp-list" id="bpList"></div>
        <div style="margin-top:5px; border-top:1px solid #444; padding-top:5px; text-align:right;">Total: <span id="bpTotal" style="color:var(--gold)">0</span></div>
    </div>

    <div class="chat-panel panel-position" id="chatPanel">
        <div class="chat-header"><span>GLOBAL CHAT</span> <span onclick="toggleChat()" style="cursor:pointer;">&times;</span></div>
        <div class="chat-content" id="chatBox"></div>
        <div class="chat-input-area">
            <input id="chatInput" class="chat-input" placeholder="Type here...">
            <button onclick="sendChat()" style="background:var(--gold); border:none; padding:0 10px; font-weight:bold;">></button>
        </div>
    </div>

    <div class="music-player panel-position" id="musicPanel">
        <div class="chat-header"><span>MUSIC</span> <span onclick="toggleMusic()" style="cursor:pointer;">&times;</span></div>
        <div style="padding:10px;">
            <div class="mp-controls">
                <button class="mp-btn" onclick="playMusic()">PLAY</button>
                <button class="mp-btn" onclick="pauseMusic()">STOP</button>
            </div>
            <input id="musicUrl" class="mp-input" placeholder="MP3 URL">
            <button class="mp-btn" style="width:100%" onclick="playCustom()">LOAD CUSTOM</button>
            <audio id="audioEl" loop></audio>
        </div>
    </div>

    <div class="ptt-btn" id="pttBtn" onclick="toggleVoice()"><i class="fas fa-microphone"></i> AUTO VOICE</div>
    <button class="global-back" id="backBtn" onclick="goLobby()">‚Üê LOBBY</button>

    <div id="view-lobby" class="view-section active">
        <h1 style="font-size:60px; color:var(--gold); text-shadow:0 0 20px black;">GRAND CASINO</h1>
        <div>User: <span id="lUser" style="color:var(--gold)">Guest</span> | Balance: <span id="lBal" style="color:var(--cyan)">0</span></div>
        <div style="display:flex; gap:30px;">
            <div class="game-card" onclick="enter('colorgame')"><div style="font-size:50px">üé®</div><h2>COLOR GAME</h2></div>
            <div class="game-card" onclick="enter('roulette')"><div style="font-size:50px">üé°</div><h2>ROULETTE</h2></div>
        </div>
    </div>

    <div id="view-colorgame" class="view-section">
        <div class="cg-stats">
            <div style="text-align:center"><div style="font-size:10px; color:#888">TIMER</div><div id="cg-time" style="font-size:24px; color:var(--gold); font-weight:bold;">20</div></div>
            <div style="text-align:center"><div style="font-size:10px; color:#888">STATUS</div><div id="cg-status" style="font-size:18px; margin-top:4px;">BETTING</div></div>
        </div>

        <div class="cg-dice-row">
            <div id="d1" class="die">?</div><div id="d2" class="die">?</div><div id="d3" class="die">?</div>
        </div>

        <div class="cg-bet-panel">
            <div class="chips-bar">
                <div class="chip chip-50 active" onclick="setChip(50, this)"><div class="chip-label">50</div></div>
                <div class="chip chip-200" onclick="setChip(200, this)"><div class="chip-label">200</div></div>
                <div class="chip chip-1k" onclick="setChip(1000, this)"><div class="chip-label">1K</div></div>
                <div class="chip chip-10k" onclick="setChip(10000, this)"><div class="chip-label">10K</div></div>
                <div class="chip chip-100k" onclick="setChip(100000, this)"><div class="chip-label">100K</div></div>
            </div>

            <div class="cg-bet-grid" id="cg-buttons">
                <div class="cg-btn" style="background:#d32f2f" onclick="betCg('RED')"><b>RED</b><span id="b-RED">0</span></div>
                <div class="cg-btn" style="background:#388e3c" onclick="betCg('GREEN')"><b>GREEN</b><span id="b-GREEN">0</span></div>
                <div class="cg-btn" style="background:#1976d2" onclick="betCg('BLUE')"><b>BLUE</b><span id="b-BLUE">0</span></div>
                <div class="cg-btn" style="background:#fbc02d; color:black" onclick="betCg('YELLOW')"><b>YEL</b><span id="b-YELLOW">0</span></div>
                <div class="cg-btn" style="background:#e91e63" onclick="betCg('PINK')"><b>PINK</b><span id="b-PINK">0</span></div>
                <div class="cg-btn" style="background:#eee; color:black" onclick="betCg('WHITE')"><b>WHT</b><span id="b-WHITE">0</span></div>
            </div>
        </div>
        
        <div class="icon-controls">
            <div class="icon-btn" onclick="toggleChat()"><i class="fas fa-comment"></i></div>
            <div class="icon-btn" onclick="toggleMusic()"><i class="fas fa-music"></i></div>
        </div>
    </div>

    <div id="view-roulette" class="view-section">
        <div id="wheel-overlay">
            <div class="wheelPanel" style="position:relative;">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="600" height="600" style="width:500px; height:500px; border-radius:50%;"></canvas>
            </div>
        </div>

        <div class="r-wrapper">
            <div style="display:flex; gap:20px; margin-bottom:10px;">
                <div style="text-align:center"><div style="font-size:10px; color:#888">TIMER</div><div id="r-time" style="font-size:24px; color:var(--gold); font-weight:bold;">30</div></div>
                <div style="text-align:center"><div style="font-size:10px; color:#888">BALANCE</div><div id="r-bal" style="font-size:18px; color:var(--cyan); margin-top:4px;">0</div></div>
            </div>

            <div class="r-grid" id="r-grid">
                <div class="cell zone-0" id="btn-0" onclick="betR([0])">0</div>
                <div class="cell" style="grid-column:14; grid-row:1; writing-mode:vertical-rl; font-size:10px;" onclick="betR(getArr('row1'))">2 to 1</div>
                <div class="cell" style="grid-column:14; grid-row:2; writing-mode:vertical-rl; font-size:10px;" onclick="betR(getArr('row2'))">2 to 1</div>
                <div class="cell" style="grid-column:14; grid-row:3; writing-mode:vertical-rl; font-size:10px;" onclick="betR(getArr('row3'))">2 to 1</div>

                <div class="cell" style="grid-row:4; grid-column:2/6; font-size:10px;" onclick="betR(getArr('1st12'))">1st 12</div>
                <div class="cell" style="grid-row:4; grid-column:6/10; font-size:10px;" onclick="betR(getArr('2nd12'))">2nd 12</div>
                <div class="cell" style="grid-row:4; grid-column:10/14; font-size:10px;" onclick="betR(getArr('3rd12'))">3rd 12</div>
                
                <div class="cell" style="grid-row:5; grid-column:2/4; font-size:10px;" onclick="betR(getArr('1-18'))">1-18</div>
                <div class="cell" style="grid-row:5; grid-column:4/6; font-size:10px;" onclick="betR(getArr('even'))">EVEN</div>
                <div class="cell" style="grid-row:5; grid-column:6/8;" onclick="betR(getArr('red'))"><div style="width:15px; height:15px; background:var(--red); transform:rotate(45deg);"></div></div>
                <div class="cell" style="grid-row:5; grid-column:8/10;" onclick="betR(getArr('black'))"><div style="width:15px; height:15px; background:#111; transform:rotate(45deg);"></div></div>
                <div class="cell" style="grid-row:5; grid-column:10/12; font-size:10px;" onclick="betR(getArr('odd'))">ODD</div>
                <div class="cell" style="grid-row:5; grid-column:12/14; font-size:10px;" onclick="betR(getArr('19-36'))">19-36</div>
            </div>

            <div class="chips-bar" style="margin-top:20px;">
                <div class="chip chip-50 active" onclick="setChip(50, this)"><div class="chip-label">50</div></div>
                <div class="chip chip-200" onclick="setChip(200, this)"><div class="chip-label">200</div></div>
                <div class="chip chip-1k" onclick="setChip(1000, this)"><div class="chip-label">1K</div></div>
                <div class="chip chip-10k" onclick="setChip(10000, this)"><div class="chip-label">10K</div></div>
                <div class="chip chip-100k" onclick="setChip(100000, this)"><div class="chip-label">100K</div></div>
            </div>
            
            <button onclick="clearRBets()" style="margin-top:10px; background:#333; color:white; border:1px solid #555; padding:5px 10px;">CLEAR BETS</button>
        </div>
        
        <div class="icon-controls">
            <div class="icon-btn" onclick="toggleChat()"><i class="fas fa-comment"></i></div>
            <div class="icon-btn" onclick="toggleMusic()"><i class="fas fa-music"></i></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let me="Guest", bal=0, room="lobby", chip=50;
        let isDiceRolling = false, isWheelSpinning = false;
        let currentRoundBets = []; // For Current Bet Panel

        // --- AUTH ---
        function login() { socket.emit('login', { username:document.getElementById('user').value, password:document.getElementById('pass').value }); }
        socket.on('login_success', d => { me=d.username; bal=d.balance; document.getElementById('authOverlay').style.display='none'; upd(); });
        socket.on('login_error', m => document.getElementById('loginErr').innerText=m);
        socket.on('update_balance', b => { bal=b; upd(); });
        function upd() { ['lBal','r-bal'].forEach(i=>document.getElementById(i).innerText=bal); document.getElementById('lUser').innerText=me; }

        // --- NAV ---
        function enter(r) {
            room=r; socket.emit('switch_room', r);
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+r).classList.add('active');
            document.getElementById('backBtn').style.display='block';
            document.getElementById('playerListPanel').classList.add('active');
            document.getElementById('betPanel').classList.add('active');
            document.getElementById('pttBtn').style.display='block';
            if(r==='roulette') initR();
            initAudio();
        }
        function goLobby() {
            room='lobby'; socket.emit('switch_room', 'lobby');
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-lobby').classList.add('active');
            document.getElementById('backBtn').style.display='none';
            document.getElementById('playerListPanel').classList.remove('active');
            document.getElementById('betPanel').classList.remove('active');
            document.getElementById('pttBtn').style.display='none';
            document.getElementById('chatPanel').classList.remove('active');
            document.getElementById('musicPanel').classList.remove('active');
        }

        // --- CHIPS ---
        function setChip(v, el) { 
            chip = v; 
            document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); 
            el.classList.add('active'); 
        }

        // --- CURRENT BET PANEL ---
        function addBetLog(desc, amt) {
            currentRoundBets.push({desc, amt});
            renderBetLog();
        }
        function renderBetLog() {
            let h = ''; let t = 0;
            currentRoundBets.forEach(b => {
                h += `<div class="bp-item"><span>${b.desc}</span><span>${b.amt}</span></div>`;
                t += b.amt;
            });
            document.getElementById('bpList').innerHTML = h;
            document.getElementById('bpTotal').innerText = t;
        }
        function clearBetLog() { currentRoundBets = []; renderBetLog(); }

        // --- DICE LOGIC ---
        function betCg(c) {
            if(isDiceRolling) return alert("BETS CLOSED!"); // CHECK ROLLING
            if(bal < chip) return alert("No funds");
            socket.emit('place_bet', {color:c, amount:chip});
            document.getElementById('b-'+c).innerText = parseInt(document.getElementById('b-'+c).innerText)+chip;
            addBetLog(c, chip);
        }
        socket.on('game_rolling', () => {
            isDiceRolling = true;
            document.getElementById('cg-status').innerText = "ROLLING...";
            document.querySelectorAll('.cg-btn').forEach(b => b.classList.add('disabled')); // UI LOCK
            let c = ['red','green','blue','yellow','pink','white'];
            window.rollInt = setInterval(() => { ['d1','d2','d3'].forEach(d => document.getElementById(d).className=`die ${c[Math.floor(Math.random()*6)]}`); }, 100);
        });
        socket.on('game_result', res => {
            clearInterval(window.rollInt);
            ['d1','d2','d3'].forEach((d,i) => document.getElementById(d).className=`die ${res[i].toLowerCase()}`);
            document.getElementById('cg-status').innerText = "RESULT";
        });
        socket.on('game_reset', () => {
            isDiceRolling = false;
            document.querySelectorAll('.cg-btn').forEach(b => b.classList.remove('disabled')); // UI UNLOCK
            document.querySelectorAll('.cg-btn span').forEach(s => s.innerText='0');
            document.getElementById('cg-status').innerText = "BETTING";
            clearBetLog();
        });
        socket.on('timer_update', t => document.getElementById('cg-time').innerText = t);

        // --- ROULETTE LOGIC ---
        const REDS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        function initR() {
            let g = document.getElementById('r-grid');
            if(document.getElementById('btn-1')) return;
            for(let i=1; i<=36; i++) {
                let d = document.createElement('div');
                d.className = `cell ${REDS.includes(i)?'red-cell':'black-cell'}`;
                d.innerText = i; d.id = `btn-${i}`;
                d.onclick = () => betR([i]);
                d.style.gridRow = (i%3===0)?1:(i%3===2?2:3);
                d.style.gridColumn = Math.floor((i-1)/3)+2;
                g.appendChild(d);
            }
            drawWheel(0);
        }
        function getArr(type) {
            let a = [];
            for(let i=1; i<=36; i++) {
                if(type=='red' && REDS.includes(i)) a.push(i);
                if(type=='black' && !REDS.includes(i)) a.push(i);
                if(type=='even' && i%2==0) a.push(i);
                if(type=='odd' && i%2!=0) a.push(i);
                if(type=='1-18' && i<=18) a.push(i);
                if(type=='19-36' && i>=19) a.push(i);
                if(type=='1st12' && i<=12) a.push(i);
                if(type=='2nd12' && i>12 && i<=24) a.push(i);
                if(type=='3rd12' && i>24) a.push(i);
                if(type=='row1' && i%3==0) a.push(i);
                if(type=='row2' && i%3==2) a.push(i);
                if(type=='row3' && i%3==1) a.push(i);
            }
            return a;
        }
        function betR(nums) {
            if(isWheelSpinning) return alert("BETS CLOSED");
            if(bal < chip) return alert("No Funds");
            socket.emit('place_bet_roulette', {numbers:nums, amount:chip});
            
            // Visual Chip on first number
            let id = nums.length===1 ? 'btn-'+nums[0] : (nums.length===18?'btn-red':'btn-0'); // Fallback visual
            // In a full implementation, you'd find the clicked element.
            // Simplified: Add to Bet Log
            let desc = nums.length === 1 ? "Num "+nums[0] : (nums.length===18?"Color/Half":"Group");
            addBetLog(desc, chip);
        }
        function clearRBets() { socket.emit('roulette_clear'); }
        
        socket.on('roulette_timer', t => document.getElementById('r-time').innerText = t);
        socket.on('roulette_spin_start', n => {
            isWheelSpinning = true;
            document.querySelectorAll('.cell').forEach(c => c.classList.add('disabled'));
            document.getElementById('wheel-overlay').classList.add('show');
            spinWheel(n);
        });
        socket.on('roulette_new_round', () => {
            isWheelSpinning = false;
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('disabled'));
            clearBetLog();
        });
        socket.on('bets_cleared', clearBetLog);
        socket.on('roulette_win', d => alert(`WINNER: ${d.number}! YOU WON ${d.amount}`));

        // --- CANVAS WHEEL ---
        const WHEEL = ["0","32","15","19","4","21","2","25","17","34","6","27","13","36","11","30","8","23","10","5","24","16","33","1","20","14","31","9","22","18","29","7","28","12","35","3","26"];
        function drawWheel(ang) {
            let ctx = document.getElementById('wheelCanvas').getContext('2d');
            ctx.clearRect(0,0,600,600);
            ctx.save(); ctx.translate(300,300); ctx.rotate(ang);
            let slice = (Math.PI*2)/37;
            WHEEL.forEach((n,i) => {
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,280, i*slice, (i+1)*slice);
                ctx.fillStyle = n=="0"?'#060':(REDS.includes(parseInt(n))?'#b00':'#111');
                ctx.fill(); ctx.stroke();
                ctx.save(); ctx.rotate(i*slice + slice/2); ctx.fillStyle="white"; ctx.font="bold 24px Arial"; ctx.fillText(n, 220, 10); ctx.restore();
            });
            ctx.restore();
        }
        function spinWheel(target) {
            let idx = WHEEL.indexOf(target.toString());
            let slice = (Math.PI*2)/37;
            let dest = (Math.PI*2*5) - (idx*slice) - (slice/2);
            let start;
            function anim(ts) {
                if(!start) start=ts; let p=(ts-start)/5000;
                if(p>1) p=1;
                drawWheel(dest*(1 - Math.pow(1-p, 3)));
                if(p<1) requestAnimationFrame(anim);
                else setTimeout(()=>{document.getElementById('wheel-overlay').classList.remove('show')}, 2000);
            }
            requestAnimationFrame(anim);
        }

        // --- PANELS (ORIGINAL STYLE) ---
        function toggleChat() { let p=document.getElementById('chatPanel'); p.classList.toggle('active'); }
        function sendChat() { let i=document.getElementById('chatInput'); if(i.value) socket.emit('chat_msg',{msg:i.value, room:room}); i.value=''; }
        socket.on('chat_broadcast', d => { let b=document.getElementById('chatBox'); b.innerHTML+=`<div><b>${d.user}:</b> ${d.msg}</div>`; b.scrollTop=b.scrollHeight; });

        function toggleMusic() { let p=document.getElementById('musicPanel'); p.classList.toggle('active'); }
        const audio = document.getElementById('audioEl');
        function playMusic() { audio.src="https://cdn.pixabay.com/audio/2022/11/22/audio_febc508520.mp3"; audio.play(); }
        function pauseMusic() { audio.pause(); }
        function playCustom() { audio.src=document.getElementById('musicUrl').value; audio.play(); }

        // --- VOICE ---
        let audioCtx, mediaStream;
        function initAudio() { /* Placeholder */ }
        function toggleVoice() {
            if(mediaStream) return;
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                mediaStream = s;
                audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                let src = audioCtx.createMediaStreamSource(s);
                let p = audioCtx.createScriptProcessor(4096, 1, 1);
                src.connect(p); p.connect(audioCtx.destination);
                p.onaudioprocess = e => {
                    let d = e.inputBuffer.getChannelData(0);
                    let sum=0; for(let i=0;i<d.length;i++) sum+=d[i]*d[i];
                    if(Math.sqrt(sum/d.length) > 0.02) {
                        socket.emit('voice_status', true);
                        let b = new ArrayBuffer(d.length*2); let v = new DataView(b);
                        for(let i=0;i<d.length;i++) { let s=Math.max(-1,Math.min(1,d[i])); v.setInt16(i*2,s<0?s*0x8000:s*0x7FFF,true); }
                        socket.emit('voice_data', b);
                    } else socket.emit('voice_status', false);
                };
            });
        }
        socket.on('voice_receive', d => {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            let i16 = new Int16Array(d.audio); let f32 = new Float32Array(i16.length);
            for(let i=0;i<i16.length;i++) f32[i] = i16[i] / (i16[i]<0?0x8000:0x7FFF);
            let b = audioCtx.createBuffer(1, f32.length, audioCtx.sampleRate);
            b.getChannelData(0).set(f32);
            let s = audioCtx.createBufferSource(); s.buffer=b; s.connect(audioCtx.destination); s.start(0);
        });
        socket.on('room_users_update', list => {
            document.getElementById('plList').innerHTML = list.map(u=>`<div class="pp-item" id="u-${u.id}"><i class="fas fa-microphone"></i> ${u.username}</div>`).join('');
        });
        socket.on('player_voice_update', d => {
            let el = document.getElementById('u-'+d.id);
            if(el) d.talking ? el.classList.add('talking') : el.classList.remove('talking');
        });
    </script>
</body>
</html>
