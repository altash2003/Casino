<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASINO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* GLOBAL */
        body { margin: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color:white; }
        .view-section { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; }
        .view-section.active { display: flex; }
        .global-back { position: fixed; top: 10px; left: 10px; z-index: 9000; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-weight: bold; display: none; }

        /* AUTH */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: #111; border: 1px solid #333; padding: 40px; border-radius: 12px; text-align: center; width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; box-sizing:border-box; }
        .auth-btn { width: 100%; padding: 12px; background: #FFD700; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* CHAT PANEL (Smaller Casual Size) */
        .chat-panel { position: fixed; bottom: 80px; right: 20px; width: 280px; height: 350px; background: rgba(20,20,20,0.95); border: 1px solid #444; border-radius: 12px; display: flex; flex-direction: column; z-index: 8000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); display:none; }
        .chat-panel.active { display:flex; }
        .chat-header { padding: 8px; text-align: center; font-weight: bold; background: #111; color: #888; font-size: 11px; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center; border-radius: 12px 12px 0 0; }
        .chat-tabs { display: flex; border-bottom: 1px solid #333; }
        .chat-tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; background: #111; color: #888; font-weight: bold; font-size: 12px; }
        .chat-tab.active { background: #222; color: #FFD700; border-bottom: 2px solid #FFD700; }
        .chat-content { flex: 1; overflow-y: auto; padding: 10px; display: none; }
        .chat-content.active { display: block; }
        .chat-input-area { padding: 8px; border-top: 1px solid #333; display: flex; background: #1a1a1a; border-radius: 0 0 12px 12px; }
        .chat-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 6px; font-size: 12px; }
        .chat-msg { margin-bottom: 6px; font-size: 12px; word-wrap: break-word; }

        /* MUSIC PLAYER */
        .music-player { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); width: 260px; background: rgba(0,0,0,0.9); border: 1px solid #444; border-radius: 8px; padding: 10px; z-index: 9500; display: none; }
        .mp-title { font-size: 11px; color: #FFD700; margin-bottom: 5px; font-weight: bold; display: flex; justify-content: space-between; }
        .mp-controls { display: flex; gap: 5px; margin-bottom: 5px; }
        .mp-btn { background: #333; border: 1px solid #555; color: white; flex: 1; cursor: pointer; font-size: 10px; padding: 5px; }
        .mp-input { width: 100%; background: #222; border: 1px solid #444; color: #aaa; padding: 4px; box-sizing: border-box; font-size: 10px; margin-bottom: 5px; }
        .mp-status { font-size: 10px; color: #00E5FF; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom:5px; }
        
        /* CUSTOM VOLUME SLIDER (Small Circle) */
        .vol-slider { -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none; }
        .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%; background: #FFD700; cursor: pointer; transition: 0.2s; }
        .vol-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* LOBBY */
        #view-lobby { background: url('background.jpg') center/cover; flex-direction: column; justify-content: center; align-items: center; gap: 30px; }
        .lobby-grid { display: flex; gap: 40px; }
        .game-card { width: 260px; height: 360px; background: rgba(0,0,0,0.85); border: 2px solid #333; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .game-card:hover { border-color: #FFD700; transform: translateY(-10px); }
        .gc-title { font-size: 32px; color: #FFD700; font-weight: 800; margin-bottom: 20px; }
        .gc-icon { font-size: 60px; margin-bottom: 20px; }

        /* COLOR GAME HUD */
        .cg-top-bar { display:flex; justify-content:center; gap:40px; width:100%; padding:20px; box-sizing:border-box; background:rgba(0,0,0,0.3); }
        .hud-stat { text-align:center; }
        .hud-stat label { font-size:10px; color:#888; font-weight:bold; letter-spacing:1px; display:block; }
        .hud-stat div { font-size:24px; font-weight:bold; color:white; }

        /* COLOR GAME */
        #view-colorgame { background: url('background.jpg') center/cover; justify-content: center; align-items: center; }
        .cg-main-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cg-timer { font-size: 100px; font-weight: 800; text-shadow: 0 0 20px cyan; line-height: 1; }
        .cg-status { font-size: 24px; letter-spacing: 5px; color: #aaa; margin-bottom: 20px; }
        .cg-dice-row { display: flex; gap: 20px; justify-content: center; }
        .die { width: 90px; height: 90px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid rgba(255,255,255,0.2); background: #222; }
        .die.red { background: #d32f2f; } .die.green { background: #388e3c; } .die.blue { background: #1976d2; }
        .die.pink { background: #e91e63; } .die.white { background: #eee; color:black; } .die.yellow { background: #fbc02d; color:black; }
        .cg-bet-panel { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; border: 1px solid #444; margin-top: 30px; }
        .cg-bet-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .cg-bet-card { width: 80px; height: 100px; border: 1px solid #555; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; box-sizing: border-box; transition: 0.2s; }
        .cg-chip-rack { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .cg-chip { width: 35px; height: 35px; border-radius: 50%; background: #222; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 11px; }
        .cg-chip.active { border-color: #FFD700; background: #444; color: #FFD700; transform: scale(1.1); }

        /* ROULETTE */
        :root { --bg-felt: #01431E; --grid-gold: #F3C620; --cell-red: #d32f2f; --cell-black: #222; }
        #view-roulette { background-color: #05140a; background-image: radial-gradient(circle at 50% 50%, #012b13 0%, #000000 100%); flex-direction: column; align-items: center; justify-content: center; overflow:hidden; }
        
        .r-main-area { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; transform-origin: center center; }
        
        /* WHEEL POPUP (FROM FILE) */
        #wheel-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: 500px; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; transition: opacity 0.5s ease; }
        #wheel-overlay.show { display: flex; animation: fadeIn 0.3s; opacity: 1; }
        .wheelPanel { width: 500px; max-width: 95vw; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-radius: 50%; filter: drop-shadow(0 20px 50px rgba(0,0,0,0.8)); }
        .stage { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        canvas { border-radius: 50%; width: 100%; height: 100%; object-fit: contain; }
        .pointer { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 36px solid #f0e6d2; z-index: 5005; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); pointer-events: none; transition: opacity 0.5s ease; opacity: 1; }

        /* ROULETTE HUD */
        .r-hud-row { display:flex; gap:20px; margin-bottom:10px; width: 100%; justify-content:center; }
        .r-hud-box { background:#111; border:1px solid #444; border-radius:8px; padding:10px 20px; text-align:center; min-width:100px; }
        .r-lbl { font-size:10px; color:#888; letter-spacing:1px; font-weight:bold; }
        .r-val { font-size:24px; color:white; font-weight:bold; }
        
        .r-table-wrapper { position: relative; background-color: var(--bg-felt); padding: 15px; border-radius: 20px; border: 8px solid #002b12; box-shadow: 0 0 0 10px #F3C620; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: transform 0.2s; }
        .r-history { width: 100%; height: 35px; background: rgba(0,0,0,0.3); border-radius: 5px; display: flex; align-items: center; gap: 5px; overflow: hidden; padding: 0 5px; }
        .hist-ball { width: 28px; height: 28px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 11px; }
        .hist-red { background: #d32f2f; } .hist-black { background: #222; } .hist-green { background: #016D29; }
        .r-grid { display: grid; grid-template-columns: 50px repeat(12, 42px) 34px; grid-template-rows: repeat(3, 42px) 42px 42px; gap: 2px; padding: 5px; border: 2px solid var(--grid-gold); border-radius: 8px; background: rgba(0,0,0,0.2); }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; cursor: pointer; border: 2px solid var(--grid-gold); }
        .red-cell { background-color: var(--cell-red); } .black-cell { background-color: var(--cell-black); }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; border-radius: 10px 0 0 10px; }
        .zone-2to1 { grid-column: 14; writing-mode: vertical-rl; color: #F3C620; font-size: 9px; }
        .label-cell { font-size: 10px; text-transform: uppercase; }
        .zone-dozen { grid-row: 4; } .doz-1 { grid-column: 2 / 6; } .doz-2 { grid-column: 6 / 10; } .doz-3 { grid-column: 10 / 14; }
        .zone-bottom { grid-row: 5; } .low { grid-column: 2 / 4; } .even { grid-column: 4 / 6; } .odd { grid-column: 10 / 12; } .high { grid-column: 12 / 14; }
        .diamond-cell { grid-column: 6 / 8; grid-row: 5; display:flex; justify-content:center; align-items:center; } .diamond-cell.blk { grid-column: 8 / 10; }
        .diamond { width: 18px; height: 18px; transform: rotate(45deg); } .diamond.red { background: #d32f2f; } .diamond.black { background: #111; }
        .r-chip-marker { width: 22px; height: 22px; border-radius: 50%; background: white; color: black; position: absolute; z-index: 100; font-size: 9px; display: flex; justify-content: center; align-items: center; font-weight: bold; pointer-events: none; border: 2px dashed #333; }
        
        /* BOTTOM CONTROLS */
        .bottom-controls { display:flex; gap:20px; margin-top:15px; }
        .control-btn { background:rgba(255,255,255,0.1); border:1px solid #555; padding:10px 20px; border-radius:20px; color:white; font-weight:bold; cursor:pointer; display:flex; gap:10px; align-items:center; transition:0.2s; }
        .control-btn:hover { background:rgba(255,255,255,0.2); }

        #winner-stage { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 4000; display:none; justify-content:center; align-items:center; }
        #winner-stage.active { display:flex; }
        .win-box { background: #222; border: 4px solid #FFD700; padding: 20px; border-radius: 10px; text-align: center; animation: popIn 0.3s; }
        .win-num { font-size: 60px; font-weight: 800; }
        .win-amt { font-size: 30px; color: #FFD700; }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:#FFD700; margin-bottom:20px;">CASINO LOGIN</h1>
            <input id="user" class="auth-input" placeholder="USERNAME">
            <input id="pass" class="auth-input" type="password" placeholder="PASSWORD">
            <button onclick="login()" class="auth-btn">ENTER</button>
            <button onclick="register()" class="auth-btn" style="background:transparent; border:1px solid #555; color:#aaa; font-size:12px;">REGISTER</button>
            <div id="loginErr" style="color:red; margin-top:5px;"></div>
        </div>
    </div>

    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span id="chatTitle">GLOBAL</span>
            <span onclick="toggleChat()" style="cursor:pointer; font-size:16px;">&times;</span>
        </div>
        <div class="chat-tabs">
            <div class="chat-tab active" onclick="tabChat('public')">PUBLIC</div>
            <div class="chat-tab" onclick="tabChat('support')">SUPPORT</div>
        </div>
        <div id="tab-public" class="chat-content active">
            <div id="chatList" style="height:100%;"></div>
        </div>
        <div id="tab-support" class="chat-content">
            <div id="supportList" style="height:100%;"></div>
        </div>
        <div class="chat-input-area" id="input-public">
            <input id="chatInput" class="chat-input" placeholder="Type here...">
            <button onclick="sendChat()" style="background:#FFD700; border:none; padding:0 10px; cursor:pointer; font-weight:bold; border-radius:4px;">></button>
        </div>
        <div class="chat-input-area" id="input-support" style="display:none;">
            <input id="supportInput" class="chat-input" placeholder="Message Admin...">
            <button onclick="sendSupport()" style="background:#00E5FF; border:none; padding:0 10px; cursor:pointer; font-weight:bold; border-radius:4px;">></button>
        </div>
    </div>

    <div class="music-player" id="globalMusicPlayer">
        <div class="mp-title">
            <span>CASINO DJ</span>
            <span onclick="toggleMusicUI()" style="cursor:pointer;">x</span>
        </div>
        <div class="mp-controls">
            <button class="mp-btn" onclick="toggleMusic()"><i class="fa fa-play"></i> / <i class="fa fa-pause"></i></button>
            <button class="mp-btn" onclick="stopMusic()"><i class="fa fa-stop"></i></button>
        </div>
        <input class="mp-input" id="musicUrl" placeholder="MP3 URL here...">
        <button class="mp-btn" style="width:100%" onclick="playCustom()">PLAY CUSTOM</button>
        <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
            <i class="fa fa-volume-down" style="font-size:10px; color:#aaa;"></i>
            <input type="range" class="vol-slider" min="0" max="100" step="5" value="20" onchange="setVolume(this.value)">
            <i class="fa fa-volume-up" style="font-size:10px; color:#aaa;"></i>
        </div>
        <div class="mp-status" id="mpStatus">Ready</div>
        <audio id="audioEl" loop></audio>
    </div>

    <button class="global-back" id="backBtn" onclick="goToLobby()">‚Üê LOBBY</button>

    <div id="view-lobby" class="view-section active">
        <h1 style="font-size:60px; color:#FFD700; text-shadow:0 0 20px rgba(0,0,0,0.8); margin-bottom:10px;">GRAND CASINO</h1>
        <div style="margin-bottom:20px; font-size:18px;">
            PLAYER: <span id="lobbyUser" style="color:#FFD700; font-weight:bold;">Guest</span> | 
            BALANCE: <span id="lobbyBal" style="color:#00E5FF; font-weight:bold;">$0</span>
        </div>
        <div class="lobby-grid">
            <div class="game-card" onclick="enterGame('colorgame')">
                <div class="gc-title">COLOR GAME</div>
                <div class="gc-icon">üé®</div>
                <div class="gc-count" id="count-colorgame">0 Playing</div>
            </div>
            <div class="game-card" onclick="enterGame('roulette')">
                <div class="gc-title">ROULETTE</div>
                <div class="gc-icon">üé°</div>
                <div class="gc-count" id="count-roulette">0 Playing</div>
            </div>
        </div>
    </div>

    <div id="view-colorgame" class="view-section">
        <div class="cg-main-area">
            
            <div class="cg-top-bar">
                <div class="hud-stat">
                    <label>BALANCE</label>
                    <div id="cg-balance" style="color:#00E5FF">0</div>
                </div>
                <div class="hud-stat">
                    <label>TIMER</label>
                    <div id="cg-timer" style="color:#FFD700">20</div>
                </div>
                <div class="hud-stat">
                    <label>BET</label>
                    <div id="cg-bet-total">0</div>
                </div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div class="cg-status" id="cg-status">BETS OPEN</div>
                <div class="cg-dice-row">
                    <div id="d1" class="die">?</div>
                    <div id="d2" class="die">?</div>
                    <div id="d3" class="die">?</div>
                </div>
            </div>

            <div class="bottom-controls" style="margin-bottom:10px;">
                <div class="control-btn" onclick="toggleMusicUI()"><span>üéµ</span> MUSIC</div>
                <div class="control-btn" onclick="toggleChat()"><span>üí¨</span> CHAT</div>
            </div>

            <div class="cg-bet-panel">
                <div class="cg-chip-rack">
                    <div class="cg-chip active" onclick="setCgChip(50, this)">50</div>
                    <div class="cg-chip" onclick="setCgChip(100, this)">100</div>
                    <div class="cg-chip" onclick="setCgChip(500, this)">500</div>
                    <div class="cg-chip" onclick="setCgChip(1000, this)">1K</div>
                </div>
                <div class="cg-bet-grid">
                    <div class="cg-bet-card" style="background: #d32f2f;" onclick="placeCgBet('RED')"><b>RED</b><span id="cg-bet-RED">0</span></div>
                    <div class="cg-bet-card" style="background: #388e3c;" onclick="placeCgBet('GREEN')"><b>GREEN</b><span id="cg-bet-GREEN">0</span></div>
                    <div class="cg-bet-card" style="background: #1976d2;" onclick="placeCgBet('BLUE')"><b>BLUE</b><span id="cg-bet-BLUE">0</span></div>
                    <div class="cg-bet-card" style="background: #fbc02d; color:black;" onclick="placeCgBet('YELLOW')"><b>YEL</b><span id="cg-bet-YELLOW">0</span></div>
                    <div class="cg-bet-card" style="background: #e91e63;" onclick="placeCgBet('PINK')"><b>PINK</b><span id="cg-bet-PINK">0</span></div>
                    <div class="cg-bet-card" style="background: #eee; color:black;" onclick="placeCgBet('WHITE')"><b>WHT</b><span id="cg-bet-WHITE">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-roulette" class="view-section">
        <div id="wheel-overlay">
            <div class="wheelPanel">
                <div class="stage">
                    <div class="pointer"></div>
                    <canvas id="wheelCanvas" width="800" height="800"></canvas>
                </div>
            </div>
        </div>
        
        <div id="winner-stage">
            <div class="win-box">
                <div class="win-num" id="win-num-display">0</div>
                <div class="win-amt" id="win-amt-display">+0</div>
            </div>
        </div>

        <div class="r-main-area">
            
            <div class="r-hud-row">
                <div class="r-hud-box" style="border-color:#00E5FF">
                    <div class="r-lbl">BALANCE</div>
                    <div class="r-val" id="r-balance">0</div>
                </div>
                <div class="r-hud-box" style="border-color:#FFD700">
                    <div class="r-lbl">TIMER</div>
                    <div class="r-val" id="r-timer">--</div>
                </div>
                <div class="r-hud-box">
                    <div class="r-lbl">BET</div>
                    <div class="r-val" id="r-bet-display">0</div>
                </div>
            </div>

            <div class="r-table-wrapper" id="rWrapper">
                <div class="r-history" id="rHistory"></div>
                
                <div class="r-grid" id="grid">
                    <div style="position:absolute; inset:0; z-index:50;" id="rOverlay"></div>
                    <div class="cell zone-0" id="cell-0">0</div>
                    <div class="cell zone-2to1" style="grid-row:1" id="btn-row1">2to1</div>
                    <div class="cell zone-2to1" style="grid-row:2" id="btn-row2">2to1</div>
                    <div class="cell zone-2to1" style="grid-row:3" id="btn-row3">2to1</div>
                    <div class="cell label-cell zone-dozen doz-1" id="btn-doz1">1st 12</div>
                    <div class="cell label-cell zone-dozen doz-2" id="btn-doz2">2nd 12</div>
                    <div class="cell label-cell zone-dozen doz-3" id="btn-doz3">3rd 12</div>
                    <div class="cell label-cell zone-bottom low" id="btn-low">1-18</div>
                    <div class="cell label-cell zone-bottom even" id="btn-even">EVEN</div>
                    <div class="cell label-cell diamond-cell" id="btn-red"><div class="diamond red"></div></div>
                    <div class="cell label-cell diamond-cell blk" id="btn-black"><div class="diamond black"></div></div>
                    <div class="cell label-cell zone-bottom odd" id="btn-odd">ODD</div>
                    <div class="cell label-cell zone-bottom high" id="btn-high">19-36</div>
                    </div>
                
                <div class="cg-chip-rack">
                    <div class="cg-chip r-chip-btn active" onclick="setRChip(50, this)">50</div>
                    <div class="cg-chip r-chip-btn" onclick="setRChip(100, this)">100</div>
                    <div class="cg-chip r-chip-btn" onclick="setRChip(500, this)">500</div>
                    <div class="cg-chip r-chip-btn" onclick="setRChip(1000, this)">1k</div>
                </div>
            </div>

            <div class="bottom-controls">
                <div class="control-btn" onclick="toggleMusicUI()"><span>üéµ</span> MUSIC</div>
                <div class="control-btn" onclick="toggleChat()"><span>üí¨</span> CHAT</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUser = "Guest";
        let myBal = 0;
        let currentRoom = 'lobby';

        // --- AUTH ---
        const sU = localStorage.getItem('u'); const sP = localStorage.getItem('p');
        if(sU && sP) socket.emit('login', { username: sU, password: sP });

        function login() { socket.emit('login', { username: document.getElementById('user').value, password: document.getElementById('pass').value }); }
        function register() { socket.emit('register', { username: document.getElementById('user').value, password: document.getElementById('pass').value }); }
        
        socket.on('login_success', (data) => {
            localStorage.setItem('u', data.username); localStorage.setItem('p', document.getElementById('pass').value || sP);
            document.getElementById('authOverlay').style.display = 'none';
            myUser = data.username; myBal = data.balance;
            updateDisplay();
        });
        socket.on('login_error', (m) => document.getElementById('loginErr').innerText = m);
        socket.on('update_balance', (b) => { myBal = b; updateDisplay(); });
        function updateDisplay() {
            document.getElementById('lobbyUser').innerText = myUser;
            document.getElementById('lobbyBal').innerText = '$' + myBal;
            document.getElementById('cg-balance').innerText = '$' + myBal;
            document.getElementById('r-balance').innerText = '$' + myBal;
        }

        // --- CHAT ---
        function toggleChat() {
            let p = document.getElementById('chatPanel');
            p.classList.toggle('active');
        }
        function tabChat(t) {
            document.querySelectorAll('.chat-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.chat-tab').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.chat-input-area').forEach(e=>e.style.display='none');
            document.getElementById('tab-'+t).classList.add('active');
            document.getElementById('input-'+t).style.display='flex';
            event.target.classList.add('active');
        }
        function sendChat() { 
            let i = document.getElementById('chatInput'); 
            if(i.value) { socket.emit('chat_msg', { msg: i.value, room: currentRoom }); i.value=''; } 
        }
        function sendSupport() { 
            let i = document.getElementById('supportInput'); 
            if(i.value) { socket.emit('support_msg', { msg: i.value, room: currentRoom }); i.value=''; } 
        }
        
        socket.on('chat_broadcast', (d) => {
            if(d.room && d.room !== currentRoom) return;
            let box = (d.type === 'public' || d.type === 'public_admin') ? document.getElementById('chatList') : document.getElementById('supportList');
            let col = d.type === 'public_admin' ? '#FF3D00' : '#FFD700';
            if(d.type.includes('support')) col = '#00E5FF';
            box.innerHTML += `<div class="chat-msg"><b style="color:${col}">${d.user}:</b> ${d.msg}</div>`;
            box.scrollTop = box.scrollHeight;
        });
        socket.on('chat_history', (hist) => {
            let box = document.getElementById('chatList'); box.innerHTML = '';
            hist.forEach(d => {
                box.innerHTML += `<div class="chat-msg"><b style="color:#FFD700">${d.user}:</b> ${d.msg}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        // --- MUSIC ---
        const audio = document.getElementById('audioEl');
        const DEFAULT_MUSIC = "https://cdn.pixabay.com/audio/2022/11/22/audio_febc508520.mp3"; 
        audio.volume = 0.2; // Default 20%

        function toggleMusicUI() {
            let p = document.getElementById('globalMusicPlayer');
            p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none';
        }
        function toggleMusic() {
            if(audio.paused) { 
                if(!audio.src) audio.src = DEFAULT_MUSIC;
                audio.play(); 
                document.getElementById('mpStatus').innerText = "Playing: Standard Jazz";
            } else { audio.pause(); }
        }
        function stopMusic() { audio.pause(); audio.currentTime=0; document.getElementById('mpStatus').innerText = "Stopped"; }
        function playCustom() {
            let url = document.getElementById('musicUrl').value;
            if(url) {
                audio.src = url;
                audio.play();
                document.getElementById('mpStatus').innerText = "Playing Custom";
            }
        }
        function setVolume(v) {
            audio.volume = v / 100;
        }

        // --- NAV ---
        function enterGame(g) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+g).classList.add('active');
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('chatTitle').innerText = g.toUpperCase() + " CHAT";
            document.getElementById('chatList').innerHTML = '';
            
            // Auto Scale Roulette
            if(g === 'roulette') {
                scaleRoulette();
                window.addEventListener('resize', scaleRoulette);
                initRoulette();
            } else {
                window.removeEventListener('resize', scaleRoulette);
            }
            
            currentRoom = g;
            socket.emit('switch_room', g);
        }
        
        function scaleRoulette() {
            let h = window.innerHeight;
            let wrapper = document.getElementById('rWrapper');
            // Basic scale logic: if height < 800, scale down
            let scale = Math.min(1, h / 800);
            if(scale < 0.6) scale = 0.6;
            wrapper.style.transform = `scale(${scale})`;
        }

        function goToLobby() {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-lobby').classList.add('active');
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('chatPanel').classList.remove('active');
            currentRoom = 'lobby';
            socket.emit('switch_room', 'lobby');
            clearRoulette();
        }
        socket.on('lobby_counts', (c) => {
            document.getElementById('count-colorgame').innerText = (c.colorgame||0) + " Playing";
            document.getElementById('count-roulette').innerText = (c.roulette||0) + " Playing";
        });
        socket.on('notification', (d) => alert(d.msg));


        // --- COLOR GAME ---
        let cgChip = 50;
        let cgBetTotal = 0;
        function setCgChip(v, el) { cgChip = v; document.querySelectorAll('.cg-chip').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
        function placeCgBet(c) {
            if(myBal < cgChip) { alert("Insufficient funds"); return; }
            myBal -= cgChip; updateDisplay();
            cgBetTotal += cgChip; document.getElementById('cg-bet-total').innerText = cgBetTotal;
            socket.emit('place_bet', { color: c, amount: cgChip });
            let el = document.getElementById('cg-bet-'+c); el.innerText = parseInt(el.innerText)+cgChip;
        }
        socket.on('timer_update', (t) => { if(currentRoom==='colorgame') { document.getElementById('cg-timer').innerText = t; document.getElementById('cg-status').innerText = "BETS OPEN"; }});
        socket.on('game_rolling', () => { if(currentRoom==='colorgame') { document.getElementById('cg-status').innerText = "ROLLING..."; document.getElementById('cg-timer').innerText="--"; cgRoll(); }});
        function cgRoll() { 
            let cols=['red','green','blue','yellow','pink','white'];
            window.cgInt = setInterval(() => { ['d1','d2','d3'].forEach(id => document.getElementById(id).className=`die ${cols[Math.floor(Math.random()*6)]}`); }, 100);
        }
        socket.on('game_result', (r) => { 
            clearInterval(window.cgInt); 
            if(currentRoom==='colorgame') {
                document.getElementById('cg-status').innerText="RESULT";
                ['d1','d2','d3'].forEach((id,i) => document.getElementById(id).className=`die ${r[i].toLowerCase()}`);
            }
        });
        socket.on('game_reset', () => { 
            ['RED','GREEN','BLUE','YELLOW','PINK','WHITE'].forEach(c=>document.getElementById('cg-bet-'+c).innerText='0');
            cgBetTotal = 0; document.getElementById('cg-bet-total').innerText = '0';
        });
        socket.on('win_notification', (d) => alert(`WIN! +${d.amount}`));


        // --- ROULETTE ---
        const REDS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        let rChip = 50; let rBetTotal = 0;
        function setRChip(v, el) { rChip = v; document.querySelectorAll('.r-chip-btn').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
        
        function initRoulette() {
            let grid = document.getElementById('grid');
            if(document.getElementById('cell-1')) return;
            for(let i=1; i<=36; i++) {
                let d = document.createElement('div');
                d.className = `cell ${REDS.includes(i)?'red-cell':'black-cell'}`;
                d.innerText = i; d.id = `cell-${i}`;
                let row = (i%3===0)?1:(i%3===2?2:3); let col = Math.floor((i-1)/3)+2;
                d.style.gridRow = row; d.style.gridColumn = col;
                grid.appendChild(d);
                bindClick(d, [i]);
            }
            bindClick(document.getElementById('cell-0'), [0]);
            bindClick(document.getElementById('btn-red'), REDS);
            bindClick(document.getElementById('btn-black'), range(1,36).filter(x=>!REDS.includes(x)));
            bindClick(document.getElementById('btn-even'), range(1,36).filter(x=>x%2===0));
            bindClick(document.getElementById('btn-odd'), range(1,36).filter(x=>x%2!==0));
            bindClick(document.getElementById('btn-low'), range(1,18));
            bindClick(document.getElementById('btn-high'), range(19,36));
            bindClick(document.getElementById('btn-doz1'), range(1,12));
            bindClick(document.getElementById('btn-doz2'), range(13,24));
            bindClick(document.getElementById('btn-doz3'), range(25,36));
            
            drawWheel(0);
        }
        
        function range(s,e) { return Array.from({length:e-s+1},(_,i)=>s+i); }
        function bindClick(el, nums) {
            if(!el) return;
            el.onclick = function(e) {
                if(myBal < rChip) { alert("Insufficient funds"); return; }
                myBal -= rChip; updateDisplay();
                rBetTotal += rChip; document.getElementById('r-bet-display').innerText = rBetTotal;
                
                let rect = el.getBoundingClientRect();
                let wrap = document.getElementById('rWrapper').getBoundingClientRect();
                let x = rect.left - wrap.left + rect.width/2;
                let y = rect.top - wrap.top + rect.height/2;
                
                let mk = document.createElement('div');
                mk.className = 'r-chip-marker'; mk.innerText = rChip;
                mk.style.left = x+'px'; mk.style.top = y+'px';
                document.getElementById('rOverlay').appendChild(mk);

                socket.emit('place_bet_roulette', { numbers: nums, amount: rChip });
            }
        }

        function clearRoulette() {
            rBetTotal=0; document.getElementById('r-bet-display').innerText='0';
            document.getElementById('rOverlay').innerHTML='';
            document.getElementById('winner-stage').classList.remove('active');
        }

        socket.on('roulette_timer', (t) => { if(currentRoom==='roulette') { document.getElementById('r-timer').innerText = t; document.getElementById('wheel-overlay').classList.remove('show'); }});
        
        socket.on('roulette_spin_start', (wNum) => {
            if(currentRoom==='roulette') {
                document.getElementById('wheel-overlay').classList.add('show');
                spinWheel(wNum);
            }
        });
        
        socket.on('roulette_result_log', (n) => {
             let h = document.getElementById('rHistory');
             let b = document.createElement('div');
             b.className = `hist-ball ${n===0?'hist-green':(REDS.includes(n)?'hist-red':'hist-black')}`;
             b.innerText = n;
             h.prepend(b);
             if(h.children.length > 12) h.lastChild.remove();
        });

        socket.on('roulette_win', (d) => {
            let stage = document.getElementById('winner-stage');
            stage.classList.add('active');
            document.getElementById('win-num-display').innerText = d.number;
            document.getElementById('win-num-display').style.color = d.number===0?'green':(REDS.includes(d.number)?'red':'white');
            document.getElementById('win-amt-display').innerText = '+' + d.amount;
            setTimeout(() => stage.classList.remove('active'), 4000);
        });
        
        socket.on('roulette_new_round', clearRoulette);

        // --- NEW HD WHEEL LOGIC (Copied from WHEEL ONLY.html) ---
        const cvs = document.getElementById('wheelCanvas'); const ctx = cvs.getContext('2d');
        const W = 800, H = 800, CX = 400, CY = 400;
        const R_TRACK_OUTER = 380, R_TRACK_INNER = 330, R_POCKETS = 320, R_NUMBERS = 250, R_HUB = 90;
        const WHEEL = ["0","32","15","19","4","21","2","25","17","34","6","27","13","36","11","30","8","23","10","5","24","16","33","1","20","14","31","9","22","18","29","7","28","12","35","3","26"];
        
        function getLabelColor(lbl) { if(lbl==="0") return "#165b33"; return REDS.includes(parseInt(lbl)) ? "#c03a35" : "#111"; }

        function drawWheel(angle = 0) {
            ctx.clearRect(0,0,W,H);
            // Outer Ring
            let grad = ctx.createRadialGradient(CX, CY, R_TRACK_INNER, CX, CY, R_TRACK_OUTER);
            grad.addColorStop(0, "#3a1f12"); grad.addColorStop(0.4, "#63391f"); grad.addColorStop(0.9, "#211108"); grad.addColorStop(1, "#000");
            ctx.beginPath(); ctx.arc(CX, CY, R_TRACK_OUTER, 0, Math.PI*2); ctx.fillStyle = grad; ctx.fill();
            // Inner
            ctx.beginPath(); ctx.arc(CX, CY, R_TRACK_INNER, 0, Math.PI*2); ctx.fillStyle = "#0a2118"; ctx.fill();

            ctx.save(); ctx.translate(CX, CY); ctx.rotate(angle);
            
            WHEEL.forEach((lbl, i) => drawWedge(i, lbl, 1.0, false));
            
            // Hub
            ctx.beginPath(); ctx.arc(0,0, R_HUB, 0, Math.PI*2);
            let hGrad = ctx.createRadialGradient(0,0, 20, 0,0, R_HUB); hGrad.addColorStop(0, "#666"); hGrad.addColorStop(1, "#222");
            ctx.fillStyle = hGrad; ctx.fill();
            // Gold Ring
            ctx.beginPath(); ctx.arc(0,0, R_HUB-5, 0, Math.PI*2); ctx.strokeStyle = "#c9a44c"; ctx.lineWidth = 4; ctx.stroke();
            // Pin
            ctx.beginPath(); ctx.arc(0,0, 30, 0, Math.PI*2); ctx.fillStyle = "#444"; ctx.fill();
            ctx.restore();
        }

        function drawWedge(i, lbl, scale = 1.0, glow = false) {
            const ang = i * ((Math.PI*2)/WHEEL.length); const slice = (Math.PI*2)/WHEEL.length;
            ctx.save();
            if (scale !== 1.0) { const mid = ang+slice/2; ctx.rotate(mid); ctx.scale(scale, scale); ctx.rotate(-mid); if(glow){ctx.shadowColor="#FFF"; ctx.shadowBlur=30;} }
            
            // Path
            ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0, R_POCKETS, ang, ang+slice); ctx.closePath();
            ctx.fillStyle = getLabelColor(lbl); ctx.fill();
            
            // Gradient Overlay
            if(!glow) {
                let pGrad = ctx.createRadialGradient(0,0, R_NUMBERS, 0,0, R_POCKETS);
                pGrad.addColorStop(0, "rgba(0,0,0,0)"); pGrad.addColorStop(1, "rgba(0,0,0,0.5)");
                ctx.fillStyle = pGrad; ctx.fill();
            } else {
                ctx.lineWidth = 5; ctx.strokeStyle = "#FFF"; ctx.stroke();
            }
            // Divider
            if(!glow) {
                ctx.beginPath(); ctx.moveTo(Math.cos(ang)*R_HUB, Math.sin(ang)*R_HUB); ctx.lineTo(Math.cos(ang)*R_POCKETS, Math.sin(ang)*R_POCKETS);
                ctx.strokeStyle = "#e0e0e0"; ctx.lineWidth = 2; ctx.stroke();
            }
            // Text
            ctx.save(); ctx.rotate(ang + slice/2); ctx.translate(R_NUMBERS+10, 0); ctx.rotate(Math.PI/2);
            ctx.fillStyle = "#fff"; ctx.font = "bold 24px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(lbl, 0, 0); ctx.restore();
            ctx.restore();
        }

        function spinWheel(targetNum) {
            let idx = WHEEL.indexOf(targetNum.toString());
            let slice = (Math.PI*2)/WHEEL.length;
            let targetAngle = (Math.PI*1.5) - (idx*slice) - (slice/2);
            let final = targetAngle + (Math.PI*2 * 5);
            let start = null;
            
            // Zoom Win Anim after spin
            function winAnim(ts) {
                if(!start) start=ts; let el = ts-start;
                drawWheel(final); // Keep static
                ctx.save(); ctx.translate(CX, CY); ctx.rotate(final);
                const scale = 1.12 + Math.sin(el * 0.005) * 0.03; // Throb
                drawWedge(idx, WHEEL[idx], scale, true);
                // Redraw Hub over wedge
                ctx.beginPath(); ctx.arc(0,0, R_HUB, 0, Math.PI*2);
                let hGrad = ctx.createRadialGradient(0,0, 20, 0,0, R_HUB); hGrad.addColorStop(0, "#666"); hGrad.addColorStop(1, "#222");
                ctx.fillStyle = hGrad; ctx.fill();
                ctx.beginPath(); ctx.arc(0,0, R_HUB-5, 0, Math.PI*2); ctx.strokeStyle = "#c9a44c"; ctx.lineWidth = 4; ctx.stroke();
                ctx.beginPath(); ctx.arc(0,0, 30, 0, Math.PI*2); ctx.fillStyle = "#444"; ctx.fill();
                ctx.restore();
                if(document.getElementById('wheel-overlay').classList.contains('show')) requestAnimationFrame(winAnim);
            }

            function anim(ts) {
                if(!start) start=ts; let p=(ts-start)/5000;
                if(p>1) p=1; let ease = 1 - Math.pow(1-p, 3);
                drawWheel(final*ease);
                if(p<1) requestAnimationFrame(anim);
                else { start=null; requestAnimationFrame(winAnim); }
            }
            requestAnimationFrame(anim);
        }

    </script>
</body>
</html>
