<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette - Live Voice</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-green: #1a472a; 
            --grid-yellow: #ffd700; 
            --cell-red: #d32f2f;
            --cell-black: #222; 
            --accent: #00E5FF;
            --gap-size: 6px; /* INCREASED GAP */
        }
        body {
            background-color: #0e2b18; color: white; font-family: 'Inter', sans-serif;
            margin: 0; overflow: hidden; display: flex; height: 100vh;
        }
        * { box-sizing: border-box; }

        /* LOGIN */
        #loginOverlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box { width: 300px; padding: 30px; background: #1a1d24; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .inp { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #444; color: white; border-radius: 6px; }
        .btn-log { width: 100%; padding: 12px; background: var(--grid-yellow); border: none; font-weight: bold; cursor: pointer; border-radius: 6px; color: black; }

        /* LAYOUT */
        .main-stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .sidebar-right {
            width: 280px; background: rgba(0,0,0,0.4); border-left: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; padding: 20px;
        }

        /* HUD & GAME */
        .hud-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .hud-box {
            background: linear-gradient(180deg, #222, #111); border: 1px solid #444; 
            border-radius: 6px; padding: 10px 30px; text-align: center; min-width: 140px;
        }
        .hud-label { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; }
        .hud-value { font-size: 18px; font-weight: 500; color: #fff; }

        /* TABLE GRID FIXES */
        .table-wrapper { 
            position: relative; padding: 40px; border-radius: 20px; 
            background: var(--bg-green); 
            box-shadow: 0 0 0 10px #143620; 
        }
        .grid-frame { 
            display: grid; 
            /* Columns: 0, 1-12, 2to1 */
            grid-template-columns: 50px repeat(12, 45px) 30px; 
            /* Rows: 3 numbers, Dozens, Even/Odd */
            grid-template-rows: repeat(3, 45px) 45px 45px; 
            gap: var(--gap-size); 
            background-color: var(--bg-green); /* Background visible in gaps */
        }
        .cell { 
            display: flex; justify-content: center; align-items: center; 
            font-weight: bold; font-size: 16px; 
            border: 2px solid var(--grid-yellow); /* Explicit border */
            cursor: pointer; transition: 0.1s; 
            border-radius: 4px; /* Slight rounding to emphasize separation */
        }
        .cell:hover { filter: brightness(1.2); transform: scale(0.95); }
        .red-cell { background: var(--cell-red); } 
        .black-cell { background: var(--cell-black); } 
        .green-cell { background: var(--bg-green); }
        
        .chip { 
            width: 30px; height: 30px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: #000; font-weight: bold; font-size: 10px; 
            box-shadow: 0 3px 5px rgba(0,0,0,0.5); pointer-events: none;
            border: 2px dashed rgba(255,255,255,0.3); 
        }
        .chip-50 { background: #fff; } .chip-100 { background: #d32f2f; color: white; } .chip-1k { background: var(--grid-yellow); }
        
        /* VOICE & PLAYERS */
        .player-card {
            background: rgba(255,255,255,0.05); border-radius: 6px; padding: 12px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        /* Active Speaker Styles */
        .player-card.speaking { 
            background: rgba(0, 229, 255, 0.15); 
            border-left: 3px solid var(--accent);
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
        }
        .status-dot { width: 8px; height: 8px; background: #666; border-radius: 50%; }
        .status-dot.online { background: #00C853; box-shadow: 0 0 5px #00C853; }
        .p-name { font-size: 13px; font-weight: 600; flex: 1; }
        
        .mic-indicator { 
            width: 24px; height: 24px; border-radius: 50%; background: #333; 
            display: flex; align-items: center; justify-content: center; color: #555; font-size: 12px;
        }
        .speaking .mic-indicator { 
            background: var(--accent); color: black; 
            animation: pulse 0.5s infinite alternate; 
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* VOICE CONTROLS */
        .voice-controls { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .vc-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #aaa; }
        .btn-mic { width: 100%; padding: 10px; border-radius: 6px; border: none; background: #333; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-mic.active { background: var(--accent); color: black; }
        .push-btn { width: 100%; padding: 15px; background: var(--cell-red); color: white; font-weight: bold; border: none; border-radius: 6px; margin-top: 10px; cursor: pointer; user-select: none; }
        .push-btn:active { background: #ff5555; transform: translateY(2px); }

        .game-controls { margin-top: 20px; display: flex; gap: 10px; }
        .btn-action { padding: 10px 20px; background: #222; color: white; border: 1px solid #444; border-radius: 4px; cursor: pointer; }
        .btn-spin { background: var(--grid-yellow); color: black; font-weight: 800; border: none; }
        
        .chip-rack { display: flex; gap: 10px; margin-bottom: 20px; }
        .chip-opt { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; font-size: 10px; font-weight: bold; color: black; }
        .chip-opt.active { border-color: white; transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h1 style="color:var(--grid-yellow)">CASINO ACCESS</h1>
        <div class="login-box">
            <input id="uName" class="inp" placeholder="Username">
            <input id="pWord" type="password" class="inp" placeholder="Password">
            <button class="btn-log" onclick="doLogin()">ENTER GAME</button>
            <p id="logErr" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="main-stage">
        <div class="hud-container">
            <div class="hud-box">
                <div class="hud-label">Balance</div>
                <div class="hud-value" id="uiBal">---</div>
            </div>
            <div class="hud-box">
                <div class="hud-label">Current Bet</div>
                <div class="hud-value" id="uiBet">0</div>
            </div>
        </div>

        <div class="chip-rack">
            <div class="chip-opt chip-50 active" style="background:white" onclick="selChip(50, this)">50</div>
            <div class="chip-opt chip-100" style="background:#d32f2f; color:white" onclick="selChip(100, this)">100</div>
            <div class="chip-opt chip-1k" style="background:var(--grid-yellow)" onclick="selChip(1000, this)">1K</div>
        </div>

        <div class="table-wrapper">
            <div class="grid-frame" id="grid"></div>
        </div>

        <div class="game-controls">
            <button class="btn-action" onclick="clearBets()">Clear</button>
            <button class="btn-action btn-spin" onclick="reqSpin()">SPIN</button>
        </div>
        <div id="resDisplay" style="height: 30px; margin-top: 10px; color: var(--grid-yellow); font-weight: bold;"></div>
    </div>

    <div class="sidebar-right">
        <h4 style="color:var(--grid-yellow); margin-top:0;">PLAYERS ONLINE</h4>
        <div id="playerList" style="flex:1; overflow-y:auto;"></div>

        <div class="voice-controls">
            <div class="vc-row">
                <span>Microphone</span>
                <span id="micStatusText">OFF</span>
            </div>
            <div class="vc-row">
                <span>Mode</span>
                <select id="voiceMode" style="background:#222; color:white; border:none;" onchange="updateMicMode()">
                    <option value="AUTO">Automatic (VAD)</option>
                    <option value="PTT">Push to Talk</option>
                </select>
            </div>
            
            <button class="btn-mic" id="btnMute" onclick="toggleMute()">
                <i class="fas fa-microphone-slash"></i> <span>UNMUTE MIC</span>
            </button>

            <button id="btnPTT" class="push-btn" style="display:none;" onmousedown="pttDown()" onmouseup="pttUp()" onmouseleave="pttUp()">HOLD TO TALK</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUser = null;
        let myBal = 0;
        let selectedChip = 50;
        let currentBets = [];
        
        // --- LOGIN ---
        function doLogin() {
            const u = document.getElementById('uName').value;
            const p = document.getElementById('pWord').value;
            if(!u || !p) return;
            socket.emit('login', { username: u, password: p });
        }
        
        socket.on('login_error', (msg) => document.getElementById('logErr').innerText = msg);
        socket.on('login_success', (data) => {
            myUser = data;
            myBal = data.balance;
            document.getElementById('loginOverlay').style.display = 'none';
            updateHUD();
            Voice.init(data.mySocketId); // Start Audio
        });

        // --- GAME UI BUILDER ---
        const grid = document.getElementById('grid');
        const redNums = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];

        // 0 Cell
        grid.appendChild(mkCell(0, "grid-row: 1/4; grid-column: 1;", [0], 'green-cell'));

        // Numbers 1-36
        for(let i=1; i<=36; i++) {
            let r = (i%3===0) ? 1 : (i%3===2)?2:3;
            let c = Math.ceil(i/3) + 1;
            let color = redNums.includes(i) ? 'red-cell' : 'black-cell';
            grid.appendChild(mkCell(i, `grid-row:${r}; grid-column:${c}`, [i], color));
        }

        // Side Bets (2to1)
        grid.appendChild(mkCell("2:1", "grid-row:1; grid-column:14", [3,6,9,12,15,18,21,24,27,30,33,36], 'green-cell'));
        grid.appendChild(mkCell("2:1", "grid-row:2; grid-column:14", [2,5,8,11,14,17,20,23,26,29,32,35], 'green-cell'));
        grid.appendChild(mkCell("2:1", "grid-row:3; grid-column:14", [1,4,7,10,13,16,19,22,25,28,31,34], 'green-cell'));

        // Bottom Bets (Dozens)
        grid.appendChild(mkCell("1st 12", "grid-row:4; grid-column:2/6", [1,2,3,4,5,6,7,8,9,10,11,12], 'green-cell'));
        grid.appendChild(mkCell("2nd 12", "grid-row:4; grid-column:6/10", [13,14,15,16,17,18,19,20,21,22,23,24], 'green-cell'));
        grid.appendChild(mkCell("3rd 12", "grid-row:4; grid-column:10/14", [25,26,27,28,29,30,31,32,33,34,35,36], 'green-cell'));

        // Bottom Bets (Even/Odd/Colors) - Simplified for layout
        grid.appendChild(mkCell("1-18", "grid-row:5; grid-column:2/4", [1,2,3], 'green-cell')); // simplified nums for demo
        grid.appendChild(mkCell("EVEN", "grid-row:5; grid-column:4/6", [2,4,6], 'green-cell'));
        grid.appendChild(mkCell("", "grid-row:5; grid-column:6/8; background:var(--cell-red)", redNums, 'red-cell'));
        grid.appendChild(mkCell("", "grid-row:5; grid-column:8/10; background:var(--cell-black)", [2,4], 'black-cell'));
        grid.appendChild(mkCell("ODD", "grid-row:5; grid-column:10/12", [1,3,5], 'green-cell'));
        grid.appendChild(mkCell("19-36", "grid-row:5; grid-column:12/14", [19,20,21], 'green-cell'));


        function mkCell(txt, style, nums, cls) {
            let d = document.createElement('div');
            d.className = 'cell ' + cls;
            d.style = style;
            d.innerText = txt;
            d.onclick = () => placeBet(nums, d);
            return d;
        }

        function selChip(val, el) {
            selectedChip = val;
            document.querySelectorAll('.chip-opt').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function placeBet(nums, el) {
            if(myBal < selectedChip) return;
            myBal -= selectedChip;
            
            let chip = document.createElement('div');
            chip.className = 'chip chip-1k';
            if(selectedChip===50) chip.className='chip chip-50';
            if(selectedChip===100) chip.className='chip chip-100';
            
            chip.style.position = 'absolute';
            chip.innerText = selectedChip;
            
            // Random offset for stacking
            let rx = (Math.random() * 10) - 5; 
            let ry = (Math.random() * 10) - 5;
            chip.style.transform = `translate(${rx}px, ${ry}px)`;

            el.appendChild(chip);
            currentBets.push({ numbers: nums, amount: selectedChip });
            updateHUD();
        }

        function clearBets() {
            currentBets.forEach(b => myBal += b.amount);
            currentBets = [];
            document.querySelectorAll('.cell .chip').forEach(c => c.remove());
            updateHUD();
        }

        function reqSpin() {
            if(currentBets.length === 0) return;
            document.getElementById('resDisplay').innerText = "SPINNING...";
            socket.emit('roulette_spin', currentBets);
            currentBets = [];
            document.querySelectorAll('.cell .chip').forEach(c => c.remove());
        }

        socket.on('roulette_result', (data) => {
            myBal = data.balance;
            let msg = `HIT: ${data.result}`;
            if(data.win > 0) msg += ` | WON ${data.win}!`;
            document.getElementById('resDisplay').innerText = msg;
            updateHUD();
        });

        function updateHUD() {
            document.getElementById('uiBal').innerText = myBal;
            let total = 0; currentBets.forEach(b => total+=b.amount);
            document.getElementById('uiBet').innerText = total;
        }

        // --- PLAYER LIST & VOICE SORTING ---
        socket.on('player_list_update', (list) => {
            renderPlayerList(list);
        });

        function renderPlayerList(list) {
            const pDiv = document.getElementById('playerList');
            pDiv.innerHTML = '';
            
            // SORTING LOGIC: Speakers First
            list.sort((a, b) => {
                if(a.isSpeaking && !b.isSpeaking) return -1;
                if(!a.isSpeaking && b.isSpeaking) return 1;
                return 0;
            });

            list.forEach(u => {
                const isMe = myUser && u.username === myUser.username;
                // Add 'speaking' class if true
                const activeClass = u.isSpeaking ? 'speaking' : '';
                
                pDiv.innerHTML += `
                    <div class="player-card ${activeClass}" id="pcard-${u.username}">
                        <div class="status-dot online"></div>
                        <div class="p-name">${u.username} ${isMe ? '(You)':''}</div>
                        <div class="mic-indicator">
                            <i class="fas fa-microphone${u.isSpeaking ? '' : '-slash'}"></i>
                        </div>
                    </div>
                `;
            });
        }

        // --- VOICE ENGINE ---
        const Voice = {
            myId: null,
            localStream: null,
            peers: {},
            audioCtx: null,
            analyser: null,
            isMuted: true,
            mode: 'AUTO',
            
            init: async function(id) {
                this.myId = id;
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.setupVAD();
                    this.toggleMute(true); // Start muted
                } catch(e) { console.error("Mic denied"); }

                socket.on('voice_signal', async ({ callerID, signal }) => {
                    const peer = this.getPeer(callerID);
                    if(signal.sdp) {
                        await peer.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                        if(signal.sdp.type === 'offer') {
                            const answer = await peer.createAnswer();
                            await peer.setLocalDescription(answer);
                            socket.emit('voice_signal', { target: callerID, signal: { sdp: peer.localDescription } });
                        }
                    } else if (signal.candidate) {
                        await peer.addIceCandidate(new RTCIceCandidate(signal.candidate));
                    }
                });

                socket.on('existing_users', (users) => {
                    users.forEach(userId => this.createPeer(userId, true));
                });

                socket.on('user_left', (id) => {
                    if(this.peers[id]) { this.peers[id].close(); delete this.peers[id]; }
                });
            },

            setupVAD: function() {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const src = this.audioCtx.createMediaStreamSource(this.localStream);
                this.analyser = this.audioCtx.createAnalyser();
                this.analyser.fftSize = 256;
                src.connect(this.analyser);
                this.checkVolume();
            },

            checkVolume: function() {
                if(!this.analyser || this.isMuted) return requestAnimationFrame(() => this.checkVolume());
                
                const data = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(data);
                let sum = 0; for(let i=0; i<data.length; i++) sum+=data[i];
                let avg = sum / data.length;

                // VAD Threshold = 10
                const isTalking = (avg > 10);
                
                if(this.lastTalkState !== isTalking) {
                    socket.emit('speaking_status', isTalking);
                    this.lastTalkState = isTalking;
                }
                
                requestAnimationFrame(() => this.checkVolume());
            },

            createPeer: function(targetId, initiator) {
                const p = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.peers[targetId] = p;

                p.onicecandidate = (e) => {
                    if(e.candidate) socket.emit('voice_signal', { target: targetId, signal: { candidate: e.candidate } });
                };
                p.ontrack = (e) => {
                    const audio = new Audio();
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                };
                this.localStream.getTracks().forEach(t => p.addTrack(t, this.localStream));

                if(initiator) {
                    p.createOffer().then(o => p.setLocalDescription(o))
                     .then(() => socket.emit('voice_signal', { target: targetId, signal: { sdp: p.localDescription } }));
                }
                return p;
            },

            getPeer: function(id) {
                if(!this.peers[id]) return this.createPeer(id, false);
                return this.peers[id];
            },

            toggleMute: function(forceMute) {
                if(!this.localStream) return;
                const track = this.localStream.getAudioTracks()[0];
                if(forceMute !== undefined) this.isMuted = forceMute;
                else this.isMuted = !this.isMuted;
                
                track.enabled = !this.isMuted;
                
                // If muted, force 'not speaking' status
                if(this.isMuted && this.lastTalkState) {
                     socket.emit('speaking_status', false);
                     this.lastTalkState = false;
                }

                const btn = document.getElementById('btnMute');
                const txt = document.getElementById('micStatusText');
                if(this.isMuted) {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>UNMUTE MIC</span>';
                    txt.innerText = "MUTED"; txt.style.color = "#666";
                } else {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-microphone"></i> <span>MUTE MIC</span>';
                    txt.innerText = "ON AIR"; txt.style.color = "#00E5FF";
                }
            }
        };

        function updateMicMode() {
            Voice.mode = document.getElementById('voiceMode').value;
            const pttBtn = document.getElementById('btnPTT');
            const muteBtn = document.getElementById('btnMute');
            
            if(Voice.mode === 'PTT') {
                pttBtn.style.display = 'block';
                muteBtn.style.display = 'none';
                Voice.toggleMute(true);
            } else {
                pttBtn.style.display = 'none';
                muteBtn.style.display = 'flex';
                Voice.toggleMute(true);
            }
        }
        function toggleMute() { Voice.toggleMute(); }
        function pttDown() { if(Voice.mode === 'PTT') Voice.toggleMute(false); }
        function pttUp() { if(Voice.mode === 'PTT') Voice.toggleMute(true); }

    </script>
</body>
</html>
