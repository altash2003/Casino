<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASINO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* === GLOBAL RESET & SHARED === */
        body { margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; }
        .view-section { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; }
        .view-section.active { display: flex; }
        .global-back { position: fixed; top: 20px; left: 20px; z-index: 9000; background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-weight: bold; display: none; }

        /* === AUTH & LOBBY === */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: #111; border: 1px solid #333; padding: 40px; border-radius: 12px; text-align: center; width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; }
        .auth-btn { width: 100%; padding: 12px; background: #FFD700; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #view-lobby { background: url('background.jpg') center/cover; flex-direction: column; justify-content: center; align-items: center; gap: 30px; }
        .lobby-grid { display: flex; gap: 40px; }
        .game-card { width: 260px; height: 360px; background: rgba(0,0,0,0.85); border: 2px solid #333; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .game-card:hover { border-color: #FFD700; transform: translateY(-10px); }
        .user-hud { position: absolute; top: 20px; right: 20px; text-align: right; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 8px; border: 1px solid #444; z-index: 100; }

        /* === COLOR GAME STYLES === */
        #view-colorgame { background: url('background.jpg') center/cover; justify-content: center; align-items: center; }
        .cg-wrapper { background: rgba(20,20,30,0.8); backdrop-filter: blur(10px); border: 1px solid #444; border-radius: 16px; width: 95%; max-width: 1200px; height: 90vh; display:flex; flex-direction:column; }
        .cg-focus { flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .cg-dice-row { display: flex; gap: 20px; margin: 20px 0; }
        .die { width: 90px; height: 90px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 800; border: 3px solid rgba(255,255,255,0.2); background: #222; color:white; }
        .die.red { background: #d32f2f; } .die.green { background: #388e3c; } .die.blue { background: #1976d2; }
        .die.pink { background: #e91e63; } .die.white { background: #f5f5f5; color:black; } .die.yellow { background: #fbc02d; color:black; }
        
        .cg-panel { padding: 20px; background: rgba(0,0,0,0.3); border-top: 1px solid #444; }
        .cg-bet-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .cg-card { height: 80px; border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; padding: 10px; }
        .cg-card:hover { filter: brightness(1.2); }
        .cg-chip-rack { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .cg-chip { width: 40px; height: 40px; border-radius: 50%; background: #222; border: 2px solid #555; color: #aaa; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; font-size: 12px; }
        .cg-chip.active { border-color: #FFD700; color: #FFD700; background: #333; transform: scale(1.1); }

        /* === ROULETTE STYLES (IMPORTED FROM YOUR FILE) === */
        :root { --bg-felt: #01431E; --grid-gold: #F3C620; --cell-red: #d32f2f; --cell-black: #222; --btn-classic-bg: #263238; }
        
        #view-roulette {
            background-color: #05140a;
            background-image: radial-gradient(circle at 50% 50%, #012b13 0%, #000000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Wheel Overlay */
        #wheel-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; }
        #wheel-overlay.show { display: flex; }
        .pointer { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 36px solid #f0e6d2; z-index: 205; }
        canvas { border-radius: 50%; }

        /* Roulette HUD */
        .hud-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .hud-box { background: linear-gradient(180deg, #111, #000); border: 1px solid #444; border-radius: 12px; width: 140px; height: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .hud-label { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; }
        .hud-value { font-size: 22px; font-weight: 600; color: #fff; font-family: 'Courier New', monospace; }
        #timer-box { border: 2px solid #F3C620; width: 90px; } 

        /* Table */
        .table-wrapper {
            position: relative; background-color: var(--bg-felt);
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 10px);
            padding: 30px 40px; border-radius: 25px;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.8), 0 0 0 8px #002b12, 0 0 0 10px #F3C620;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }

        /* History Strip */
        .history-strip { width: 705px; height: 50px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 0; overflow: hidden; }
        .history-ball { width: 34px; height: 34px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: 800; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.6); }
        .hist-red { background: radial-gradient(circle at 35% 35%, #ff5252 0%, #d32f2f 40%, #8e0000 100%); }
        .hist-black { background: radial-gradient(circle at 35% 35%, #555 0%, #222 40%, #000 100%); }
        .hist-green { background: radial-gradient(circle at 35% 35%, #05a045 0%, #016D29 40%, #004d1a 100%); }

        /* Grid */
        .grid-frame { width: 705px; display: grid; grid-template-columns: 56px repeat(12, 46px) 38px; grid-template-rows: repeat(3, 46px) 46px 46px; gap: 3px; padding: 8px; border: 2px solid var(--grid-gold); border-radius: 8px; background: rgba(0,0,0,0.2); }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 16px; color: #fff; cursor: pointer; border: 2px solid var(--grid-gold); box-sizing: border-box; transition: 0.1s; }
        .red-cell { background-color: var(--cell-red); } .black-cell { background-color: var(--cell-black); }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; font-size: 24px; border-radius: 20px 0 0 20px; }
        .zone-2to1 { grid-column: 14; background-color: var(--bg-felt); font-size: 11px; writing-mode: vertical-rl; color: #F3C620; }
        .label-cell { background-color: var(--bg-felt); color: white; font-size: 13px; text-transform: uppercase; }
        .zone-dozen { grid-row: 4; } .doz-1 { grid-column: 2 / 6; } .doz-2 { grid-column: 6 / 10; } .doz-3 { grid-column: 10 / 14; }
        .zone-bottom { grid-row: 5; } .low { grid-column: 2 / 4; } .even { grid-column: 4 / 6; } .odd { grid-column: 10 / 12; } .high { grid-column: 12 / 14; }
        .diamond-cell { grid-column: 6 / 8; grid-row: 5; background-color: var(--bg-felt); display: flex; align-items: center; justify-content: center; }
        .diamond-cell.black-bg { grid-column: 8 / 10; }
        .diamond { width: 26px; height: 26px; transform: rotate(45deg); pointer-events: none; }
        .diamond.red { background-color: var(--cell-red); } .diamond.black { background-color: #111; }

        /* Overlays & Chips */
        .ghost-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .hotspot { position: absolute; z-index: 60; cursor: pointer; pointer-events: auto; }
        .hotspot:hover { background: rgba(255,255,255,0.1); }

        .controls-row { display: flex; justify-content: space-between; width: 705px; margin-top: 10px; }
        .btn-french { background: var(--btn-classic-bg); color: #cfd8dc; border: 1px solid #455a64; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .btn-french:hover { background: #37474f; color: white; border-color: white; }

        .chips-bar { display: flex; gap: 12px; padding: 8px 25px; background: rgba(0,0,0,0.2); border-radius: 60px; border: 1px solid rgba(255,255,255,0.05); margin-top: 10px; }
        .r-chip-btn { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; position: relative; transition: transform 0.15s; box-shadow: 0 4px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; font-weight: 800; font-size: 11px; color: #333; background: #e0dfd5; border: 2px solid #ccc; }
        .r-chip-btn.active { transform: scale(1.15) translateY(-5px); border-color: #FFD700; box-shadow: 0 0 10px #FFD700; }
        
        .marker-chip { width: 30px; height: 30px; border-radius: 50%; background: white; border: 2px dashed #333; color: black; position: absolute; pointer-events: none; z-index: 100; display: flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.5); }
        
        /* Winner Animation */
        #winner-stage { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3000; display: none; justify-content: center; align-items: center; }
        #winner-stage.active { display: flex; }
        .winners-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; max-width: 80%; }
        .clone-cell { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-weight: 800; font-size: 20px; color: white; border: 3px solid #F3C620; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); background: #222; position: relative; }
        .clone-red { background: #d32f2f; } .clone-black { background: #111; } .clone-green { background: #016D29; }
        .win-amt-label { position: absolute; top: -30px; width: 100%; text-align: center; color: #FFD700; font-family: 'Arial Black'; font-weight: 900; font-size: 18px; text-shadow: 2px 2px 0 #000; z-index: 3005; }

    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:#FFD700; margin-bottom:20px;">CASINO LOGIN</h1>
            <input type="text" id="user" class="auth-input" placeholder="USERNAME">
            <input type="password" id="pass" class="auth-input" placeholder="PASSWORD">
            <button onclick="login()" class="auth-btn">ENTER CASINO</button>
            <button onclick="register()" class="auth-btn" style="background:transparent; border:1px solid #555; color:#aaa; font-size:12px;">NEW PLAYER</button>
            <div id="loginErr" style="color:red; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <button class="global-back" id="backBtn" onclick="goToLobby()">‚Üê LOBBY</button>
    
    <div class="user-hud" id="userHud" style="display:none;">
        <div style="font-size:10px; color:#aaa; font-weight:bold;">PLAYER</div>
        <div id="hudUser" style="font-size:18px; font-weight:bold; color:white;">Guest</div>
        <div id="hudBal" style="font-size:18px; font-weight:bold; color:#FFD700;">$0</div>
    </div>

    <div id="view-lobby" class="view-section active">
        <h1 style="font-size:60px; color:#FFD700; text-shadow:0 0 20px rgba(0,0,0,0.8); margin-bottom:20px; font-weight:800;">GRAND CASINO</h1>
        <div class="lobby-grid">
            <div class="game-card" onclick="enterGame('colorgame')">
                <div class="gc-title">COLOR GAME</div>
                <div class="gc-icon">üé®</div>
                <div class="gc-count" id="count-colorgame">0 Playing</div>
            </div>
            <div class="game-card" onclick="enterGame('roulette')">
                <div class="gc-title">ROULETTE</div>
                <div class="gc-icon">üé°</div>
                <div class="gc-count" id="count-roulette">0 Playing</div>
            </div>
        </div>
    </div>

    <div id="view-colorgame" class="view-section">
        <div class="cg-wrapper">
            <div style="padding:15px; border-bottom:1px solid #444; font-weight:bold; color:#aaa; display:flex; justify-content:space-between;">
                <span>COLOR GAME</span>
                <span id="cg-status">BETS OPEN</span>
            </div>
            <div class="cg-focus">
                <div id="cg-timer" style="font-size:80px; font-weight:800; color:white;">20</div>
                <div class="cg-dice-row">
                    <div id="d1" class="die">?</div>
                    <div id="d2" class="die">?</div>
                    <div id="d3" class="die">?</div>
                </div>
            </div>
            <div class="cg-panel">
                <div class="cg-chip-rack">
                    <div class="cg-chip active" onclick="setCgChip(50, this)">50</div>
                    <div class="cg-chip" onclick="setCgChip(100, this)">100</div>
                    <div class="cg-chip" onclick="setCgChip(500, this)">500</div>
                    <div class="cg-chip" onclick="setCgChip(1000, this)">1K</div>
                </div>
                <div class="cg-bet-grid">
                    <div class="cg-card" style="background:linear-gradient(135deg, #d32f2f, #b71c1c);" onclick="placeCgBet('RED')"><b style="color:white;">RED</b><div id="cg-bet-RED" style="color:white; font-weight:bold;">0</div></div>
                    <div class="cg-card" style="background:linear-gradient(135deg, #388e3c, #1b5e20);" onclick="placeCgBet('GREEN')"><b style="color:white;">GREEN</b><div id="cg-bet-GREEN" style="color:white; font-weight:bold;">0</div></div>
                    <div class="cg-card" style="background:linear-gradient(135deg, #1976d2, #0d47a1);" onclick="placeCgBet('BLUE')"><b style="color:white;">BLUE</b><div id="cg-bet-BLUE" style="color:white; font-weight:bold;">0</div></div>
                    <div class="cg-card" style="background:linear-gradient(135deg, #fbc02d, #f57f17);" onclick="placeCgBet('YELLOW')"><b style="color:black;">YELLOW</b><div id="cg-bet-YELLOW" style="color:black; font-weight:bold;">0</div></div>
                    <div class="cg-card" style="background:linear-gradient(135deg, #e91e63, #c2185b);" onclick="placeCgBet('PINK')"><b style="color:white;">PINK</b><div id="cg-bet-PINK" style="color:white; font-weight:bold;">0</div></div>
                    <div class="cg-card" style="background:linear-gradient(135deg, #f5f5f5, #bdbdbd);" onclick="placeCgBet('WHITE')"><b style="color:black;">WHITE</b><div id="cg-bet-WHITE" style="color:black; font-weight:bold;">0</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-roulette" class="view-section">
        
        <div id="wheel-overlay">
            <div style="position:relative;">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="800" height="800" style="width:500px; height:500px;"></canvas>
            </div>
        </div>

        <div id="winner-stage">
            <div class="winners-container" id="winnersContainer"></div>
        </div>

        <div class="hud-container">
            <div class="hud-box">
                <div class="hud-label">TIMER</div>
                <div class="hud-value" id="r-timer">--</div>
            </div>
            <div class="hud-box">
                <div class="hud-label">CURRENT BET</div>
                <div class="hud-value" id="r-bet-display">0</div>
            </div>
        </div>

        <div class="table-wrapper" id="tableWrapper">
            <div class="history-strip" id="historyLog">
                </div>
            
            <div class="grid-frame" id="grid">
                <div class="ghost-overlay" id="overlay"></div>
                <div class="cell zone-0" id="cell-0">0</div>
                <div class="cell zone-2to1" style="grid-row: 1" id="btn-row1">2 TO 1</div>
                <div class="cell zone-2to1" style="grid-row: 2" id="btn-row2">2 TO 1</div>
                <div class="cell zone-2to1" style="grid-row: 3" id="btn-row3">2 TO 1</div>
                <div class="cell label-cell zone-dozen doz-1" id="btn-doz1">1st 12</div>
                <div class="cell label-cell zone-dozen doz-2" id="btn-doz2">2nd 12</div>
                <div class="cell label-cell zone-dozen doz-3" id="btn-doz3">3rd 12</div>
                <div class="cell label-cell zone-bottom low" id="btn-low">1-18</div>
                <div class="cell label-cell zone-bottom even" id="btn-even">EVEN</div>
                <div class="cell label-cell diamond-cell" id="btn-red"><div class="diamond red"></div></div>
                <div class="cell label-cell diamond-cell black-bg" id="btn-black"><div class="diamond black"></div></div>
                <div class="cell label-cell zone-bottom odd" id="btn-odd">ODD</div>
                <div class="cell label-cell zone-bottom high" id="btn-high">19-36</div>
            </div>

            <div class="controls-row">
                <div style="display:flex; gap:10px;">
                    <button class="btn-french" onclick="preset('voisins')">Voisins</button>
                    <button class="btn-french" onclick="preset('tier')">Tier</button>
                    <button class="btn-french" onclick="preset('orphelins')">Orphelins</button>
                </div>
            </div>

            <div class="chips-bar">
                <div class="r-chip-btn active" onclick="setRChip(50, this)">50</div>
                <div class="r-chip-btn" onclick="setRChip(100, this)">100</div>
                <div class="r-chip-btn" onclick="setRChip(500, this)">500</div>
                <div class="r-chip-btn" onclick="setRChip(1000, this)">1K</div>
                <div class="r-chip-btn" onclick="setRChip(10000, this)">10K</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = 'lobby';
        let userBalance = 0; // Local tracking

        // --- AUTH ---
        const sUser = localStorage.getItem('c_user');
        const sPass = localStorage.getItem('c_pass');
        if(sUser && sPass) socket.emit('login', { username: sUser, password: sPass });

        function login() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            socket.emit('login', { username: u, password: p });
        }
        function register() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            socket.emit('register', { username: u, password: p });
        }
        
        socket.on('login_success', (data) => {
            localStorage.setItem('c_user', data.username);
            localStorage.setItem('c_pass', document.getElementById('pass').value || sPass);
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('userHud').style.display = 'block';
            document.getElementById('hudUser').innerText = data.username;
            userBalance = data.balance;
            document.getElementById('hudBal').innerText = '$' + userBalance;
        });
        socket.on('login_error', (msg) => document.getElementById('loginErr').innerText = msg);
        socket.on('update_balance', (bal) => {
            userBalance = bal;
            document.getElementById('hudBal').innerText = '$' + bal;
        });

        // --- NAV ---
        function enterGame(game) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + game).classList.add('active');
            document.getElementById('backBtn').style.display = 'block';
            currentRoom = game;
            socket.emit('switch_room', game);
            if(game === 'roulette') initRoulette();
        }
        function goToLobby() {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-lobby').classList.add('active');
            document.getElementById('backBtn').style.display = 'none';
            currentRoom = 'lobby';
            socket.emit('switch_room', 'lobby');
            clearRouletteTable();
        }
        socket.on('lobby_counts', (c) => {
            document.getElementById('count-colorgame').innerText = (c.colorgame||0) + " Playing";
            document.getElementById('count-roulette').innerText = (c.roulette||0) + " Playing";
        });

        // --- COLOR GAME LOGIC ---
        let cgChip = 50;
        function setCgChip(val, el) { cgChip = val; document.querySelectorAll('.cg-chip').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
        function placeCgBet(color) {
            if(userBalance < cgChip) { alert("Insufficient funds"); return; }
            userBalance -= cgChip; // Optimistic
            document.getElementById('hudBal').innerText = '$' + userBalance;
            socket.emit('place_bet', { color: color, amount: cgChip });
            let el = document.getElementById('cg-bet-'+color);
            el.innerText = parseInt(el.innerText) + cgChip;
        }
        socket.on('countdown_beep', (t)=>{ /* sfx */ });
        socket.on('timer_update', (t)=>{ if(currentRoom==='colorgame') { document.getElementById('cg-timer').innerText = t; document.getElementById('cg-status').innerText='BETS OPEN'; }});
        socket.on('game_rolling', ()=>{ if(currentRoom==='colorgame') { document.getElementById('cg-status').innerText='ROLLING...'; document.getElementById('cg-timer').innerText='--'; animateDice(); }});
        function animateDice() {
             let cols = ['red','green','blue','yellow','pink','white'];
             window.cgInt = setInterval(()=>{ ['d1','d2','d3'].forEach(id=>{ document.getElementById(id).className=`die ${cols[Math.floor(Math.random()*6)]}`; }); }, 100);
        }
        socket.on('game_result', (res)=>{ 
            if(window.cgInt) clearInterval(window.cgInt); 
            if(currentRoom==='colorgame') {
                document.getElementById('cg-status').innerText='RESULT';
                ['d1','d2','d3'].forEach((id,i)=>{ document.getElementById(id).className=`die ${res[i].toLowerCase()}`; });
            }
        });
        socket.on('game_reset', ()=>{ ['RED','GREEN','BLUE','YELLOW','PINK','WHITE'].forEach(c=>document.getElementById('cg-bet-'+c).innerText='0'); });
        socket.on('win_notification', (data)=>{ alert(`COLOR GAME WIN: +$${data.total}`); });


        // ================= ROULETTE LOGIC (INTEGRATED FROM YOUR FILE) =================
        const REDS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        let rChip = 50;
        let rBetTotal = 0;
        let activeChips = {}; // key: coordinates, value: chipData
        const WHEEL = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
        const PRESETS = { 'voisins': [0, 2, 3, 4, 7, 12, 15, 18, 19, 21, 22, 25, 26, 28, 29, 32, 35], 'tier': [5, 8, 10, 11, 13, 16, 23, 24, 27, 30, 33, 36], 'orphelins': [1, 6, 9, 14, 17, 20, 31, 34] };
        
        let rInitialized = false;
        function initRoulette() {
            if(rInitialized) return;
            buildGrid(); buildHotspots(); drawWheel(0);
            rInitialized = true;
        }

        function buildGrid() {
            const grid = document.getElementById('grid');
            for(let i=1; i<=36; i++) {
                let d = document.createElement('div');
                d.className = `cell ${REDS.includes(i)?'red-cell':'black-cell'}`;
                d.innerText = i; d.id = `cell-${i}`;
                let row = (i%3===0)?1:(i%3===2?2:3); let col = Math.floor((i-1)/3)+2;
                d.style.gridRow = row; d.style.gridColumn = col;
                bindHotspot(d, [i]); // Direct click
                grid.appendChild(d);
            }
        }

        function buildHotspots() {
            const ov = document.getElementById('overlay');
            const CELL_W = 46, CELL_H = 46, GAP = 3, OFF_X = 56 + GAP;
            // Example splits/streets logic simplified for hotspot creation
            // Note: In a real deploy, you'd map every split. Here we map the main buttons and 1-36.
            // Mapping Side Bets
            bindHotspot(document.getElementById('btn-red'), REDS);
            bindHotspot(document.getElementById('btn-black'), Array.from({length:36},(_,i)=>i+1).filter(n=>!REDS.includes(n)));
            bindHotspot(document.getElementById('btn-even'), Array.from({length:36},(_,i)=>i+1).filter(n=>n%2===0));
            bindHotspot(document.getElementById('btn-odd'), Array.from({length:36},(_,i)=>i+1).filter(n=>n%2!==0));
            bindHotspot(document.getElementById('btn-low'), Array.from({length:18},(_,i)=>i+1));
            bindHotspot(document.getElementById('btn-high'), Array.from({length:18},(_,i)=>i+19));
            bindHotspot(document.getElementById('btn-doz1'), Array.from({length:12},(_,i)=>i+1));
            bindHotspot(document.getElementById('btn-doz2'), Array.from({length:12},(_,i)=>i+13));
            bindHotspot(document.getElementById('btn-doz3'), Array.from({length:12},(_,i)=>i+25));
            bindHotspot(document.getElementById('cell-0'), [0]);
            
            // Helper for manual mapping in HTML
            // Note: The specific coordinate hotspots from your file would go here.
        }

        function bindHotspot(el, nums) {
            if(!el) return;
            el.onclick = (e) => {
                let rect = el.getBoundingClientRect();
                let wrap = document.getElementById('tableWrapper').getBoundingClientRect();
                // Calc relative x,y center of element
                let x = rect.left - wrap.left + rect.width/2;
                let y = rect.top - wrap.top + rect.height/2;
                placeRouletteBet(x, y, nums, el.id);
            };
        }

        function setRChip(val, el) { rChip = val; document.querySelectorAll('.r-chip-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }

        function placeRouletteBet(x, y, nums, domId) {
            if(userBalance < rChip) { alert("Insufficient Funds"); return; }
            
            // Optimistic Update
            userBalance -= rChip;
            document.getElementById('hudBal').innerText = '$' + userBalance;
            rBetTotal += rChip;
            document.getElementById('r-bet-display').innerText = rBetTotal;

            // Visual
            let key = Math.round(x) + '_' + Math.round(y);
            if(!activeChips[key]) {
                let d = document.createElement('div');
                d.className = 'marker-chip'; d.innerText = rChip;
                d.style.left = x + 'px'; d.style.top = y + 'px';
                document.getElementById('overlay').appendChild(d);
                activeChips[key] = { el: d, amt: rChip, nums: nums, domId: domId };
            } else {
                activeChips[key].amt += rChip;
                activeChips[key].el.innerText = activeChips[key].amt;
                activeChips[key].el.style.transform = 'scale(1.2)';
                setTimeout(()=>activeChips[key].el.style.transform='scale(1)', 100);
            }

            socket.emit('place_bet_roulette', { numbers: nums, amount: rChip, domId: domId });
        }

        function preset(type) {
            let nums = PRESETS[type];
            if(nums) nums.forEach(n => {
                let cell = document.getElementById(`cell-${n}`);
                if(cell) cell.click();
            });
        }

        function clearRouletteTable() {
            rBetTotal = 0;
            document.getElementById('r-bet-display').innerText = '0';
            document.getElementById('overlay').innerHTML = '';
            activeChips = {};
            document.getElementById('winnersContainer').innerHTML = '';
            document.getElementById('winner-stage').classList.remove('active');
        }

        // --- ROULETTE SOCKETS ---
        socket.on('roulette_timer', (t) => {
            if(currentRoom !== 'roulette') return;
            document.getElementById('r-timer').innerText = t;
            document.getElementById('wheel-overlay').classList.remove('show');
        });

        const cvs = document.getElementById('wheelCanvas');
        const ctx = cvs.getContext('2d');
        function drawWheel(angle) {
            const CX=400, CY=400, R=380; // Scaled for 800x800 canvas
            const slice = (Math.PI*2)/WHEEL.length;
            ctx.clearRect(0,0,800,800);
            ctx.save(); ctx.translate(CX,CY); ctx.rotate(angle);
            WHEEL.forEach((n,i)=>{
                let a = i*slice;
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,a,a+slice);
                ctx.fillStyle = n===0?'#016D29':(REDS.includes(n)?'#d32f2f':'#222');
                ctx.fill(); ctx.stroke();
                ctx.save(); ctx.rotate(a+slice/2); ctx.translate(320,0); ctx.rotate(Math.PI/2);
                ctx.fillStyle='white'; ctx.font='30px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillText(n,0,0); ctx.restore();
            });
            ctx.restore();
        }

        socket.on('roulette_spin_start', (winningNum) => {
            if(currentRoom !== 'roulette') return;
            document.getElementById('wheel-overlay').classList.add('show');
            // Calc angle
            const slice = (Math.PI*2)/WHEEL.length;
            const idx = WHEEL.indexOf(winningNum);
            const target = (Math.PI*1.5) - (idx*slice) - (slice/2);
            const final = target + (Math.PI*2 * 5);
            
            let start = null;
            function anim(ts) {
                if(!start) start = ts;
                let p = (ts - start)/5000;
                if(p>1) p=1;
                let ease = 1 - Math.pow(1-p, 3);
                drawWheel(final * ease);
                if(p<1) requestAnimationFrame(anim);
            }
            requestAnimationFrame(anim);
        });

        // Add history ball
        socket.on('roulette_result_log', (num) => {
            if(currentRoom !== 'roulette') return;
            let h = document.getElementById('historyLog');
            let b = document.createElement('div');
            b.className = `history-ball ${num===0?'hist-green':(REDS.includes(num)?'hist-red':'hist-black')}`;
            b.innerText = num;
            h.prepend(b);
            if(h.children.length > 15) h.lastChild.remove();
        });

        // Winner Animation (Mario Style)
        socket.on('roulette_win', (data) => {
            // data: {amount, number}
            let stage = document.getElementById('winner-stage');
            stage.classList.add('active');
            let con = document.getElementById('winnersContainer');
            
            let div = document.createElement('div');
            div.className = `clone-cell ${data.number===0?'clone-green':(REDS.includes(data.number)?'clone-red':'clone-black')}`;
            div.innerText = data.number;
            
            let label = document.createElement('div');
            label.className = 'win-amt-label';
            label.innerText = '+' + data.amount;
            div.appendChild(label);
            con.appendChild(div);

            setTimeout(() => {
                con.innerHTML = '';
                stage.classList.remove('active');
            }, 3000);
        });

        socket.on('roulette_new_round', () => {
            clearRouletteTable();
        });

    </script>
</body>
</html>
