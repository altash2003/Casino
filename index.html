<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRAND CASINO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- GLOBAL RESET & CORE --- */
        :root { --gold: #FFD700; --cyan: #00E5FF; --bg-dark: #0a0a0a; --panel-bg: rgba(20,20,20,0.95); }
        body { margin: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color:white; }
        
        /* Disable selection */
        * { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        input { -webkit-user-select: auto; user-select: auto; }

        .view-section { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; flex-direction: column; }
        .view-section.active { display: flex; }
        
        .global-back { position: fixed; top: 20px; left: 20px; z-index: 9000; background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-weight: bold; display: none; transition: 0.2s; }
        .global-back:hover { background: var(--gold); color: black; border-color: var(--gold); }

        /* --- AUTH --- */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: #111; border: 1px solid #333; padding: 40px; border-radius: 12px; text-align: center; width: 300px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.1); }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; box-sizing:border-box; border-radius: 6px; font-family: 'Rajdhani'; font-weight: bold; }
        .auth-btn { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius: 6px; transition: 0.2s; }
        .auth-btn:hover { transform: scale(1.05); }

        /* --- PLAYER LIST PANEL (LEFT) --- */
        .player-list-panel {
            position: fixed; left: 20px; top: 80px; width: 200px; max-height: 50vh;
            background: rgba(0,0,0,0.6); border-left: 3px solid var(--cyan);
            border-radius: 0 8px 8px 0; backdrop-filter: blur(5px);
            z-index: 8000; display: none; flex-direction: column; overflow: hidden;
            transition: transform 0.3s ease;
        }
        .player-list-panel.active { display: flex; animation: slideRight 0.3s; }
        @keyframes slideRight { from { transform: translateX(-50px); opacity:0; } to { transform: translateX(0); opacity:1; } }
        
        .pl-header { background: rgba(0,229,255,0.1); padding: 10px; font-size: 12px; color: var(--cyan); font-weight: bold; letter-spacing: 1px; display: flex; justify-content: space-between; }
        .pl-content { flex: 1; overflow-y: auto; padding: 5px; }
        .pl-user { display: flex; align-items: center; padding: 8px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .pl-mic { width: 24px; display: flex; justify-content: center; }
        .pl-name { flex: 1; margin-left: 5px; }
        
        /* Talking State */
        .pl-user.talking .pl-name { color: var(--gold); text-shadow: 0 0 10px var(--gold); font-weight: bold; }
        .pl-user.talking .pl-mic i { color: #00E5FF; animation: pulseMic 0.5s infinite alternate; }
        @keyframes pulseMic { from { transform: scale(1); } to { transform: scale(1.3); } }

        /* --- CHAT & MUSIC PANELS (RIGHT) --- */
        .panel-position { position: fixed; bottom: 100px; right: 20px; width: 280px; background: var(--panel-bg); border: 1px solid #444; border-radius: 12px; display: none; flex-direction: column; z-index: 8000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .panel-position.active { display: flex; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-panel { height: 350px; }
        .chat-header { padding: 10px; background: #151515; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0; font-size: 12px; font-weight: bold; color: #888; }
        .chat-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; }
        .chat-input-area { padding: 10px; background: #1a1a1a; border-top: 1px solid #333; display: flex; border-radius: 0 0 12px 12px; }
        .chat-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 8px; font-size: 12px; border-radius: 4px; outline: none; }

        /* --- VOICE CONTROLS --- */
        .voice-controls { position: absolute; bottom: 80px; right: 20px; display: flex; gap: 10px; z-index: 5000; }
        .vc-btn { background: rgba(0,0,0,0.7); border: 1px solid #555; color: #888; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .vc-btn.active { border-color: var(--green); color: white; background: rgba(0, 200, 83, 0.3); }
        .vc-btn.talking { background: var(--gold); color: black; border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }

        /* --- LOBBY --- */
        #view-lobby { background: url('background.jpg') center/cover; justify-content: center; align-items: center; gap: 30px; }
        .lobby-grid { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; }
        .game-card { width: 280px; height: 380px; background: rgba(0,0,0,0.85); border: 2px solid #333; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .game-card:hover { border-color: var(--gold); transform: translateY(-10px); box-shadow: 0 0 30px rgba(255, 215, 0, 0.2); }
        .game-card::before { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to bottom, transparent, black); z-index: 1; }
        .gc-content { position: relative; z-index: 2; text-align: center; }
        .gc-title { font-size: 32px; color: var(--gold); font-weight: 800; margin-bottom: 20px; }
        .gc-icon { font-size: 60px; margin-bottom: 20px; }

        /* --- COLOR GAME (REBUILT) --- */
        #view-colorgame { background: url('background.jpg') center/cover; }
        .cg-layout { display: grid; grid-template-rows: 60px 1fr auto; height: 100vh; width: 100%; box-sizing: border-box; padding: 10px; gap: 10px; }
        
        .cg-top-hud { background: rgba(0,0,0,0.7); border-radius: 50px; display: flex; justify-content: space-around; align-items: center; padding: 0 20px; backdrop-filter: blur(5px); border: 1px solid #333; margin: 0 auto; min-width: 400px; }
        .cg-hud-item { text-align: center; }
        .cg-hud-lbl { font-size: 10px; color: #888; letter-spacing: 1px; font-weight: bold; }
        .cg-hud-val { font-size: 24px; font-weight: bold; font-family: 'Oswald'; }

        .cg-stage { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .cg-dice-container { display: flex; gap: 20px; margin-bottom: 20px; perspective: 1000px; }
        .die { width: 100px; height: 100px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 40px; border: 4px solid rgba(255,255,255,0.1); background: #222; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: transform 0.2s; }
        .die.red { background: #d32f2f; box-shadow: 0 0 20px #d32f2f; } 
        .die.green { background: #388e3c; box-shadow: 0 0 20px #388e3c; } 
        .die.blue { background: #1976d2; box-shadow: 0 0 20px #1976d2; }
        .die.yellow { background: #fbc02d; color:black; box-shadow: 0 0 20px #fbc02d; } 
        .die.pink { background: #e91e63; box-shadow: 0 0 20px #e91e63; } 
        .die.white { background: #eee; color:black; box-shadow: 0 0 20px #eee; }

        .cg-betting-area { background: rgba(0,0,0,0.8); padding: 20px; border-radius: 20px; border: 1px solid #333; width: 100%; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .cg-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .cg-btn { height: 90px; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; padding: 8px; box-sizing: border-box; transition: 0.1s; border: 2px solid transparent; opacity: 0.8; }
        .cg-btn:hover { opacity: 1; transform: scale(1.05); z-index: 10; }
        .cg-btn:active { transform: scale(0.95); }
        .cg-amt { font-size: 14px; font-weight: bold; background: rgba(0,0,0,0.5); border-radius: 4px; padding: 2px 5px; align-self: flex-end; }
        
        /* --- ROULETTE (FIXED) --- */
        #view-roulette { background-color: #05140a; background-image: radial-gradient(circle at 50% 50%, #012b13 0%, #000000 100%); }
        .r-main-area { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .r-table-wrapper { position: relative; background-color: #01431E; padding: 15px; border-radius: 20px; border: 10px solid #002b12; box-shadow: 0 0 0 5px var(--gold), 0 20px 50px black; }
        
        /* Grid Adjustments */
        .r-grid { display: grid; grid-template-columns: 50px repeat(12, 42px) 34px; grid-template-rows: repeat(3, 42px) 42px 42px; gap: 2px; border: 2px solid var(--gold); padding: 5px; border-radius: 8px; background: rgba(0,0,0,0.2); }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; cursor: pointer; border: 2px solid var(--gold); color:white; }
        .red-cell { background-color: #d32f2f; } .black-cell { background-color: #222; }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; border-radius: 6px 0 0 6px; }

        /* Chips */
        .chips-bar { display: flex; gap: 10px; background: rgba(0,0,0,0.5); padding: 8px 20px; border-radius: 50px; margin: 0 auto; width: fit-content; border: 1px solid rgba(255,255,255,0.1); }
        .chip { width: 40px; height: 40px; border-radius: 50%; position: relative; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .chip.active { transform: scale(1.2) translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.7); z-index: 10; }
        .chip::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: repeating-conic-gradient(var(--c1) 0deg 15deg, var(--c2) 15deg 30deg, var(--c1) 30deg 45deg, var(--c3) 45deg 60deg); }
        .chip::after { content: ''; position: absolute; inset: 5px; border-radius: 50%; background: var(--c1); border: 1px solid rgba(0,0,0,0.3); }
        .chip-label { position: relative; z-index: 2; font-size: 10px; font-weight: 900; color: #333; background: #fff; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; border: 1px solid #aaa; }
        
        /* Chip Colors */
        .chip-50 { --c1: #ddd; --c2: #fff; --c3: #bbb; }
        .chip-200 { --c1: #800; --c2: #a00; --c3: #500; }
        .chip-1k { --c1: #060; --c2: #080; --c3: #040; }
        .chip-10k { --c1: #008; --c2: #00a; --c3: #004; }
        .chip-100k { --c1: #111; --c2: #333; --c3: #000; }

        /* --- WINNING ANIMATION FIX --- */
        #winner-stage { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 6000; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; opacity:0; transition:opacity 0.3s; backdrop-filter: blur(5px); }
        #winner-stage.active { display:flex; opacity:1; }
        
        .flying-cell { position: absolute; min-width: 60px; padding: 0 10px; height: 60px; background: #222; border: 2px solid var(--gold); color: white; font-weight: bold; font-family: 'Oswald'; display: flex; justify-content: center; align-items: center; border-radius: 8px; box-shadow: 0 0 20px var(--gold); z-index: 6001; transition: all 1s ease-in-out; font-size:24px; }
        .flying-cell.red { background: #d32f2f; } .flying-cell.black { background: #111; }
        .win-label { position:absolute; top:-40px; color:var(--cyan); font-weight:900; font-size:20px; text-shadow:0 2px 4px black; opacity:0; animation: fadeUp 0.5s forwards 1s; white-space: nowrap; }
        @keyframes fadeUp { to { top:-50px; opacity:1; } }

        /* Icon Buttons */
        .icon-controls { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 15px; z-index: 5000; }
        .icon-btn { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #333, #111); border: 1px solid #555; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .icon-btn:hover { transform: translateY(-5px); border-color: var(--gold); }
        .icon-btn i { font-size: 20px; color: #ccc; }

        /* Overlay */
        #wheel-overlay { position: fixed; inset: 0; z-index: 5000; display: none; align-items: center; justify-content: center; pointer-events: none; }
        #wheel-overlay.show { display: flex; pointer-events: auto; }
        .wheelPanel { filter: drop-shadow(0 20px 50px rgba(0,0,0,0.9)); transform: scale(0.8); }

    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:var(--gold); margin-bottom:20px; font-size:30px;">GRAND CASINO</h1>
            <input id="user" class="auth-input" placeholder="USERNAME">
            <input id="pass" class="auth-input" type="password" placeholder="PASSWORD">
            <button onclick="login()" class="auth-btn">ENTER CASINO</button>
            <button onclick="register()" class="auth-btn" style="background:transparent; border:1px solid #555; color:#aaa; margin-top:5px;">REGISTER</button>
            <div id="loginErr" style="color:red; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div class="player-list-panel" id="playerPanel">
        <div class="pl-header">
            <span>ACTIVE PLAYERS</span>
            <span id="plCount">0</span>
        </div>
        <div class="pl-content" id="plList">
            </div>
    </div>

    <div class="voice-controls" id="voiceControls" style="display:none;">
        <div class="vc-btn" id="btn-ptt" onclick="setVoiceMode('ptt')"><i class="fas fa-microphone-slash"></i> PUSH TO TALK</div>
        <div class="vc-btn" id="btn-auto" onclick="setVoiceMode('auto')"><i class="fas fa-headset"></i> AUTO VOICE</div>
    </div>

    <div class="chat-panel panel-position" id="chatPanel">
        <div class="chat-header">
            <span>LIVE CHAT</span>
            <span onclick="toggleChat()" style="cursor:pointer; font-size:16px;">&times;</span>
        </div>
        <div class="chat-content" id="chatList"></div>
        <div class="chat-input-area">
            <input id="chatInput" class="chat-input" placeholder="Type message...">
            <button onclick="sendChat()" style="background:var(--gold); border:none; padding:0 15px; margin-left:5px; font-weight:bold; cursor:pointer;">></button>
        </div>
    </div>

    <button class="global-back" id="backBtn" onclick="goToLobby()">‚Üê LOBBY</button>

    <div id="view-lobby" class="view-section active">
        <h1 style="font-size:80px; color:var(--gold); text-shadow:0 0 30px rgba(0,0,0,0.8); margin-bottom:10px;">GRAND CASINO</h1>
        <div style="font-size:20px; margin-bottom:40px;">
            <i class="fas fa-user"></i> <span id="lobbyUser" style="color:var(--gold); font-weight:bold;">Guest</span> &nbsp;|&nbsp; 
            <i class="fas fa-wallet"></i> <span id="lobbyBal" style="color:var(--cyan); font-weight:bold;">0</span>
        </div>
        <div class="lobby-grid">
            <div class="game-card" onclick="enterGame('colorgame')">
                <div class="gc-content">
                    <div class="gc-icon">üé®</div>
                    <div class="gc-title">COLOR GAME</div>
                    <div class="gc-count" id="count-colorgame" style="color:#888;">0 Players</div>
                </div>
            </div>
            <div class="game-card" onclick="enterGame('roulette')">
                <div class="gc-content">
                    <div class="gc-icon">üé°</div>
                    <div class="gc-title">ROULETTE</div>
                    <div class="gc-count" id="count-roulette" style="color:#888;">0 Players</div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-colorgame" class="view-section">
        <div class="cg-layout">
            <div class="cg-top-hud">
                <div class="cg-hud-item"><div class="cg-hud-lbl">BALANCE</div><div class="cg-hud-val" id="cg-balance" style="color:var(--cyan)">0</div></div>
                <div class="cg-hud-item"><div class="cg-hud-lbl">TIMER</div><div class="cg-hud-val" id="cg-timer" style="color:var(--gold)">20</div></div>
                <div class="cg-hud-item"><div class="cg-hud-lbl">TOTAL BET</div><div class="cg-hud-val" id="cg-bet-total">0</div></div>
            </div>

            <div class="cg-stage">
                <div style="font-size:20px; letter-spacing:5px; color:#aaa; margin-bottom:10px;" id="cg-status">BETS OPEN</div>
                <div class="cg-dice-container">
                    <div id="d1" class="die">?</div>
                    <div id="d2" class="die">?</div>
                    <div id="d3" class="die">?</div>
                </div>
            </div>

            <div class="cg-betting-area">
                <div class="chips-bar">
                    <div class="chip chip-50 active" onclick="setCgChip(50, this)"><div class="chip-label">50</div></div>
                    <div class="chip chip-200" onclick="setCgChip(100, this)"><div class="chip-label">100</div></div>
                    <div class="chip chip-1k" onclick="setCgChip(1000, this)"><div class="chip-label">1K</div></div>
                    <div class="chip chip-10k" onclick="setCgChip(10000, this)"><div class="chip-label">10K</div></div>
                    <div class="chip chip-100k" onclick="setCgChip(100000, this)"><div class="chip-label">100K</div></div>
                </div>
                <div class="cg-grid">
                    <div class="cg-btn" style="background: #d32f2f;" onclick="placeCgBet('RED')"><b>RED</b><span class="cg-amt" id="cg-bet-RED">0</span></div>
                    <div class="cg-btn" style="background: #388e3c;" onclick="placeCgBet('GREEN')"><b>GREEN</b><span class="cg-amt" id="cg-bet-GREEN">0</span></div>
                    <div class="cg-btn" style="background: #1976d2;" onclick="placeCgBet('BLUE')"><b>BLUE</b><span class="cg-amt" id="cg-bet-BLUE">0</span></div>
                    <div class="cg-btn" style="background: #fbc02d; color:black;" onclick="placeCgBet('YELLOW')"><b>YEL</b><span class="cg-amt" id="cg-bet-YELLOW">0</span></div>
                    <div class="cg-btn" style="background: #e91e63;" onclick="placeCgBet('PINK')"><b>PINK</b><span class="cg-amt" id="cg-bet-PINK">0</span></div>
                    <div class="cg-btn" style="background: #eee; color:black;" onclick="placeCgBet('WHITE')"><b>WHT</b><span class="cg-amt" id="cg-bet-WHITE">0</span></div>
                </div>
            </div>

            <div class="icon-controls">
                <div class="icon-btn" onclick="toggleChat()"><i class="fas fa-comment"></i></div>
            </div>
        </div>
    </div>

    <div id="view-roulette" class="view-section">
        <div id="wheel-overlay">
            <div class="wheelPanel">
                <div style="position:relative;">
                    <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid var(--gold); z-index: 10;"></div>
                    <canvas id="wheelCanvas" width="800" height="800" style="width:500px; height:500px; border-radius:50%;"></canvas>
                </div>
            </div>
        </div>
        
        <div id="winner-stage"></div>

        <div class="r-main-area">
            <div id="rWrapper" style="display:flex; flex-direction:column; align-items:center;">
                <div style="display:flex; gap:20px; margin-bottom:15px; width:730px; justify-content:space-between;">
                    <div class="cg-top-hud" style="width:100%; min-width:0;">
                        <div class="cg-hud-item"><div class="cg-hud-lbl">BALANCE</div><div class="cg-hud-val" id="r-balance" style="color:var(--cyan)">0</div></div>
                        <div class="cg-hud-item"><div class="cg-hud-lbl">TIMER</div><div class="cg-hud-val" id="r-timer" style="color:var(--gold)">--</div></div>
                        <div class="cg-hud-item"><div class="cg-hud-lbl">BET</div><div class="cg-hud-val" id="r-bet-display">0</div></div>
                    </div>
                </div>

                <div class="r-table-wrapper">
                    <div class="r-grid" id="grid">
                        <div id="rOverlay" style="position:absolute; inset:0; z-index:50; pointer-events:none;"></div>
                        <div id="ghostOverlay" style="position:absolute; inset:0; z-index:60;"></div>
                        
                        <div class="cell zone-0" id="cell-0">0</div>
                        <div class="cell" style="grid-column:14; grid-row:1; writing-mode:vertical-rl; font-size:10px;" id="btn-row1">2 to 1</div>
                        <div class="cell" style="grid-column:14; grid-row:2; writing-mode:vertical-rl; font-size:10px;" id="btn-row2">2 to 1</div>
                        <div class="cell" style="grid-column:14; grid-row:3; writing-mode:vertical-rl; font-size:10px;" id="btn-row3">2 to 1</div>
                        <div class="cell" style="grid-row:4; grid-column:2/6; font-size:10px;" id="btn-doz1">1st 12</div>
                        <div class="cell" style="grid-row:4; grid-column:6/10; font-size:10px;" id="btn-doz2">2nd 12</div>
                        <div class="cell" style="grid-row:4; grid-column:10/14; font-size:10px;" id="btn-doz3">3rd 12</div>
                        <div class="cell" style="grid-row:5; grid-column:2/4; font-size:10px;" id="btn-low">1-18</div>
                        <div class="cell" style="grid-row:5; grid-column:4/6; font-size:10px;" id="btn-even">EVEN</div>
                        <div class="cell" style="grid-row:5; grid-column:6/8;" id="btn-red"><div style="width:15px; height:15px; background:#d32f2f; transform:rotate(45deg);"></div></div>
                        <div class="cell" style="grid-row:5; grid-column:8/10;" id="btn-black"><div style="width:15px; height:15px; background:#111; transform:rotate(45deg);"></div></div>
                        <div class="cell" style="grid-row:5; grid-column:10/12; font-size:10px;" id="btn-odd">ODD</div>
                        <div class="cell" style="grid-row:5; grid-column:12/14; font-size:10px;" id="btn-high">19-36</div>
                    </div>

                    <div class="chips-bar" style="margin-top:10px;">
                        <div class="chip chip-50 active" onclick="setRChip(50, this)"><div class="chip-label">50</div></div>
                        <div class="chip chip-200" onclick="setRChip(200, this)"><div class="chip-label">200</div></div>
                        <div class="chip chip-1k" onclick="setRChip(1000, this)"><div class="chip-label">1K</div></div>
                        <div class="chip chip-10k" onclick="setRChip(10000, this)"><div class="chip-label">10K</div></div>
                        <div class="chip chip-100k" onclick="setRChip(100000, this)"><div class="chip-label">100K</div></div>
                    </div>

                    <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
                        <button onclick="sendClear()" style="background:#333; color:white; border:1px solid #555; padding:5px 15px; cursor:pointer; font-weight:bold;">CLEAR</button>
                    </div>
                </div>
            </div>
            
            <div class="icon-controls">
                <div class="icon-btn" onclick="toggleChat()"><i class="fas fa-comment"></i></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- SECURITY ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; // F12
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; // Ctrl+Shift+I
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; // Ctrl+U
        }

        const socket = io();
        let myUser = "Guest";
        let myBal = 0;
        let currentRoom = 'lobby';
        
        // --- AUTH ---
        function login() { socket.emit('login', { username: document.getElementById('user').value, password: document.getElementById('pass').value }); }
        function register() { socket.emit('register', { username: document.getElementById('user').value, password: document.getElementById('pass').value }); }
        
        socket.on('login_success', (data) => {
            document.getElementById('authOverlay').style.display = 'none';
            myUser = data.username; myBal = data.balance;
            updateDisplay();
        });
        socket.on('login_error', (m) => document.getElementById('loginErr').innerText = m);
        socket.on('update_balance', (b) => { myBal = b; updateDisplay(); });
        
        function updateDisplay() {
            ['lobbyBal', 'cg-balance', 'r-balance'].forEach(id => document.getElementById(id).innerText = myBal);
            document.getElementById('lobbyUser').innerText = myUser;
        }

        // --- NAVIGATION & INIT ---
        function enterGame(game) {
            currentRoom = game;
            socket.emit('switch_room', game);
            
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+game).classList.add('active');
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('voiceControls').style.display = 'flex'; // Show voice
            document.getElementById('playerPanel').classList.add('active'); // Show list
            
            if(game === 'roulette') initRoulette();
            
            initAudio(); // Start Audio Context
        }

        function goToLobby() {
            currentRoom = 'lobby';
            socket.emit('switch_room', 'lobby');
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-lobby').classList.add('active');
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('voiceControls').style.display = 'none';
            document.getElementById('playerPanel').classList.remove('active');
            stopAudio();
        }

        socket.on('lobby_counts', (c) => {
            document.getElementById('count-colorgame').innerText = (c.colorgame||0) + " Players";
            document.getElementById('count-roulette').innerText = (c.roulette||0) + " Players";
        });

        // --- PLAYER LIST & VOICE UI ---
        socket.on('room_users_update', (users) => {
            const list = document.getElementById('plList');
            document.getElementById('plCount').innerText = users.length;
            list.innerHTML = '';
            users.forEach(u => {
                let div = document.createElement('div');
                div.className = 'pl-user';
                div.id = `pl-u-${u.id}`;
                div.innerHTML = `<div class="pl-mic"><i class="fas fa-microphone"></i></div><div class="pl-name">${u.username} ${u.username===myUser?'(You)':''}</div>`;
                list.appendChild(div);
            });
        });

        socket.on('player_voice_update', (data) => {
            let el = document.getElementById(`pl-u-${data.id}`);
            if(el) {
                if(data.talking) el.classList.add('talking');
                else el.classList.remove('talking');
            }
        });

        // --- VOICE CHAT LOGIC ---
        let audioCtx, mediaStream, scriptProcessor;
        let voiceMode = null; // 'ptt' or 'auto'
        let isSpaceDown = false;

        function setVoiceMode(mode) {
            voiceMode = mode;
            document.querySelectorAll('.vc-btn').forEach(b => b.classList.remove('active'));
            if(mode) document.getElementById('btn-'+mode).classList.add('active');
            
            // Re-init audio if needed
            if(mediaStream) return;
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaStream = stream;
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);
                
                source.connect(scriptProcessor);
                scriptProcessor.connect(audioCtx.destination);
                
                scriptProcessor.onaudioprocess = (e) => {
                    if(!voiceMode) return;
                    
                    const inputData = e.inputBuffer.getChannelData(0);
                    let sum = 0; 
                    for(let i=0; i<inputData.length; i++) sum += inputData[i] * inputData[i];
                    let volume = Math.sqrt(sum / inputData.length);
                    
                    let shouldTransmit = false;
                    
                    if(voiceMode === 'ptt' && isSpaceDown) shouldTransmit = true;
                    if(voiceMode === 'auto' && volume > 0.02) shouldTransmit = true; // Simple VAD
                    
                    if(shouldTransmit) {
                        // In a real pro app, we'd downsample/encode here.
                        // For this demo, we emit raw float data converted to buffer
                        // But Socket.io handles Blobs better.
                        // SIMPLIFICATION: Signal "talking" state and use relay
                        
                        // Send visual state
                        socket.emit('voice_status', true);
                        
                        // Convert to Int16 for efficiency (Simple PCM)
                        const buffer = new ArrayBuffer(inputData.length * 2);
                        const view = new DataView(buffer);
                        for (let i = 0; i < inputData.length; i++) {
                            let s = Math.max(-1, Math.min(1, inputData[i]));
                            view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                        }
                        socket.emit('voice_data', buffer); // Send audio chunk
                        
                        document.getElementById(voiceMode === 'ptt' ? 'btn-ptt':'btn-auto').classList.add('talking');
                    } else {
                        socket.emit('voice_status', false);
                        document.querySelectorAll('.vc-btn').forEach(b => b.classList.remove('talking'));
                    }
                };
            }).catch(e => alert("Mic Access Denied"));
        }

        function initAudio() {
            // Listeners for PTT
            window.addEventListener('keydown', (e) => { if(e.code === 'Space' && voiceMode === 'ptt') isSpaceDown = true; });
            window.addEventListener('keyup', (e) => { if(e.code === 'Space' && voiceMode === 'ptt') isSpaceDown = false; });
        }
        
        function stopAudio() {
            if(audioCtx) audioCtx.close();
            if(mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            mediaStream = null; voiceMode = null;
        }

        // RECEIVE VOICE
        socket.on('voice_receive', (data) => {
            // Play received PCM audio buffer
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const int16Array = new Int16Array(data.audio);
            const float32Array = new Float32Array(int16Array.length);
            for(let i=0; i<int16Array.length; i++) float32Array[i] = int16Array[i] / (int16Array[i] < 0 ? 0x8000 : 0x7FFF);
            
            const buffer = audioCtx.createBuffer(1, float32Array.length, audioCtx.sampleRate);
            buffer.getChannelData(0).set(float32Array);
            
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);
        });

        // --- GAME LOGIC (COLOR GAME) ---
        let cgChip = 50;
        function setCgChip(v, el) { cgChip = v; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
        function placeCgBet(c) {
            if(myBal < cgChip) { alert("Insufficient Funds"); return; }
            socket.emit('place_bet', { color: c, amount: cgChip });
            // Optimistic update
            let el = document.getElementById('cg-bet-'+c);
            el.innerText = parseInt(el.innerText) + cgChip;
            document.getElementById('cg-bet-total').innerText = parseInt(document.getElementById('cg-bet-total').innerText) + cgChip;
        }

        socket.on('timer_update', t => { if(currentRoom=='colorgame') { document.getElementById('cg-timer').innerText = t; document.getElementById('cg-status').innerText = "BETS OPEN"; } });
        socket.on('game_rolling', () => { 
            if(currentRoom=='colorgame') { 
                document.getElementById('cg-status').innerText = "ROLLING..."; 
                window.rollInt = setInterval(() => {
                    ['d1','d2','d3'].forEach(d => {
                        let c = ['red','green','blue','yellow','pink','white'][Math.floor(Math.random()*6)];
                        document.getElementById(d).className = `die ${c}`;
                    });
                }, 100);
            }
        });
        socket.on('game_result', (res) => {
            if(currentRoom=='colorgame') {
                clearInterval(window.rollInt);
                ['d1','d2','d3'].forEach((d, i) => document.getElementById(d).className = `die ${res[i].toLowerCase()}`);
                document.getElementById('cg-status').innerText = "RESULT";
            }
        });
        socket.on('game_reset', () => {
            if(currentRoom=='colorgame') {
                document.querySelectorAll('.cg-amt').forEach(e => e.innerText = '0');
                document.getElementById('cg-bet-total').innerText = '0';
            }
        });
        socket.on('win_notification', (d) => alert(`YOU WON: ${d.amount}`));

        // --- GAME LOGIC (ROULETTE) ---
        const REDS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        let rChip = 50; let currentBets = [];

        function initRoulette() {
            const grid = document.getElementById('grid');
            if(document.getElementById('cell-1')) return; // already init
            
            for(let i=1; i<=36; i++) {
                let d = document.createElement('div');
                d.className = `cell ${REDS.includes(i)?'red-cell':'black-cell'}`;
                d.innerText = i; d.id = `cell-${i}`;
                d.style.gridRow = (i%3===0)?1:(i%3===2?2:3);
                d.style.gridColumn = Math.floor((i-1)/3)+2;
                grid.appendChild(d);
            }
            initRouletteEvents();
            drawWheel(0);
        }

        function initRouletteEvents() {
            const overlay = document.getElementById('ghostOverlay');
            overlay.innerHTML = '';
            
            // Helper to make clickable zones (Simplified for demo)
            // In a pro app, we calculate exact rectangles for splits/corners.
            // For now, mapping straightforward clicks on elements:
            document.querySelectorAll('.cell').forEach(el => {
                let id = el.id;
                let nums = [];
                if(id.startsWith('cell-')) nums = [parseInt(id.split('-')[1])];
                else if(id === 'btn-red') nums = REDS;
                else if(id === 'btn-black') nums = Array.from({length:36},(_,i)=>i+1).filter(n=>!REDS.includes(n));
                else if(id === 'btn-even') nums = Array.from({length:36},(_,i)=>i+1).filter(n=>n%2===0);
                else if(id === 'btn-odd') nums = Array.from({length:36},(_,i)=>i+1).filter(n=>n%2!==0);
                // ... (Add other mappings like Dozens/Rows for completeness)
                
                el.onclick = function() {
                    if(nums.length === 0 && id.startsWith('cell-')) nums = [parseInt(id.split('-')[1])]; // Fail-safe
                    if(nums.length > 0) placeRouletteBet(nums, el);
                };
            });
        }
        
        function setRChip(v, el) { rChip = v; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
        
        function placeRouletteBet(nums, targetEl) {
            if(myBal < rChip) return;
            
            let rect = targetEl.getBoundingClientRect();
            let wrapperRect = document.getElementById('rOverlay').getBoundingClientRect();
            let x = rect.left + rect.width/2 - wrapperRect.left;
            let y = rect.top + rect.height/2 - wrapperRect.top;

            let mk = document.createElement('div');
            mk.className = 'chip chip-50 chip-board'; // Simplified class for visual
            mk.style.position = 'absolute'; mk.style.left = x+'px'; mk.style.top = y+'px'; mk.style.width='20px'; mk.style.height='20px'; mk.style.background='white'; mk.style.borderRadius='50%'; mk.style.pointerEvents='none';
            document.getElementById('rOverlay').appendChild(mk);

            currentBets.push({nums, amount:rChip, dom: mk});
            socket.emit('place_bet_roulette', { numbers: nums, amount: rChip });
            document.getElementById('r-bet-display').innerText = parseInt(document.getElementById('r-bet-display').innerText) + rChip;
        }

        function sendClear() {
            socket.emit('roulette_clear');
        }

        socket.on('bets_cleared', () => {
            document.getElementById('rOverlay').innerHTML = '';
            document.getElementById('r-bet-display').innerText = '0';
        });

        socket.on('roulette_timer', t => { if(currentRoom==='roulette') document.getElementById('r-timer').innerText = t; });
        socket.on('roulette_spin_start', (n) => { 
            if(currentRoom==='roulette') {
                document.getElementById('wheel-overlay').classList.add('show');
                spinWheel(n);
            }
        });
        
        socket.on('roulette_win', (d) => {
            setTimeout(() => { triggerWinAnim(d.number, d.amount); }, 1000);
        });

        socket.on('roulette_new_round', () => {
             document.getElementById('rOverlay').innerHTML = '';
             document.getElementById('r-bet-display').innerText = '0';
             // Visual reset
        });

        // --- WIN ANIMATION (WITH GAPS) ---
        function triggerWinAnim(winNum, amount) {
            const stage = document.getElementById('winner-stage');
            stage.classList.add('active');
            stage.innerHTML = '';
            
            // Create element
            let div = document.createElement('div');
            div.className = `flying-cell ${REDS.includes(winNum)?'red':'black'}`;
            div.innerText = winNum;
            div.style.left = '50%'; div.style.top = '50%'; div.style.transform = 'translate(-50%, -50%)';
            stage.appendChild(div);
            
            let lbl = document.createElement('div');
            lbl.className = 'win-label';
            lbl.innerText = `YOU WON ${amount}`;
            div.appendChild(lbl);

            setTimeout(() => { stage.classList.remove('active'); stage.innerHTML=''; }, 3000);
        }

        // --- WHEEL DRAWING (Standard Canvas) ---
        const cvs = document.getElementById('wheelCanvas'); const ctx = cvs.getContext('2d');
        const WHEEL = ["0","32","15","19","4","21","2","25","17","34","6","27","13","36","11","30","8","23","10","5","24","16","33","1","20","14","31","9","22","18","29","7","28","12","35","3","26"];
        function drawWheel(angle) {
            const CX=400, CY=400, R=380;
            ctx.clearRect(0,0,800,800);
            ctx.save(); ctx.translate(CX, CY); ctx.rotate(angle);
            const slice = (Math.PI*2)/37;
            WHEEL.forEach((n, i) => {
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0, R, i*slice, (i+1)*slice);
                ctx.fillStyle = n=="0"?'#060':(REDS.includes(parseInt(n))?'#b00':'#111');
                ctx.fill(); ctx.stroke();
                ctx.save(); ctx.rotate(i*slice + slice/2); ctx.fillStyle="white"; ctx.font="bold 30px Arial"; ctx.fillText(n, 250, 10); ctx.restore();
            });
            ctx.restore();
        }
        
        function spinWheel(target) {
            let idx = WHEEL.indexOf(target.toString());
            let slice = (Math.PI*2)/37;
            let dest = (Math.PI*2*5) - (idx*slice) - (slice/2); // 5 rotations
            let start = null;
            function anim(ts) {
                if(!start) start=ts; let p = (ts-start)/5000; // 5s spin
                if(p>1) p=1; 
                let ease = 1 - Math.pow(1-p, 3);
                drawWheel(dest*ease);
                if(p<1) requestAnimationFrame(anim);
                else setTimeout(() => { document.getElementById('wheel-overlay').classList.remove('show'); }, 2000);
            }
            requestAnimationFrame(anim);
        }
        
        // --- CHAT UI ---
        function toggleChat() {
             const p = document.getElementById('chatPanel');
             if(p.classList.contains('active')) p.classList.remove('active');
             else p.classList.add('active');
        }
        function sendChat() {
            let i = document.getElementById('chatInput');
            if(i.value) { socket.emit('chat_msg', { msg: i.value, room: currentRoom }); i.value=''; }
        }
        socket.on('chat_broadcast', d => {
            const b = document.getElementById('chatList');
            b.innerHTML += `<div style="margin-bottom:5px;"><b>${d.user}:</b> ${d.msg}</div>`;
            b.scrollTop = b.scrollHeight;
        });

    </script>
</body>
</html>
