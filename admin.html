<!DOCTYPE html>
<html>
<head>
    <title>ADMINISTRATOR PANEL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --panel-bg: rgba(20, 22, 28, 0.9);
            --border: rgba(255, 255, 255, 0.1);
            --gold: #FFD700;
            --cyan: #00E5FF;
            --green: #00C853;
            --red: #FF3D00;
            --text-main: #E6EDF3;
            --text-dim: #8B949E;
        }

        body { 
            font-family: 'Inter', sans-serif; margin: 0; color: var(--text-main); 
            background: url('background.jpg') no-repeat center center fixed; background-size: cover;
            height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; 
        }
        
        .no-scroll-ui::-webkit-scrollbar { display: none; }
        .no-scroll-ui { -ms-overflow-style: none; scrollbar-width: none; }

        .admin-wrapper {
            background: var(--panel-bg); backdrop-filter: blur(15px);
            border: 1px solid var(--border); border-radius: 12px;
            width: 96%; max-width: 1600px; height: 92vh; padding: 24px;
            display: flex; flex-direction: column; gap: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .view-section { display: none; height: 100%; flex-direction: column; gap: 20px; overflow: hidden; }
        .view-section.active { display: flex; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header-text { text-align: left; }
        h1 { font-family: 'Rajdhani', sans-serif; color: var(--gold); margin: 0; font-size: 28px; letter-spacing: 1px; text-transform: uppercase; }
        
        .top-grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 24px; flex-shrink: 0; }

        .panel { 
            background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 8px; 
            display: flex; flex-direction: column; overflow: hidden; flex: 1; min-height: 0;
        }
        .panel-header { 
            background: rgba(255,255,255,0.05); padding: 12px 20px; font-size: 12px; font-weight: 700; 
            color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }

        .music-panel { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 10px 20px; }
        .track-inputs { display: flex; gap: 10px; align-items: center; }
        .meta-input { background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: white; padding: 10px; font-family: 'Inter'; font-size: 13px; border-radius: 4px; outline: none; text-align: center; }
        
        .broadcast-panel { padding: 10px; display: flex; gap: 10px; align-items: center; justify-content: center; }
        
        .main-grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 24px; flex-grow: 1; overflow: hidden; }
        .col-right { display: flex; flex-direction: column; gap: 20px; overflow: hidden; height: 100%; min-width: 350px; }

        .db-header { 
            display: grid; grid-template-columns: 60px 1fr 1fr 1fr 180px; gap: 10px; 
            padding: 12px 20px; background: rgba(0,0,0,0.5); color: var(--gold); 
            font-weight: 600; font-size: 13px; border-bottom: 1px solid var(--border); 
            flex-shrink: 0; text-align: center;
        }
        .db-list { overflow-y: auto; flex-grow: 1; }
        .db-row { 
            display: grid; grid-template-columns: 60px 1fr 1fr 1fr 180px; gap: 10px; 
            padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            align-items: center; font-size: 14px; text-align: center;
        }
        .db-row > div { display: flex; justify-content: center; align-items: center; width: 100%; }
        .db-row:hover { background: rgba(255,255,255,0.05); }

        .btn-action { background: #333; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; transition: 0.2s; white-space: nowrap; }
        .btn-action:hover { background: #444; }
        
        .manage-credits { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 4px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.2s; }
        .btn-plus { background: rgba(0, 200, 83, 0.2); border-color: var(--green); color: var(--green); }
        .btn-minus { background: rgba(255, 61, 0, 0.2); border-color: var(--red); color: var(--red); }
        .amount-input { background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: white; width: 60px; height: 32px; padding: 0; text-align: center; border-radius: 4px; outline: none; box-sizing: border-box; }

        .status-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; display: inline-block; }
        .status-dot.online { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .pass-mask { cursor: pointer; letter-spacing: 2px; color: var(--text-dim); font-size: 12px; user-select: none; }

        .chat-container { display: flex; flex-direction: column; flex: 1; min-height: 0; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; }
        .chat-list { flex-grow: 1; overflow-y: auto; padding: 15px; font-size: 13px; display: flex; flex-direction: column; gap: 8px; height: 0; }
        .chat-input-area { display: flex; border-top: 1px solid var(--border); padding: 10px; background: rgba(0,0,0,0.2); flex-shrink: 0; }
        .chat-input-area input { flex-grow: 1; background: transparent; border: none; color: white; outline: none; padding: 0 10px; }

        .log-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .log-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; height: 300px; display: flex; flex-direction: column; padding: 16px; }
        .log-lines { overflow-y: auto; font-family: monospace; font-size: 12px; color: var(--text-dim); flex-grow: 1; margin-top: 10px; line-height: 1.5; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #lockScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; background-attachment: scroll; }
            .admin-wrapper { width: 100%; height: auto; min-height: 100vh; padding: 10px; border-radius: 0; border: none; overflow-y: auto; display: block; }
            .top-bar { flex-direction: column; gap: 15px; margin-bottom: 20px; align-items: stretch; }
            .top-grid { grid-template-columns: 1fr; display: flex; flex-direction: column; }
            .music-panel { flex-direction: column; align-items: center; }
            .track-inputs { flex-direction: column; width: 100%; }
            .main-grid { display: flex; flex-direction: column; overflow: visible; }
            .col-left, .col-right { height: auto; overflow: visible; min-width: 0; }
            .panel { overflow: visible; }
            .db-list { overflow-x: auto; max-height: 400px; } 
            .db-header, .db-row { min-width: 700px; } 
            .chat-container { height: 400px; margin-bottom: 20px; }
            .log-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <div id="lockScreen">
            <h1 style="font-size:40px; margin-bottom:20px;">SYSTEM LOCKED</h1>
            <input type="password" id="adminPass" class="meta-input" placeholder="ACCESS CODE" style="font-size:24px; text-align:center; width: 300px;">
            <button onclick="checkPass()" class="btn-action" style="margin-top:20px; font-size:18px; padding:12px 40px; background:var(--gold); color:black;">ENTER</button>
        </div>

        <div id="view-dash" class="view-section active">
            <div class="top-bar">
                <div class="header-text">
                    <h1>ADMINISTRATOR PANEL</h1>
                    <div style="font-size:12px; color:var(--text-dim); margin-top:5px;">SYSTEM OPERATIONAL</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-action" onclick="switchView('logs')">LOGS</button>
                </div>
            </div>

            <div class="top-grid">
                <div class="panel music-panel">
                    <div style="display:flex; align-items:center; gap:20px; justify-content: center; width: 100%;">
                        <i class="fas fa-music" style="color:var(--gold); font-size: 20px;"></i>
                        <div class="track-inputs">
                            <input type="text" id="metaTitle" class="meta-input" placeholder="Song Title" style="width: 150px;">
                            <input type="text" id="metaArtist" class="meta-input" placeholder="Artist Name" style="width: 150px;">
                            <input type="text" id="trackUrl" class="meta-input" style="width: 200px;" placeholder="MP3 Link">
                            <button onclick="updateMusic()" class="btn-action">UPDATE</button>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px; border-left:1px solid var(--border); padding-left:20px;">
                            <button onclick="toggleMusic(true)" style="background:none; border:none; color:var(--gold); cursor:pointer; font-size:18px;"><i class="fas fa-play"></i></button>
                            <button onclick="toggleMusic(false)" style="background:none; border:none; color:var(--gold); cursor:pointer; font-size:18px;"><i class="fas fa-pause"></i></button>
                            <input type="range" min="0.05" max="0.5" step="0.05" value="0.25" onchange="document.getElementById('adminAudio').volume=this.value" style="width:70px;">
                        </div>
                    </div>
                    <audio id="adminAudio"></audio>
                </div>

                <div class="panel broadcast-panel">
                    <input type="text" id="announceInput" class="meta-input" placeholder="Broadcast Alert..." style="flex-grow:1;">
                    <button onclick="sendAnnounce()" class="btn-action" style="background:var(--red);">BROADCAST</button>
                </div>
            </div>

            <div class="main-grid">
                <div class="panel">
                    <div class="panel-header">
                        PLAYER DATABASE
                        <button onclick="addAllCredits()" class="btn-action" style="background:purple;">GIFT ALL</button>
                    </div>
                    <div style="overflow-x:auto; flex-grow:1; display:flex; flex-direction:column;">
                        <div class="db-header">
                            <div></div> <div>USERNAME</div> <div>PASSWORD</div> <div>BALANCE</div> <div>MANAGE CREDITS</div>
                        </div>
                        <div id="dbList" class="db-list no-scroll-ui"></div>
                    </div>
                </div>

                <div class="col-right"> 
                    <div class="chat-container" style="border-top: 2px solid var(--cyan);">
                        <div class="panel-header" style="color:var(--cyan);">SUPPORT INBOX</div>
                        <div id="supportInbox" class="chat-list no-scroll-ui"></div>
                        <div class="chat-input-area">
                            <input type="text" id="replyUser" placeholder="User" style="width:80px; border-right:1px solid var(--border);">
                            <input type="text" id="replyMsg" placeholder="Reply...">
                            <button onclick="sendReply()" class="btn-action" style="background:var(--cyan); color:black;">></button>
                        </div>
                    </div>
                    <div class="chat-container" style="border-top: 2px solid var(--gold);">
                        <div class="panel-header" style="color:var(--gold);">PUBLIC CHAT</div>
                        <div id="publicChatMonitor" class="chat-list no-scroll-ui"></div>
                        <div class="chat-input-area">
                            <input type="text" id="adminChatInput" placeholder="Send as Admin...">
                            <button onclick="sendAdminChat()" class="btn-action" style="background:var(--gold); color:black;">></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-logs" class="view-section">
            <div class="top-bar">
                <h1>TRANSACTION LOGS</h1>
                <div style="display:flex; gap:10px;">
                    <button onclick="refreshDB()" class="btn-action">REFRESH</button>
                    <button onclick="switchView('dash')" class="btn-action">BACK</button>
                </div>
            </div>
            <div id="logsContainer" class="log-grid no-scroll-ui"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const ADMIN_PASSWORD = "Kenm4"; 
        const audio = document.getElementById('adminAudio');
        audio.volume = 0.25;

        function checkPass() { if (document.getElementById('adminPass').value === ADMIN_PASSWORD) { document.getElementById('lockScreen').style.display = 'none'; refreshDB(); setInterval(refreshDB, 3000); } else { alert("ACCESS DENIED"); } }
        function switchView(view) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById(`view-${view}`).classList.add('active'); }
        function sendAnnounce() { const msg = document.getElementById('announceInput').value; if(msg) { socket.emit('admin_announce', msg); document.getElementById('announceInput').value = ''; } }
        function addAllCredits() { let amt = prompt("Amount to give ALL ACTIVE PLAYERS?"); if(amt) socket.emit('admin_add_all', amt); }

        function updateMusic() {
            const url = document.getElementById('trackUrl').value;
            const title = document.getElementById('metaTitle').value;
            const artist = document.getElementById('metaArtist').value;
            socket.emit('admin_update_metadata', { title: title, artist: artist });
            if(url) socket.emit('admin_change_track', url);
        }
        function toggleMusic(play) { if(play) { audio.play(); socket.emit('admin_music_action', { action: 'play', seek: audio.currentTime }); } else { audio.pause(); socket.emit('admin_music_action', { action: 'pause', seek: audio.currentTime }); } }
        socket.on('music_sync', (data) => { if(data.url && audio.src !== data.url) audio.src = data.url; if(data.playing && audio.paused) audio.play().catch(()=>{}); if(Math.abs(audio.currentTime - data.seek) > 2) audio.currentTime = data.seek; });

        function refreshDB() { socket.emit('admin_req_data'); }
        socket.on('admin_data_resp', (data) => { renderDB(data); renderLogs(data); renderInbox(data.support); });

        function renderDB(data) {
            const container = document.getElementById('dbList'); 
            const savedScroll = container.scrollTop;
            const users = Object.entries(data.users).sort((a, b) => { const aActive = Object.values(data.active).includes(a[0]); const bActive = Object.values(data.active).includes(b[0]); return bActive - aActive; });
            
            let html = "";
            users.forEach(([username, uData]) => {
                const isOnline = Object.values(data.active).includes(username);
                html += `<div class="db-row"><div><div class="status-dot ${isOnline?'online':''}"></div></div><div style="font-weight:600; color:#fff;">${username}</div><span class="pass-mask" onclick="this.innerText='${uData.password}'">••••••</span><div style="color:var(--gold); font-weight:bold; font-size:16px;">${uData.balance}</div><div class="manage-credits"><input type="number" id="amt-${username}" class="amount-input" placeholder="0"><button class="btn-icon btn-plus" onclick="modCredit('${username}', 'add')"><i class="fas fa-plus"></i></button><button class="btn-icon btn-minus" onclick="modCredit('${username}', 'sub')"><i class="fas fa-minus"></i></button></div></div>`;
            });
            container.innerHTML = html;
            container.scrollTop = savedScroll;
        }

        function modCredit(u, type) { const v = document.getElementById(`amt-${u}`).value; if(!v) return; if(type === 'add') { if(confirm(`ADD ${v} to ${u}?`)) socket.emit('admin_add_credits', { username: u, amount: v }); } else { if(confirm(`DEDUCT ${v} from ${u}?`)) socket.emit('admin_deduct_credits', { username: u, amount: v }); } }

        function renderLogs(data) {
            const container = document.getElementById('logsContainer');
            const savedScroll = container.scrollTop;
            let html = ''; Object.entries(data.users).forEach(([username, uData]) => {
                let logsHTML = ''; if(uData.history) uData.history.forEach(log => { let c = '#888'; if(log.includes('WIN')) c = 'var(--green)'; if(log.includes('LOST')) c = 'var(--red)'; if(log.includes('ADMIN')) c = 'var(--gold)'; logsHTML += `<div style="color:${c}; border-bottom:1px solid #222; padding:3px 0;">${log}</div>`; });
                html += `<div class="log-card"><div style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px; font-weight:bold; font-size:16px;">${username}</div><div class="log-lines no-scroll-ui">${logsHTML}</div></div>`;
            });
            container.innerHTML = html; 
            container.scrollTop = savedScroll;
        }

        function renderInbox(tickets) {
            const box = document.getElementById('supportInbox');
            const savedScroll = box.scrollTop;
            box.innerHTML = ''; 
            tickets.forEach(t => { 
                // FORMATTED AS "To [player]: [msg]"
                let content = "";
                if(t.user.startsWith("To ")) {
                    content = `<b style="color:var(--cyan)">${t.user}:</b> <span style="color:#ccc;">${t.msg}</span>`;
                } else {
                    content = `<span style="color:var(--cyan); cursor:pointer; font-weight:bold;" onclick="document.getElementById('replyUser').value='${t.user}'">${t.user}</span>: <span style="color:#ccc;">${t.msg}</span>`;
                }
                box.innerHTML += `<div style="border-bottom:1px solid #222; padding:8px 0;">${content}</div>`; 
            });
            box.scrollTop = savedScroll;
        }

        socket.on('chat_broadcast', (data) => {
            if(data.type === 'support_log' || data.type === 'support_log_echo') { refreshDB(); }
            if(data.type === 'public' || data.type === 'public_admin') { const box = document.getElementById('publicChatMonitor'); const col = data.type === 'public_admin' ? 'var(--red)' : 'var(--gold)'; const name = data.type === 'public_admin' ? 'ADMIN' : data.user; box.innerHTML += `<div style="padding:4px 0; border-bottom:1px solid #222;"><b style="color:${col};">${name}:</b> <span style="color:#ccc;">${data.msg}</span></div>`; box.scrollTop = box.scrollHeight; }
        });

        function sendReply() { const u = document.getElementById('replyUser').value; const m = document.getElementById('replyMsg').value; if(u && m) { socket.emit('admin_reply_support', { targetUser: u, msg: m }); document.getElementById('replyMsg').value = ''; } }
        function sendAdminChat() { const m = document.getElementById('adminChatInput').value; if(m) { socket.emit('admin_chat_public', m); document.getElementById('adminChatInput').value = ''; } }
    </script>
</body>
</html>